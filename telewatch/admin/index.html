<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Telewatch Admin | FrenzyNets</title>
  <link rel="icon" type="image/svg+xml" href="/assets/frenzynet-logo.svg" />
  <style>
    :root {
      --bg: #f3f6fb;
      --panel: #ffffff;
      --panel-soft: #f8fbff;
      --line: #d8e2ef;
      --text: #172333;
      --muted: #617289;
      --accent: #ff6a2a;
      --accent2: #e24f15;
      --danger: #c23138;
      --shadow: 0 12px 30px rgba(10, 20, 35, 0.07);
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: radial-gradient(circle at 12% 8%, #ffffff, var(--bg)); color: var(--text); font-family: "Segoe UI", Inter, Arial, sans-serif; }
    .wrap { width: min(1160px, calc(100% - 20px)); margin: 18px auto; display: grid; gap: 12px; }
    .card { background: var(--panel); border: 1px solid var(--line); border-radius: 14px; padding: 14px; box-shadow: var(--shadow); }
    .tool-section {
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(180deg, var(--panel-soft), #fff);
      padding: 12px;
    }
    details.tool-section summary {
      cursor: pointer;
      font-weight: 800;
      color: #2b3f57;
      list-style: none;
    }
    details.tool-section summary::-webkit-details-marker { display: none; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 150px; }
    label { display: block; margin: 0 0 4px; font-size: 11px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: .06em; }
    input, select, button { width: 100%; border-radius: 9px; border: 1px solid #d1dae5; padding: 10px; font: inherit; }
    button { background: linear-gradient(180deg, var(--accent), var(--accent2)); color: #fff; border: 0; font-weight: 800; cursor: pointer; }
    button.secondary { background: #fff; border: 1px solid #d1dae5; color: #2f3f52; }
    button.danger { background: linear-gradient(180deg, #e5484d, var(--danger)); }
    .muted { color: var(--muted); font-size: 13px; }
    .status { font-weight: 700; }
    .hidden { display: none; }
    a { color: #2263d1; }
    .stream-frame {
      width: 100%;
      min-height: 560px;
      border: 1px solid #ced9e8;
      border-radius: 12px;
      background: #0d1422;
    }
    .pill {
      display: inline-block;
      border: 1px solid #cfdbeb;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 12px;
      color: #3e556f;
      background: #f6f9ff;
      font-weight: 700;
    }
    .tv-console {
      background: linear-gradient(160deg, #1a2841, #203452);
      border-color: #3b5478;
      color: #eaf2ff;
    }
    .tv-console h3 { color: #eaf2ff; }
    .tv-console .muted { color: #a8bbd7; }
    .tv-console .pill {
      border-color: #5a7398;
      background: #2a3f62;
      color: #dcebff;
    }
    .tv-console input,
    .tv-console select {
      background: #1f3252;
      border-color: #4d678f;
      color: #ecf3ff;
    }
    .tv-console label { color: #9fb5d6; }
    .tv-console button.secondary {
      background: #2a3f62;
      border-color: #5c77a0;
      color: #dcebff;
    }
    .tv-console .stream-frame {
      border-color: #33547f;
      background: #070e1b;
      min-height: 640px;
    }
    .tv-console button.big {
      min-height: 46px;
      font-size: 15px;
      letter-spacing: .02em;
    }
    .easy-bar {
      display: grid;
      gap: 8px;
      margin-bottom: 10px;
      border: 1px solid #506d96;
      border-radius: 10px;
      padding: 10px;
      background: linear-gradient(160deg, #233a5d, #2a466f);
    }
    .easy-bar .muted { color: #c2d5f0; }
    .guide-panel {
      border: 1px solid #5d77a0;
      border-radius: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.06);
      margin-bottom: 10px;
      display: grid;
      gap: 6px;
    }
    .guide-title {
      font-size: 13px;
      font-weight: 800;
      color: #eaf2ff;
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    .guide-step {
      font-size: 13px;
      border: 1px solid #5f7ca8;
      border-radius: 999px;
      padding: 6px 10px;
      color: #d8e7ff;
      background: rgba(255, 255, 255, 0.06);
      width: fit-content;
    }
    .guide-step.done {
      border-color: #7fd4a8;
      background: rgba(53, 122, 92, 0.45);
      color: #ecfff6;
    }
    @media (max-width: 760px) {
      .wrap { width: calc(100% - 14px); margin: 10px auto; }
      .row > * { min-width: 100%; flex-basis: 100%; }
      .stream-frame { min-height: 420px; }
      button { padding: 11px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 8px">Telewatch Admin Console</h1>
      <div class="muted">Dedicated admin route. Sign in first, then manage admins and rooms.</div>
      <div id="status" class="status" style="margin-top:8px">Not signed in</div>
      <div class="muted"><a href="/telewatch/">Back to Telewatch</a></div>
    </div>

    <div class="card" id="loginCard">
      <h2 style="margin:0 0 8px">Sign In</h2>
      <div class="row">
        <div>
          <label for="username">Username</label>
          <input id="username" type="email" placeholder="Trimbledustn@gmail.com" />
        </div>
        <div>
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Password" />
        </div>
      </div>
      <div style="margin-top:8px"><button id="loginBtn">Sign In</button></div>
    </div>

    <div class="card hidden" id="toolsCard">
      <h2 style="margin:0 0 8px">Admin Tools</h2>
      <div class="row">
        <div>
          <label for="adminCode">Admin Code</label>
          <input id="adminCode" type="password" placeholder="1978Luke$$" />
        </div>
        <div style="align-self:end"><button id="logoutBtn" class="secondary">Sign Out</button></div>
      </div>

      <div class="muted" style="margin-top:8px">Main Event workspace is isolated below for fast big-night operation.</div>

      <div class="tool-section">
      <h3 style="margin:0 0 8px">Main Event Control</h3>
      <div class="row">
        <div>
          <label for="mainEventRoomCode">Main Event Room Code</label>
          <input id="mainEventRoomCode" placeholder="WATCH01 or custom room" />
        </div>
        <div>
          <label for="mainEventLockdown">Main Event Mode</label>
          <select id="mainEventLockdown">
            <option value="0">Off</option>
            <option value="1">Lockdown On (route viewers to main room)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="mainEventCountdown">Countdown (UTC)</label>
          <input id="mainEventCountdown" type="datetime-local" />
        </div>
        <div style="align-self:end">
          <button id="nextSaturdayBtn" class="secondary">Set Next Saturday</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="loadMainEventBtn" class="secondary">Load Main Event Settings</button>
        <button id="saveMainEventBtn">Save Main Event Settings</button>
      </div>
      </div>

      <div class="tool-section tv-console">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">Main Event TV Console</h3>
        <div style="text-align:right"><span class="pill">Big Night Mode</span></div>
      </div>
      <div class="guide-panel">
        <div class="guide-title">Big Night Quick Guide</div>
        <div id="guideStep1" class="guide-step">1. Click Quick Start Main Event</div>
        <div id="guideStep2" class="guide-step">2. In Streaming Console, start your screen share</div>
        <div id="guideStep3" class="guide-step">3. Click Go Live</div>
        <div id="guideStep4" class="guide-step">4. Share the Main Event link</div>
        <div class="muted">If timing changes: update countdown in Main Event Control, then save.</div>
      </div>
      <div class="easy-bar">
        <div class="row">
          <button id="quickStartMainEventBtn" class="big">Quick Start Main Event (Recommended)</button>
          <button id="quickStopMainEventBtn" class="danger big">Quick Stop</button>
        </div>
        <div id="quickMainEventState" class="muted">Ready. Click Quick Start to auto-configure main event.</div>
      </div>
      <div class="muted" style="margin:6px 0 8px">Fast workflow: Prep, Create Event, Load Stream Console, then Go Live.</div>
      <div class="row" style="margin-bottom:8px">
        <button id="mainEventPrepBtn" class="secondary big">1) Prep Console</button>
        <button id="createMainEventBtn" class="big">2) Create + Enable</button>
        <button id="mainEventGoLiveBtn" class="big">3) Go Live</button>
      </div>
      <div class="row">
        <div>
          <label for="mainEventHostName">Host Display Name</label>
          <input id="mainEventHostName" placeholder="DFrenzy" />
        </div>
        <div>
          <label for="mainEventTitle">Main Event Title</label>
          <input id="mainEventTitle" placeholder="Friday Main Event" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="mainEventMode">Transport Mode</label>
          <select id="mainEventMode">
            <option value="broadcast">Broadcast (Main Event)</option>
            <option value="sfu">SFU</option>
            <option value="webrtc">WebRTC</option>
          </select>
        </div>
        <div>
          <label for="mainEventRooms">Existing Active Rooms</label>
          <select id="mainEventRooms"></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="refreshRoomsBtn" class="secondary">Refresh Rooms</button>
      </div>
      <div class="muted" style="margin-top:4px">For huge nights, keep Transport Mode on Broadcast.</div>
      <div class="row" style="margin-top:8px">
        <button id="enableMainEventBtn">Enable Lockdown</button>
        <button id="disableMainEventBtn" class="secondary">Disable Lockdown</button>
        <button id="stopMainEventBtn" class="danger">Stop + Delete Event Room</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="openMainEventBtn" class="secondary">Open Event Room</button>
        <button id="copyMainEventJoinBtn" class="secondary">Copy Public Join Link</button>
      </div>
      <div id="mainEventInfo" class="muted" style="margin-top:6px">No main event room selected.</div>
      <div id="mainEventHostInfo" class="muted" style="margin-top:4px">Host controls: not attached</div>
      </div>

      <div class="tool-section tv-console">
      <h3 style="margin:0 0 8px">Main Event Studio</h3>
      <div class="row">
        <div>
          <label for="studioTitle">Movie / Episode Title</label>
          <input id="studioTitle" placeholder="Movie Night Title" />
        </div>
        <div>
          <label for="studioMediaUrl">Media URL</label>
          <input id="studioMediaUrl" placeholder="https://.../video.mp4" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="studioAttachHostBtn" class="secondary">Attach Host Controls</button>
        <button id="studioSetMediaBtn">Set Movie</button>
        <button id="studioSetTitleBtn" class="secondary">Set Title Only</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="studioSeekSec">Seek To (seconds)</label>
          <input id="studioSeekSec" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div>
          <label for="studioTheme">Room Theme</label>
          <select id="studioTheme">
            <option value="clean">Clean</option>
            <option value="anime">Anime</option>
            <option value="blossom">Blossom</option>
            <option value="city">City</option>
            <option value="neon">Neon</option>
          </select>
        </div>
        <div>
          <label for="studioAccessMode">Access Mode</label>
          <select id="studioAccessMode">
            <option value="public">Public</option>
            <option value="invite">Invite Only</option>
            <option value="closed">Closed</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="studioPlayBtn">Play</button>
        <button id="studioPauseBtn" class="secondary">Pause</button>
        <button id="studioSeekBtn" class="secondary">Seek</button>
        <button id="studioThemeBtn" class="secondary">Apply Theme</button>
        <button id="studioAccessBtn" class="secondary">Apply Access</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="studioMessage">Room Message</label>
          <input id="studioMessage" placeholder="Main Event is starting now." />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="studioMessageBtn" class="secondary">Send Room Message</button>
      </div>
      </div>

      <div class="tool-section tv-console">
      <h3 style="margin:0 0 8px">Streaming Console</h3>
      <div class="row">
        <div>
          <label for="studioStreamUrl">Embedded Stream URL</label>
          <input id="studioStreamUrl" readonly />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="studioLoadStreamBtn">Load Stream Console</button>
        <button id="studioPopoutStreamBtn" class="secondary">Open In New Tab</button>
        <button id="studioRefreshStreamBtn" class="secondary">Refresh Console</button>
      </div>
      <div style="margin-top:8px"><span class="pill">Use this panel to run the actual share/stream workflow live.</span></div>
      <div class="muted" style="margin-top:6px">When the stream preview looks right, come back and click Go Live.</div>
      <iframe id="studioStreamFrame" class="stream-frame" loading="lazy" referrerpolicy="strict-origin-when-cross-origin"></iframe>
      </div>

      <details class="tool-section">
      <summary>Other Admin Tools (optional)</summary>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="roomCodeDelete">Room Code</label>
          <input id="roomCodeDelete" placeholder="DADDYR" />
        </div>
        <div style="align-self:end"><button id="deleteRoomBtn" class="danger">Delete Room</button></div>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <div>
          <label for="newAdminUser">Add/Update Username</label>
          <input id="newAdminUser" type="email" placeholder="newadmin@email.com" />
        </div>
        <div>
          <label for="newAdminPass">Add/Update Password</label>
          <input id="newAdminPass" type="password" placeholder="At least 8 characters" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="addAdminBtn" class="secondary">Add / Update Admin</button>
        <button id="refreshBtn" class="secondary">Refresh List</button>
      </div>
      <div style="margin-top:8px">
        <label for="adminList">Admins</label>
        <select id="adminList"></select>
      </div>
      <div style="margin-top:8px"><button id="removeAdminBtn" class="danger">Remove Selected Admin</button></div>
      </details>
    </div>
  </div>

  <script>
    const API = 'https://api.frenzynets.com/api/telewatch';
    const KEY = 'telewatch_admin_session';
    const ADMIN_CODE_KEY = 'telewatch_admin_code';
    const els = {
      status: document.getElementById('status'),
      loginCard: document.getElementById('loginCard'),
      toolsCard: document.getElementById('toolsCard'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      adminCode: document.getElementById('adminCode'),
      roomCodeDelete: document.getElementById('roomCodeDelete'),
      mainEventRoomCode: document.getElementById('mainEventRoomCode'),
      mainEventLockdown: document.getElementById('mainEventLockdown'),
      mainEventCountdown: document.getElementById('mainEventCountdown'),
      mainEventHostName: document.getElementById('mainEventHostName'),
      mainEventTitle: document.getElementById('mainEventTitle'),
      mainEventMode: document.getElementById('mainEventMode'),
      mainEventRooms: document.getElementById('mainEventRooms'),
      refreshRoomsBtn: document.getElementById('refreshRoomsBtn'),
      mainEventPrepBtn: document.getElementById('mainEventPrepBtn'),
      quickStartMainEventBtn: document.getElementById('quickStartMainEventBtn'),
      quickStopMainEventBtn: document.getElementById('quickStopMainEventBtn'),
      quickMainEventState: document.getElementById('quickMainEventState'),
      guideStep1: document.getElementById('guideStep1'),
      guideStep2: document.getElementById('guideStep2'),
      guideStep3: document.getElementById('guideStep3'),
      guideStep4: document.getElementById('guideStep4'),
      createMainEventBtn: document.getElementById('createMainEventBtn'),
      mainEventGoLiveBtn: document.getElementById('mainEventGoLiveBtn'),
      enableMainEventBtn: document.getElementById('enableMainEventBtn'),
      disableMainEventBtn: document.getElementById('disableMainEventBtn'),
      stopMainEventBtn: document.getElementById('stopMainEventBtn'),
      openMainEventBtn: document.getElementById('openMainEventBtn'),
      copyMainEventJoinBtn: document.getElementById('copyMainEventJoinBtn'),
      mainEventInfo: document.getElementById('mainEventInfo'),
      mainEventHostInfo: document.getElementById('mainEventHostInfo'),
      studioTitle: document.getElementById('studioTitle'),
      studioMediaUrl: document.getElementById('studioMediaUrl'),
      studioSeekSec: document.getElementById('studioSeekSec'),
      studioTheme: document.getElementById('studioTheme'),
      studioAccessMode: document.getElementById('studioAccessMode'),
      studioMessage: document.getElementById('studioMessage'),
      studioAttachHostBtn: document.getElementById('studioAttachHostBtn'),
      studioSetMediaBtn: document.getElementById('studioSetMediaBtn'),
      studioSetTitleBtn: document.getElementById('studioSetTitleBtn'),
      studioPlayBtn: document.getElementById('studioPlayBtn'),
      studioPauseBtn: document.getElementById('studioPauseBtn'),
      studioSeekBtn: document.getElementById('studioSeekBtn'),
      studioThemeBtn: document.getElementById('studioThemeBtn'),
      studioAccessBtn: document.getElementById('studioAccessBtn'),
      studioMessageBtn: document.getElementById('studioMessageBtn'),
      studioStreamUrl: document.getElementById('studioStreamUrl'),
      studioStreamFrame: document.getElementById('studioStreamFrame'),
      studioLoadStreamBtn: document.getElementById('studioLoadStreamBtn'),
      studioPopoutStreamBtn: document.getElementById('studioPopoutStreamBtn'),
      studioRefreshStreamBtn: document.getElementById('studioRefreshStreamBtn'),
      newAdminUser: document.getElementById('newAdminUser'),
      newAdminPass: document.getElementById('newAdminPass'),
      adminList: document.getElementById('adminList'),
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      deleteRoomBtn: document.getElementById('deleteRoomBtn'),
      loadMainEventBtn: document.getElementById('loadMainEventBtn'),
      nextSaturdayBtn: document.getElementById('nextSaturdayBtn'),
      saveMainEventBtn: document.getElementById('saveMainEventBtn'),
      addAdminBtn: document.getElementById('addAdminBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      removeAdminBtn: document.getElementById('removeAdminBtn'),
    };
    const state = { token: '', username: '', mainHostToken: '', mainHostRoomCode: '' };

    async function api(path, body) {
      const res = await fetch(API + path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {}),
        cache: 'no-store'
      });
      const txt = await res.text();
      let data = {};
      try { data = txt ? JSON.parse(txt) : {}; } catch (_) {}
      if (!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
      return data;
    }

    function setStatus(msg) { els.status.textContent = msg; }
    function readAdminCode() {
      return String(els.adminCode.value || '').trim();
    }
    function persistAdminCode() {
      try {
        const code = readAdminCode();
        if (!code) {
          localStorage.removeItem(ADMIN_CODE_KEY);
          return;
        }
        localStorage.setItem(ADMIN_CODE_KEY, code);
      } catch (_) {}
    }
    function loadAdminCode() {
      try {
        const code = String(localStorage.getItem(ADMIN_CODE_KEY) || '').trim();
        if (code && !els.adminCode.value) els.adminCode.value = code;
      } catch (_) {}
    }
    function ensureAdminCode() {
      const code = readAdminCode();
      if (code) return code;
      setStatus('Admin code is required for this action.');
      els.adminCode.focus();
      throw new Error('admin_code_required');
    }
    function describeApiError(err) {
      const msg = String(err && err.message ? err.message : err);
      if (msg === 'admin_auth_invalid' || msg === 'admin_auth_required') return 'Session expired. Sign in again.';
      if (msg === 'admin_code_required' || msg === 'admin_code_invalid') return 'Enter the correct admin code.';
      if (msg === 'room_code_taken') return 'That room code already exists. Choose another room code.';
      if (msg === 'host_router_limit') return 'This network already has an active hosted room. End it first.';
      if (msg === 'room_capacity_reached') return 'Max room capacity reached on server.';
      if (msg === 'main_event_room_locked') return 'Main Event room is locked to another code.';
      return msg;
    }
    function cleanCode(v) {
      return String(v || '').trim().toUpperCase().replace(/[^A-Z0-9_-]/g, '').slice(0, 24);
    }
    function mainEventJoinUrl(code) {
      const c = cleanCode(code);
      return c ? `https://frenzynets.com/telewatch/?room=${encodeURIComponent(c)}` : 'https://frenzynets.com/telewatch/?mainEvent=1';
    }
    function mainEventStudioUrl(code) {
      const c = cleanCode(code);
      return c ? `https://frenzynets.com/telewatch/?room=${encodeURIComponent(c)}&admin=1` : 'https://frenzynets.com/telewatch/?admin=1';
    }
    function setQuickState(msg) {
      if (els.quickMainEventState) els.quickMainEventState.textContent = msg;
    }
    function setGuideProgress(stepNum) {
      const nodes = [els.guideStep1, els.guideStep2, els.guideStep3, els.guideStep4];
      for (let i = 0; i < nodes.length; i += 1) {
        const node = nodes[i];
        if (!node) continue;
        node.classList.toggle('done', i < stepNum);
      }
    }
    function toLocalInputValue(iso) {
      const d = new Date(String(iso || '').trim());
      if (!Number.isFinite(d.getTime())) return '';
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function localInputToIso(v) {
      const s = String(v || '').trim();
      if (!s) return '';
      const d = new Date(s);
      if (!Number.isFinite(d.getTime())) return '';
      return d.toISOString().replace(/\.\d{3}Z$/, 'Z');
    }
    function nextSaturdayLocalInput() {
      const now = new Date();
      const target = new Date(now.getTime());
      const days = (6 - target.getDay() + 7) % 7;
      target.setDate(target.getDate() + days);
      target.setHours(20, 0, 0, 0);
      if (target.getTime() <= now.getTime()) target.setDate(target.getDate() + 7);
      return toLocalInputValue(target.toISOString());
    }
    function render() {
      const signed = !!(state.token && state.username);
      els.loginCard.classList.toggle('hidden', signed);
      els.toolsCard.classList.toggle('hidden', !signed);
      setStatus(signed ? ('Signed in as ' + state.username) : 'Not signed in');
      const hostReady = !!(state.mainHostToken && cleanCode(state.mainHostRoomCode));
      els.mainEventHostInfo.textContent = hostReady
        ? `Host controls attached to ${cleanCode(state.mainHostRoomCode)}`
        : 'Host controls: not attached';
    }
    function save() {
      try {
        if (!state.token) return localStorage.removeItem(KEY);
        localStorage.setItem(KEY, JSON.stringify({
          adminToken: state.token,
          adminUsername: state.username,
          mainHostToken: state.mainHostToken,
          mainHostRoomCode: state.mainHostRoomCode
        }));
        persistAdminCode();
      } catch (_) {}
    }
    function load() {
      try {
        const raw = localStorage.getItem(KEY) || '';
        if (!raw) return;
        const s = JSON.parse(raw);
        state.token = String(s.adminToken || '').trim();
        state.username = String(s.adminUsername || '').trim().toLowerCase();
        state.mainHostToken = String(s.mainHostToken || '').trim();
        state.mainHostRoomCode = cleanCode(s.mainHostRoomCode || '');
      } catch (_) {}
    }

    function selectedMainRoomCode() {
      return cleanCode(els.mainEventRoomCode.value || els.mainEventRooms.value || state.mainHostRoomCode);
    }

    async function sendMainControl(action, extra) {
      const roomCode = selectedMainRoomCode();
      const participantToken = String(state.mainHostToken || '').trim();
      if (!roomCode) throw new Error('main_event_room_required');
      if (!participantToken) throw new Error('host_controls_not_attached');
      return api('/api/watch/control', Object.assign({
        roomCode,
        participantToken,
        action
      }, extra || {}));
    }

    async function refreshAdmins() {
      const data = await api('/api/watch/admin/list', { adminToken: state.token });
      const rows = Array.isArray(data.admins) ? data.admins : [];
      els.adminList.innerHTML = '';
      for (const r of rows) {
        const o = document.createElement('option');
        o.value = r.username;
        o.textContent = r.isOwner ? `${r.username} (owner)` : r.username;
        els.adminList.appendChild(o);
      }
      if (!rows.length) {
        const o = document.createElement('option');
        o.value = '';
        o.textContent = 'No admins found';
        els.adminList.appendChild(o);
      }
    }

    async function refreshAdminRooms() {
      const data = await api('/api/watch/admin/rooms', { adminToken: state.token });
      const rows = Array.isArray(data.rooms) ? data.rooms : [];
      els.mainEventRooms.innerHTML = '';
      for (const r of rows) {
        const code = cleanCode(r.roomCode || '');
        if (!code) continue;
        const o = document.createElement('option');
        o.value = code;
        const host = String(r.hostName || '').trim() || 'No host';
        const count = Number(r.activeCount || 0);
        o.textContent = `${code} · ${host} · ${count} live`;
        els.mainEventRooms.appendChild(o);
      }
      if (!els.mainEventRooms.options.length) {
        const o = document.createElement('option');
        o.value = '';
        o.textContent = 'No active rooms';
        els.mainEventRooms.appendChild(o);
      }
      const selected = cleanCode(els.mainEventRoomCode.value || els.mainEventRooms.value);
      els.mainEventInfo.textContent = selected ? `Main Event Link: ${mainEventJoinUrl(selected)}` : 'No main event room selected.';
      els.studioStreamUrl.value = mainEventStudioUrl(selected);
    }

    async function loadMainEventSettings() {
      const data = await api('/api/watch/admin/settings', { adminToken: state.token, action: 'get' });
      const s = data && data.settings ? data.settings : {};
      els.mainEventRoomCode.value = String(s.mainEventRoomCode || '').toUpperCase();
      els.mainEventLockdown.value = s.mainEventLockdown ? '1' : '0';
      els.mainEventCountdown.value = toLocalInputValue(s.mainEventCountdownIso || '');
      const c = cleanCode(s.mainEventRoomCode || '');
      els.mainEventInfo.textContent = c ? `Main Event Link: ${mainEventJoinUrl(c)}` : 'No main event room selected.';
      els.studioStreamUrl.value = mainEventStudioUrl(c);
    }

    els.loginBtn.addEventListener('click', async () => {
      try {
        const data = await api('/api/watch/admin/login', {
          username: String(els.username.value || '').trim().toLowerCase(),
          password: String(els.password.value || '').trim()
        });
        state.token = String(data.adminToken || '');
        state.username = String(data.username || '').toLowerCase();
        save();
        render();
        await refreshAdmins();
        await refreshAdminRooms();
        await loadMainEventSettings();
      } catch (e) {
        setStatus('Login failed: ' + describeApiError(e));
      }
    });

    els.logoutBtn.addEventListener('click', async () => {
      try { await api('/api/watch/admin/logout', { adminToken: state.token }); } catch (_) {}
      state.token = '';
      state.username = '';
      save();
      render();
    });

    els.deleteRoomBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        await api('/api/watch/delete', {
          roomCode: String(els.roomCodeDelete.value || '').trim().toUpperCase(),
          adminToken: state.token,
          adminCode
        });
        setStatus('Room deleted.');
      } catch (e) {
        setStatus('Delete failed: ' + describeApiError(e));
      }
    });

    els.loadMainEventBtn.addEventListener('click', async () => {
      try {
        await loadMainEventSettings();
        await refreshAdminRooms();
        setStatus('Main event settings loaded.');
      } catch (e) {
        setStatus('Load failed: ' + (e.message || e));
      }
    });

    els.nextSaturdayBtn.addEventListener('click', () => {
      els.mainEventCountdown.value = nextSaturdayLocalInput();
      setStatus('Countdown set to next Saturday (local time).');
    });

    els.saveMainEventBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        const payload = {
          adminToken: state.token,
          adminCode,
          action: 'set',
          mainEventRoomCode: String(els.mainEventRoomCode.value || '').trim().toUpperCase(),
          mainEventLockdown: els.mainEventLockdown.value === '1',
          mainEventCountdownIso: localInputToIso(els.mainEventCountdown.value)
        };
        await api('/api/watch/admin/settings', payload);
        await loadMainEventSettings();
        await refreshAdminRooms();
        setStatus('Main event settings saved.');
      } catch (e) {
        setStatus('Save failed: ' + describeApiError(e));
      }
    });

    els.mainEventRooms.addEventListener('change', () => {
      const code = cleanCode(els.mainEventRooms.value);
      if (code) {
        els.mainEventRoomCode.value = code;
        els.mainEventInfo.textContent = `Main Event Link: ${mainEventJoinUrl(code)}`;
        els.studioStreamUrl.value = mainEventStudioUrl(code);
      }
    });

    els.mainEventRoomCode.addEventListener('input', () => {
      const code = cleanCode(els.mainEventRoomCode.value);
      els.mainEventRoomCode.value = code;
      els.mainEventInfo.textContent = code ? `Main Event Link: ${mainEventJoinUrl(code)}` : 'No main event room selected.';
      els.studioStreamUrl.value = mainEventStudioUrl(code);
    });

    els.refreshRoomsBtn.addEventListener('click', async () => {
      try {
        await refreshAdminRooms();
        setStatus('Rooms refreshed.');
      } catch (e) {
        setStatus('Room refresh failed: ' + (e.message || e));
      }
    });

    els.mainEventPrepBtn.addEventListener('click', async () => {
      try {
        if (!els.mainEventCountdown.value) {
          els.mainEventCountdown.value = nextSaturdayLocalInput();
        }
        els.mainEventMode.value = 'broadcast';
        els.studioAccessMode.value = 'public';
        els.studioTheme.value = 'clean';
        await refreshAdminRooms();
        await loadMainEventSettings();
        setStatus('Console prepped for big night.');
      } catch (e) {
        setStatus('Prep failed: ' + (e.message || e));
      }
    });

    els.quickStartMainEventBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        setQuickState('Starting: preparing console defaults...');
        if (!els.mainEventCountdown.value) {
          els.mainEventCountdown.value = nextSaturdayLocalInput();
        }
        if (!String(els.mainEventMode.value || '').trim()) els.mainEventMode.value = 'broadcast';
        if (!String(els.studioAccessMode.value || '').trim()) els.studioAccessMode.value = 'public';
        if (!String(els.studioTheme.value || '').trim()) els.studioTheme.value = 'clean';

        let code = cleanCode(els.mainEventRoomCode.value || els.mainEventRooms.value);
        if (!code) {
          setQuickState('Creating main event room...');
          const created = await api('/api/watch/create', {
            adminToken: state.token,
            roomCode: '',
            displayName: String(els.mainEventHostName.value || '').trim() || 'MainHost',
            title: String(els.mainEventTitle.value || '').trim() || 'Main Event',
            accessMode: 'public',
            mediaMode: String(els.mainEventMode.value || 'broadcast').trim().toLowerCase()
          });
          code = cleanCode(created.roomCode || '');
          state.mainHostToken = String(created.participantToken || '').trim();
          state.mainHostRoomCode = code;
        }
        if (!code) throw new Error('main_event_room_required');
        els.mainEventRoomCode.value = code;

        setQuickState('Applying lockdown + countdown settings...');
        await api('/api/watch/admin/settings', {
          adminToken: state.token,
          adminCode,
          action: 'set',
          mainEventRoomCode: code,
          mainEventLockdown: true,
          mainEventCountdownIso: localInputToIso(els.mainEventCountdown.value)
        });
        els.mainEventLockdown.value = '1';

        if (!String(state.mainHostToken || '').trim() || cleanCode(state.mainHostRoomCode) !== code) {
          setQuickState('Attaching host controls...');
          const joined = await api('/api/watch/join', {
            roomCode: code,
            displayName: String(els.mainEventHostName.value || '').trim() || 'MainHost'
          });
          if (joined && joined.isHost) {
            state.mainHostToken = String(joined.participantToken || '').trim();
            state.mainHostRoomCode = code;
          }
        }

        if (String(els.studioTitle.value || '').trim() || String(els.studioMediaUrl.value || '').trim()) {
          setQuickState('Setting movie details...');
          await sendMainControl('set_media', {
            title: String(els.studioTitle.value || els.mainEventTitle.value || '').trim(),
            mediaUrl: String(els.studioMediaUrl.value || '').trim()
          });
        }
        await sendMainControl('set_access_mode', { accessMode: String(els.studioAccessMode.value || 'public').trim() });
        await sendMainControl('set_theme', { themeKey: String(els.studioTheme.value || 'clean').trim() });

        const url = mainEventStudioUrl(code);
        els.studioStreamUrl.value = url;
        els.studioStreamFrame.src = url;
        save();
        render();
        await refreshAdminRooms();
        await loadMainEventSettings();
        setGuideProgress(1);
        setQuickState(`Ready: room ${code} configured. Use Go Live when stream is ready.`);
        setStatus(`Main Event quick setup complete for ${code}.`);
      } catch (e) {
        setQuickState('Quick Start failed. Check admin code / room state.');
        setStatus('Quick Start failed: ' + describeApiError(e));
      }
    });

    els.quickStopMainEventBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        const code = cleanCode(els.mainEventRoomCode.value || els.mainEventRooms.value || state.mainHostRoomCode);
        if (!code) throw new Error('main_event_room_required');
        await api('/api/watch/delete', {
          roomCode: code,
          adminToken: state.token,
          adminCode
        });
        await api('/api/watch/admin/settings', {
          adminToken: state.token,
          adminCode,
          action: 'set',
          mainEventLockdown: false,
          mainEventRoomCode: ''
        });
        state.mainHostToken = '';
        state.mainHostRoomCode = '';
        els.mainEventRoomCode.value = '';
        els.mainEventLockdown.value = '0';
        els.studioStreamFrame.src = '';
        els.studioStreamUrl.value = mainEventStudioUrl('');
        save();
        render();
        await refreshAdminRooms();
        await loadMainEventSettings();
        setGuideProgress(0);
        setQuickState('Stopped. Main Event is fully disabled.');
        setStatus(`Main Event stopped and room ${code} deleted.`);
      } catch (e) {
        setQuickState('Quick Stop failed.');
        setStatus('Quick Stop failed: ' + describeApiError(e));
      }
    });

    els.createMainEventBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        const roomCode = cleanCode(els.mainEventRoomCode.value);
        const created = await api('/api/watch/create', {
          adminToken: state.token,
          roomCode,
          displayName: String(els.mainEventHostName.value || '').trim() || 'MainHost',
          title: String(els.mainEventTitle.value || '').trim() || 'Main Event',
          accessMode: 'public',
          mediaMode: String(els.mainEventMode.value || 'broadcast').trim().toLowerCase()
        });
        const code = cleanCode(created.roomCode || roomCode);
        state.mainHostToken = String(created.participantToken || '').trim();
        state.mainHostRoomCode = code;
        els.mainEventRoomCode.value = code;
        await api('/api/watch/admin/settings', {
          adminToken: state.token,
          adminCode,
          action: 'set',
          mainEventRoomCode: code,
          mainEventLockdown: true,
          mainEventCountdownIso: localInputToIso(els.mainEventCountdown.value)
        });
        els.mainEventLockdown.value = '1';
        await refreshAdminRooms();
        await loadMainEventSettings();
        save();
        render();
        setStatus(`Main Event started in room ${code}.`);
      } catch (e) {
        setStatus('Create Main Event failed: ' + describeApiError(e));
      }
    });

    els.mainEventGoLiveBtn.addEventListener('click', async () => {
      try {
        await sendMainControl('play', {});
        await sendMainControl('chat', { message: 'Main Event is now LIVE. Enjoy the show.' });
        setGuideProgress(3);
        setStatus('Main Event is LIVE.');
      } catch (e) {
        setStatus('Go Live failed: ' + (e.message || e));
      }
    });

    els.enableMainEventBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        const code = cleanCode(els.mainEventRoomCode.value || els.mainEventRooms.value);
        if (!code) throw new Error('main_event_room_required');
        await api('/api/watch/admin/settings', {
          adminToken: state.token,
          adminCode,
          action: 'set',
          mainEventRoomCode: code,
          mainEventLockdown: true,
          mainEventCountdownIso: localInputToIso(els.mainEventCountdown.value)
        });
        els.mainEventLockdown.value = '1';
        await loadMainEventSettings();
        setStatus(`Main Event lockdown enabled for ${code}.`);
      } catch (e) {
        setStatus('Enable failed: ' + describeApiError(e));
      }
    });

    els.disableMainEventBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        await api('/api/watch/admin/settings', {
          adminToken: state.token,
          adminCode,
          action: 'set',
          mainEventLockdown: false
        });
        els.mainEventLockdown.value = '0';
        await loadMainEventSettings();
        setStatus('Main Event lockdown disabled.');
      } catch (e) {
        setStatus('Disable failed: ' + describeApiError(e));
      }
    });

    els.studioAttachHostBtn.addEventListener('click', async () => {
      try {
        const roomCode = selectedMainRoomCode();
        if (!roomCode) throw new Error('main_event_room_required');
        const joined = await api('/api/watch/join', {
          roomCode,
          displayName: String(els.mainEventHostName.value || '').trim() || 'MainHost'
        });
        if (!joined.isHost) throw new Error('host_already_active_in_room');
        state.mainHostToken = String(joined.participantToken || '').trim();
        state.mainHostRoomCode = roomCode;
        save();
        render();
        setStatus(`Host controls attached to ${roomCode}.`);
      } catch (e) {
        setStatus('Attach failed: ' + (e.message || e));
      }
    });

    els.studioSetMediaBtn.addEventListener('click', async () => {
      try {
        await sendMainControl('set_media', {
          title: String(els.studioTitle.value || '').trim(),
          mediaUrl: String(els.studioMediaUrl.value || '').trim()
        });
        setStatus('Movie/media set for Main Event room.');
      } catch (e) {
        setStatus('Set movie failed: ' + (e.message || e));
      }
    });

    els.studioSetTitleBtn.addEventListener('click', async () => {
      try {
        await sendMainControl('set_title', { title: String(els.studioTitle.value || '').trim() });
        setStatus('Main Event title updated.');
      } catch (e) {
        setStatus('Set title failed: ' + (e.message || e));
      }
    });

    els.studioPlayBtn.addEventListener('click', async () => {
      try {
        await sendMainControl('play', {});
        setStatus('Playback set to play.');
      } catch (e) {
        setStatus('Play failed: ' + (e.message || e));
      }
    });

    els.studioPauseBtn.addEventListener('click', async () => {
      try {
        await sendMainControl('pause', {});
        setStatus('Playback paused.');
      } catch (e) {
        setStatus('Pause failed: ' + (e.message || e));
      }
    });

    els.studioSeekBtn.addEventListener('click', async () => {
      try {
        const sec = Number(String(els.studioSeekSec.value || '').trim());
        if (!Number.isFinite(sec) || sec < 0) throw new Error('seek_seconds_invalid');
        await sendMainControl('seek', { playbackSec: sec });
        setStatus(`Seeked to ${Math.floor(sec)}s.`);
      } catch (e) {
        setStatus('Seek failed: ' + (e.message || e));
      }
    });

    els.studioThemeBtn.addEventListener('click', async () => {
      try {
        await sendMainControl('set_theme', { themeKey: String(els.studioTheme.value || 'clean').trim() });
        setStatus('Theme updated.');
      } catch (e) {
        setStatus('Set theme failed: ' + (e.message || e));
      }
    });

    els.studioAccessBtn.addEventListener('click', async () => {
      try {
        await sendMainControl('set_access_mode', { accessMode: String(els.studioAccessMode.value || 'public').trim() });
        setStatus('Access mode updated.');
      } catch (e) {
        setStatus('Set access failed: ' + (e.message || e));
      }
    });

    els.studioMessageBtn.addEventListener('click', async () => {
      try {
        const message = String(els.studioMessage.value || '').trim();
        if (!message) throw new Error('message_required');
        await sendMainControl('chat', { message });
        els.studioMessage.value = '';
        setStatus('Room message sent.');
      } catch (e) {
        setStatus('Message send failed: ' + (e.message || e));
      }
    });

    els.stopMainEventBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        const code = cleanCode(els.mainEventRoomCode.value || els.mainEventRooms.value);
        if (!code) throw new Error('main_event_room_required');
        await api('/api/watch/delete', {
          roomCode: code,
          adminToken: state.token,
          adminCode
        });
        await api('/api/watch/admin/settings', {
          adminToken: state.token,
          adminCode,
          action: 'set',
          mainEventLockdown: false,
          mainEventRoomCode: ''
        });
        els.mainEventRoomCode.value = '';
        els.mainEventLockdown.value = '0';
        state.mainHostToken = '';
        state.mainHostRoomCode = '';
        await refreshAdminRooms();
        await loadMainEventSettings();
        save();
        render();
        setStatus(`Main Event stopped and room ${code} removed.`);
      } catch (e) {
        setStatus('Stop failed: ' + describeApiError(e));
      }
    });

    els.openMainEventBtn.addEventListener('click', () => {
      const code = cleanCode(els.mainEventRoomCode.value || els.mainEventRooms.value);
      setGuideProgress(4);
      window.open(mainEventJoinUrl(code), '_blank', 'noopener');
    });

    els.copyMainEventJoinBtn.addEventListener('click', async () => {
      try {
        const code = cleanCode(els.mainEventRoomCode.value || els.mainEventRooms.value);
        await navigator.clipboard.writeText(mainEventJoinUrl(code));
        setGuideProgress(4);
        setStatus('Main Event public link copied.');
      } catch (_) {
        setStatus('Copy failed. Browser blocked clipboard.');
      }
    });

    els.studioLoadStreamBtn.addEventListener('click', () => {
      const code = selectedMainRoomCode();
      const url = mainEventStudioUrl(code);
      els.studioStreamUrl.value = url;
      els.studioStreamFrame.src = url;
      setGuideProgress(2);
      setStatus(`Stream console loaded for ${cleanCode(code) || 'admin mode'}.`);
    });

    els.studioPopoutStreamBtn.addEventListener('click', () => {
      const code = selectedMainRoomCode();
      const url = mainEventStudioUrl(code);
      els.studioStreamUrl.value = url;
      window.open(url, '_blank', 'noopener');
    });

    els.studioRefreshStreamBtn.addEventListener('click', () => {
      const current = String(els.studioStreamFrame.src || '').trim();
      if (!current) {
        const code = selectedMainRoomCode();
        const url = mainEventStudioUrl(code);
        els.studioStreamUrl.value = url;
        els.studioStreamFrame.src = url;
        return;
      }
      els.studioStreamFrame.src = current;
      setStatus('Stream console refreshed.');
    });

    els.addAdminBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        await api('/api/watch/admin/add', {
          adminToken: state.token,
          adminCode,
          newUsername: String(els.newAdminUser.value || '').trim().toLowerCase(),
          newPassword: String(els.newAdminPass.value || '').trim()
        });
        els.newAdminPass.value = '';
        await refreshAdmins();
        setStatus('Admin saved.');
      } catch (e) {
        setStatus('Add/update failed: ' + describeApiError(e));
      }
    });

    els.refreshBtn.addEventListener('click', async () => {
      try {
        await refreshAdmins();
        await refreshAdminRooms();
        setStatus('Admin list + rooms refreshed.');
      } catch (e) {
        setStatus('Refresh failed: ' + (e.message || e));
      }
    });

    els.removeAdminBtn.addEventListener('click', async () => {
      try {
        const adminCode = ensureAdminCode();
        const username = String(els.adminList.value || '').trim().toLowerCase();
        await api('/api/watch/admin/remove', {
          adminToken: state.token,
          adminCode,
          username
        });
        await refreshAdmins();
        setStatus('Admin removed: ' + username);
      } catch (e) {
        setStatus('Remove failed: ' + describeApiError(e));
      }
    });

    load();
    loadAdminCode();
    els.adminCode.addEventListener('input', persistAdminCode);
    els.username.value = state.username || 'Trimbledustn@gmail.com';
    els.mainEventHostName.value = 'DFrenzy';
    els.mainEventCountdown.value = nextSaturdayLocalInput();
    els.studioStreamUrl.value = mainEventStudioUrl('');
    render();
    if (state.token) {
      refreshAdmins().catch(() => {});
      refreshAdminRooms().catch(() => {});
      loadMainEventSettings().catch(() => {});
    }
  </script>
</body>
</html>
