<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FrenzyNets Admin Control Center</title>
  <style>
    :root {
      --bg:#070d1c; --bg2:#0e1830; --panel:#101d38; --line:#2a4674; --soft:#1c3358;
      --text:#e8f2ff; --muted:#9eb6dc; --brand:#38d8ff; --ok:#72f5b8; --warn:#ffd166; --bad:#ff6f87;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(165deg,var(--bg),var(--bg2));color:var(--text);font-family:Segoe UI,Arial,sans-serif}
    .wrap{max-width:1440px;margin:20px auto;padding:0 12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 240px}
    h1,h2,h3{margin:0 0 8px}
    h1{color:#60dcff;font-size:1.35rem}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    input,select,textarea,button{font:inherit}
    input,select,textarea{background:#091427;border:1px solid #2d4d80;color:var(--text);padding:9px 10px;border-radius:8px}
    textarea{width:100%;min-height:90px}
    button,.btn{background:var(--brand);color:#00111f;border:none;padding:9px 12px;border-radius:8px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    button.secondary,.btn.secondary{background:#132a50;color:var(--text);border:1px solid #3b5e92}
    button.danger{background:var(--bad);color:#22020a}
    .layout{display:grid;grid-template-columns:230px 1fr;gap:12px;margin-top:12px}
    .nav{position:sticky;top:10px;align-self:start}
    .nav button{display:block;width:100%;text-align:left;margin-bottom:8px;background:#102243;color:#d9e9ff;border:1px solid #36598f}
    .nav button.active{background:linear-gradient(180deg,#37d8ff,#00b8ea);color:#02101b;border-color:transparent}
    .section{display:none}
    .section.active{display:block}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .kpi{background:#0b172d;border:1px solid #24406c;border-radius:10px;padding:10px}
    .kpi .k{font-size:12px;color:var(--muted);text-transform:uppercase}
    .kpi .v{font-size:20px;font-weight:700;margin-top:6px}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table th,.table td{border-bottom:1px solid #223f6b;padding:8px 6px;vertical-align:top}
    .table th{color:#b8d3ff;text-align:left;font-size:12px;text-transform:uppercase}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #40679f;background:#10264a;color:#d9ebff;font-size:12px}
    .list{max-height:320px;overflow:auto;border:1px solid #264472;background:#0a162f;border-radius:8px;padding:8px}
    .item{padding:8px;border-bottom:1px solid #1e3962}
    .item:last-child{border-bottom:none}
    .kanban{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .col{border:1px solid #264472;background:#0a1730;border-radius:10px;padding:8px;min-height:240px}
    .col h4{margin:0 0 8px;font-size:13px;color:#bcd6ff;text-transform:uppercase}
    .ticket{border:1px solid #2e527f;background:#0d1e3a;border-radius:8px;padding:8px;margin-bottom:8px;font-size:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hidden{display:none}
    .status{margin-top:8px}
    .preview{border:1px solid #2b4d7d;background:#0a1630;border-radius:10px;padding:10px}
    .tiny{font-size:12px}
    @media(max-width:1100px){.layout{grid-template-columns:1fr}.nav{position:static}.kanban,.grid-3,.grid-2,.split{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>FrenzyNets Admin Control Center</h1>
      <div class="top">
        <input id="username" placeholder="admin username" autocomplete="username" />
        <input id="password" type="password" placeholder="password" autocomplete="current-password" />
        <button id="loginBtn">Login</button>
        <button id="refreshBtn" class="secondary" disabled>Refresh</button>
        <a class="btn secondary" href="/" target="_blank" rel="noopener">Open Site</a>
        <input id="globalSearch" class="grow" placeholder="Global search: user/profile/server/ticket" />
      </div>
      <div id="globalStatus" class="status muted">Not logged in.</div>
      <div id="searchResults" class="list muted" style="margin-top:8px;max-height:140px"></div>
    </div>

    <div id="app" class="layout hidden">
      <div class="nav card">
        <button data-tab="dashboard" class="active">Dashboard</button>
        <button data-tab="revenue">Revenue CRM</button>
        <button data-tab="support">Support Board</button>
        <button data-tab="lifecycle">Lifecycle</button>
        <button data-tab="presets">Presets</button>
        <button data-tab="website">Website</button>
        <button data-tab="monetization">Monetization</button>
        <button data-tab="security">Security</button>
        <button data-tab="fleet">Fleet</button>
        <button data-tab="audit">Audit & Compliance</button>
        <button data-tab="runbooks">Runbooks</button>
        <button data-tab="provisioning">Provisioning Hub</button>
        <button data-tab="actions">Actions</button>
      </div>

      <div>
        <section id="tab-dashboard" class="section active card">
          <h2>Dashboard</h2>
          <div id="kpis" class="grid grid-3"></div>
          <div class="split" style="margin-top:10px">
            <div>
              <h3>Follow-up Due</h3>
              <div id="followupDue" class="list muted">No data.</div>
            </div>
            <div>
              <h3>Expiring Soon (7 days)</h3>
              <div id="expiringSoon" class="list muted">No data.</div>
            </div>
          </div>
        </section>

        <section id="tab-revenue" class="section card">
          <h2>Revenue CRM</h2>
          <div class="muted">Lead stage, next follow-up, and sales notes per user. Saved server-side.</div>
          <div id="revenueTableWrap" style="margin-top:10px"></div>
        </section>

        <section id="tab-support" class="section card">
          <h2>Support Board</h2>
          <div class="row">
            <button id="refreshTickets" class="secondary">Refresh Tickets</button>
            <span class="muted">Tickets are synced from Discord bot storage.</span>
          </div>
          <div id="supportBoard" class="kanban" style="margin-top:10px"></div>
        </section>

        <section id="tab-lifecycle" class="section card">
          <h2>Lifecycle Automation</h2>
          <div class="muted">Quick subscription extension and churn-risk targeting.</div>
          <div id="lifecycleTableWrap" style="margin-top:10px"></div>
        </section>

        <section id="tab-presets" class="section card">
          <h2>Preset Governance</h2>
          <div class="muted">Versioning, staged rollout, and rollback notes for presets.</div>
          <div id="presetTableWrap" style="margin-top:10px"></div>
        </section>

        <section id="tab-website" class="section card">
          <h2>Website Settings</h2>
          <div class="muted">Public website controls used for conversion and urgency messaging.</div>
          <div class="grid grid-2" style="margin-top:10px">
            <div class="card" style="background:#0b1730">
              <h3>Beta Countdown</h3>
              <div class="row">
                <input id="mzBetaCountdownEnds" type="datetime-local" />
                <button id="mzSaveBetaCountdown" class="secondary">Save Website Countdown</button>
              </div>
              <div class="muted">This drives the public home page countdown timer.</div>
              <div id="wsSiteCfgMeta" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Publish & Rollback</h3>
              <div class="row">
                <button id="wsPublishNow" class="secondary">Publish Website</button>
                <select id="wsRollbackPick"><option value="">Snapshot</option></select>
                <button id="wsRollbackApply" class="danger">Rollback Snapshot</button>
              </div>
              <div class="tiny muted">Publish creates a timestamped snapshot and runs basic health checks.</div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Hero Message Editor</h3>
              <div class="row">
                <input id="wsHeroTitle" placeholder="hero headline" />
                <input id="wsHeroSub" placeholder="hero subtext" />
              </div>
              <div class="row">
                <input id="wsHeroCtaPrimary" placeholder="primary CTA label" />
                <input id="wsHeroCtaSecondary" placeholder="secondary CTA label" />
                <button id="wsSaveHero" class="secondary">Save Hero</button>
              </div>
              <div id="wsHeroPreview" class="preview" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Banner Scheduler</h3>
              <div class="row">
                <input id="wsBannerText" placeholder="banner text" />
                <input id="wsBannerStart" type="datetime-local" />
                <input id="wsBannerEnd" type="datetime-local" />
                <button id="wsBannerAdd" class="secondary">Add Banner Window</button>
              </div>
              <div id="wsBannerList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Trust Badges</h3>
              <div class="row">
                <input id="wsTrustUptime" placeholder="uptime badge (99.95%)" />
                <input id="wsTrustUsers" placeholder="active users badge (1,200+ players)" />
                <input id="wsTrustBackup" placeholder="backup badge (daily encrypted backups)" />
                <button id="wsSaveTrust" class="secondary">Save Trust Badges</button>
              </div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>SEO & Social</h3>
              <div class="row">
                <input id="wsSeoTitle" placeholder="page title" />
                <input id="wsSeoDesc" placeholder="meta description" />
              </div>
              <div class="row">
                <input id="wsSeoOgImage" placeholder="OG image URL" />
                <input id="wsSeoDiscordCard" placeholder="Discord share card text" />
                <button id="wsSaveSeo" class="secondary">Save SEO/Social</button>
              </div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Incident Mode</h3>
              <div class="row">
                <select id="wsIncidentMode">
                  <option value="off">off</option>
                  <option value="degraded">degraded</option>
                  <option value="outage">outage</option>
                </select>
                <input id="wsIncidentText" placeholder="incident banner text" />
                <button id="wsSaveIncident" class="secondary">Save Incident Mode</button>
              </div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Download Gate</h3>
              <div class="row">
                <select id="wsGateDotnet"><option value="required">.NET Required</option><option value="optional">.NET Optional</option></select>
                <select id="wsGateWireguard"><option value="required">WireGuard Required</option><option value="optional">WireGuard Optional</option></select>
                <select id="wsGateAdmin"><option value="required">Admin Rights Required</option><option value="optional">Admin Rights Optional</option></select>
                <button id="wsSaveGate" class="secondary">Save Download Gate</button>
              </div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>A/B Hero Tests</h3>
              <div class="row">
                <input id="wsAbName" placeholder="test name" />
                <input id="wsAbA" placeholder="variant A headline" />
                <input id="wsAbB" placeholder="variant B headline" />
                <button id="wsAbAdd" class="secondary">Create A/B Test</button>
                <button id="wsAbPickWinner" class="secondary">Pick Winner</button>
              </div>
              <div id="wsAbList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Conversion Funnel</h3>
              <div class="row">
                <input id="wsVisits" type="number" min="0" placeholder="visits" />
                <input id="wsBillingClicks" type="number" min="0" placeholder="billing clicks" />
                <input id="wsCheckouts" type="number" min="0" placeholder="successful checkouts" />
                <button id="wsSaveFunnel" class="secondary">Save Funnel</button>
              </div>
              <div id="wsFunnelStats" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Website Change Log</h3>
              <div id="wsChangeLog" class="list muted"></div>
            </div>
          </div>
        </section>

        <section id="tab-monetization" class="section card">
          <h2>Monetization Engine</h2>
          <div class="muted">Simple mode: set prices, run renewals, apply referrals, and generate sales/performance messages.</div>
          <div class="grid grid-2" style="margin-top:10px">
            <div class="card" style="background:#0b1730">
              <h3>Quick Pricing</h3>
              <div class="muted">Simple setup: choose a strategy, set your main monthly price, and publish.</div>
              <div class="row">
                <select id="mzStrategy">
                  <option value="balanced">Balanced (recommended)</option>
                  <option value="growth">Growth / premium</option>
                  <option value="value">Value / lower entry</option>
                </select>
                <input id="mzCompTarget" type="number" min="0" value="9" placeholder="Main plan price ($/month)" />
                <button id="mzAutoPrice" class="secondary">Auto Fill Prices</button>
                <button id="mzSaveSimplePricing" class="secondary">Publish Pricing</button>
              </div>
              <div id="mzPriceSummary" class="list muted" style="margin-top:8px"></div>
              <div id="mzPriceExplain" class="list muted" style="margin-top:8px"></div>
              <div class="muted">Tip: keep this below big-brand monthly VPN pricing for easier closes.</div>
              <input id="mzStarter" type="hidden" />
              <input id="mzCompetitive" type="hidden" />
              <input id="mzElite" type="hidden" />
              <input id="mzAntiDdos" type="hidden" />
              <input id="mzPresetAddon" type="hidden" />
              <input id="mzPriorityAddon" type="hidden" />
              <div id="mzPricingHints" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Renewals & Upsells</h3>
              <div class="row">
                <input id="mzRenewalDays" type="number" min="1" value="7" placeholder="days before expiry" />
                <button id="mzBuildRenewals" class="secondary">Build Renewal Queue</button>
                <button id="mzGenerateDiscordRenewal" class="secondary">Generate DM Template</button>
              </div>
              <div id="mzRenewalQueue" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Referral Credits</h3>
              <div class="muted">Use this when a new customer pays from a referral. Both users get bonus access days.</div>
              <div class="row">
                <input id="mzRefFrom" placeholder="1) Referrer username" />
                <input id="mzRefTo" placeholder="2) New paying username" />
                <input id="mzRefDays" type="number" min="1" value="7" placeholder="3) Bonus days (default 7)" />
                <button id="mzAddReferral" class="secondary">Apply Referral Credit</button>
              </div>
              <div class="muted">Example: `dustin` refers `josh` -> both get 7 days.</div>
              <div id="mzReferralList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Auto Referral Queue</h3>
              <div class="row">
                <button id="mzReloadReferralQueue" class="secondary">Reload Queue</button>
              </div>
              <div class="muted">Queued from checkout links using `?ref=username`.</div>
              <div id="mzReferralQueue" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Performance & Sales Message</h3>
              <div class="row">
                <select id="mzPerfUser"><option value="">(select user)</option></select>
                <button id="mzBuildPerf" class="secondary">Build Report</button>
              </div>
              <textarea id="mzPerfReport" placeholder="performance report / sales DM appears here"></textarea>
              <textarea id="mzOutcomeCopy" placeholder="Outcome-based sales line (optional)" style="margin-top:8px"></textarea>
              <div class="row" style="margin-top:8px"><button id="mzSaveCopy" class="secondary">Save Sales Copy</button></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Churn-Risk Automation</h3>
              <div class="row">
                <input id="mzChurnDays3" type="number" min="1" value="3" placeholder="first reminder days" />
                <input id="mzChurnDays1" type="number" min="1" value="1" placeholder="final reminder days" />
                <button id="mzBuildChurn" class="secondary">Build Churn Queue</button>
                <button id="mzGenerateChurnDm" class="secondary">Generate Churn DM Batch</button>
              </div>
              <div id="mzChurnQueue" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Checkout Link Generator</h3>
              <div class="row">
                <select id="mzCheckoutPlan"><option value="">Plan</option></select>
                <select id="mzCheckoutAddon"><option value="">Add-on (optional)</option></select>
                <input id="mzCheckoutUser" placeholder="username (optional)" />
                <button id="mzGenerateCheckoutLink" class="secondary">Generate Link</button>
              </div>
              <div id="mzCheckoutLinks" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Coupons</h3>
              <div class="row">
                <input id="mzCouponCode" placeholder="code (WELCOME10)" />
                <select id="mzCouponType">
                  <option value="percent">percent off</option>
                  <option value="amount">flat amount off</option>
                  <option value="days">bonus days</option>
                </select>
                <input id="mzCouponValue" type="number" min="1" value="10" placeholder="value" />
                <input id="mzCouponExpiry" type="date" />
                <button id="mzCouponCreate" class="secondary">Create Coupon</button>
              </div>
              <div id="mzCouponList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>LTV Dashboard</h3>
              <div id="mzLtvStats" class="list muted"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Failed-Payment Recovery</h3>
              <div class="row">
                <button id="mzBuildFailedRecovery" class="secondary">Build Recovery Queue</button>
                <button id="mzGenerateFailedDm" class="secondary">Generate Recovery DM Batch</button>
              </div>
              <div id="mzFailedRecoveryQueue" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Seat-Based Team Billing</h3>
              <div class="row">
                <select id="mzSeatPlan">
                  <option value="duo">Duo</option>
                  <option value="squad">Squad</option>
                  <option value="competitive">Competitive Team</option>
                </select>
                <input id="mzSeatCount" type="number" min="2" value="5" placeholder="seat count" />
                <input id="mzSeatPrice" type="number" min="1" value="7" placeholder="$/seat monthly" />
                <button id="mzBuildSeatQuote" class="secondary">Build Team Quote</button>
              </div>
              <textarea id="mzSeatQuote" placeholder="Team quote appears here" style="margin-top:8px"></textarea>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>A/B Pricing Tests</h3>
              <div class="row">
                <input id="mzAbName" placeholder="test name" />
                <input id="mzAbPriceA" type="number" min="1" value="9" placeholder="price A" />
                <input id="mzAbPriceB" type="number" min="1" value="11" placeholder="price B" />
                <input id="mzAbStart" type="date" />
                <input id="mzAbEnd" type="date" />
                <button id="mzAbCreate" class="secondary">Create Test</button>
              </div>
              <div id="mzAbList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Reseller / Affiliate</h3>
              <div class="row">
                <input id="mzAffiliateUser" placeholder="affiliate username" />
                <input id="mzAffiliateCode" placeholder="ref code" />
                <input id="mzAffiliateRate" type="number" min="1" max="90" value="20" placeholder="commission %" />
                <button id="mzAffiliateCreate" class="secondary">Add Affiliate</button>
              </div>
              <div id="mzAffiliateList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Winback Campaigns</h3>
              <div class="row">
                <input id="mzWinbackDays" type="number" min="1" value="14" placeholder="inactive days" />
                <button id="mzBuildWinback" class="secondary">Build Winback Queue</button>
                <button id="mzGenerateWinbackDm" class="secondary">Generate Winback DM Batch</button>
              </div>
              <div id="mzWinbackQueue" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Usage-Based Upsell Triggers</h3>
              <div class="row">
                <button id="mzBuildUsageUpsell" class="secondary">Build Usage Upsell Queue</button>
                <button id="mzGenerateUsageDm" class="secondary">Generate Upsell DM Batch</button>
              </div>
              <div id="mzUsageUpsellList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Beta Expiry Engine</h3>
              <div class="row">
                <input id="mzBetaDays" type="number" min="1" value="91" placeholder="beta duration days" />
                <button id="mzBuildBetaExpiry" class="secondary">Build Beta Expiry Queue</button>
                <button id="mzApplyBetaTransition" class="secondary">Apply Beta -> Standard</button>
                <button id="mzGenerateExeBanner" class="secondary">Generate EXE Banner Text</button>
              </div>
              <div id="mzBetaExpiryList" class="list muted" style="margin-top:8px"></div>
              <textarea id="mzExeBannerText" placeholder="Generated EXE beta expiry banner text" style="margin-top:8px"></textarea>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Legal Acceptance Log</h3>
              <div class="row">
                <input id="mzLegalUser" placeholder="username" />
                <input id="mzLegalVersion" placeholder="terms version (beta-v1)" />
                <button id="mzLegalAccept" class="secondary">Log Acceptance</button>
              </div>
              <div id="mzLegalList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Promo Abuse Guardrails</h3>
              <div class="row">
                <input id="mzGuardMaxPromos" type="number" min="1" value="1" placeholder="max promos per user" />
                <input id="mzGuardCooldownDays" type="number" min="1" value="30" placeholder="cooldown days" />
                <input id="mzGuardMinPrice" type="number" min="1" value="6" placeholder="minimum allowed $/month" />
                <button id="mzSavePromoGuard" class="secondary">Save Guardrails</button>
                <button id="mzScanPromoAbuse" class="secondary">Scan Abuse</button>
              </div>
              <div id="mzPromoAbuseList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Chargeback Risk Queue</h3>
              <div class="row">
                <button id="mzBuildChargebackRisk" class="secondary">Build Risk Queue</button>
              </div>
              <div id="mzChargebackList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Refund Policy Templates</h3>
              <div class="row">
                <button id="mzGenerateRefundTemplates" class="secondary">Generate Templates</button>
              </div>
              <textarea id="mzRefundTemplates" placeholder="Refund policy templates for support agents" style="margin-top:8px"></textarea>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Sales Rep Leaderboard</h3>
              <div id="mzRepLeaderboard" class="list muted"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Discord Slash Command Kit</h3>
              <div class="row">
                <button id="mzGenerateDiscordCommands" class="secondary">Generate Slash Commands</button>
              </div>
              <textarea id="mzDiscordCommands" placeholder="Slash command spec/template for bot deployment" style="margin-top:8px"></textarea>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>SLA Routing Priority</h3>
              <div class="row">
                <input id="mzSlaUser" placeholder="username" />
                <select id="mzSlaTier">
                  <option value="standard">standard</option>
                  <option value="priority">priority</option>
                  <option value="elite">elite</option>
                </select>
                <button id="mzSetSlaPriority" class="secondary">Set Priority</button>
              </div>
              <div id="mzSlaPriorityList" class="list muted" style="margin-top:8px"></div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Weekly Business Report</h3>
              <div class="row">
                <button id="mzGenerateWeeklyReport" class="secondary">Generate Weekly Report</button>
              </div>
              <textarea id="mzWeeklyReport" placeholder="Weekly business report (MRR/churn/failures/upsells)" style="margin-top:8px"></textarea>
            </div>
          </div>

          <div class="card" style="background:#0b1730; margin-top:10px">
            <h3>Billing API Catalog (Live Website Prices)</h3>
            <div class="muted">This section is linked to the website billing API. Updating here updates live checkout pricing.</div>
            <div class="row" style="margin-top:8px">
              <button id="mzBillingReload" class="secondary">Reload Live Billing</button>
              <span id="mzBillingStatus" class="muted">Not loaded yet.</span>
            </div>
            <div class="grid grid-2" style="margin-top:10px">
              <div>
                <h3>Plans</h3>
                <div class="row">
                  <select id="mzPlanTemplate">
                    <option value="">Template: select bundle</option>
                    <option value="starter_monthly">Starter Monthly</option>
                    <option value="competitive_monthly">Competitive Monthly</option>
                    <option value="elite_monthly">Elite Monthly</option>
                    <option value="weekly_gamer">Weekly Gamer Bundle</option>
                    <option value="monthly_gamer">Monthly Gamer Bundle</option>
                    <option value="yearly_gamer">Yearly Gamer Bundle</option>
                    <option value="duo_bundle">Duo Bundle (2 seats)</option>
                    <option value="squad_bundle">Squad Bundle (5 seats)</option>
                    <option value="elite_yearly">Elite Yearly</option>
                    <option value="quarterly_bundle">Quarterly Bundle (10% off)</option>
                    <option value="semiannual_bundle">Semiannual Bundle (15% off)</option>
                  </select>
                  <button id="mzApplyPlanTemplate" class="secondary">Apply Template</button>
                  <button id="mzPublishCorePlans" class="secondary">Publish Core Plans</button>
                  <button id="mzPublishCoreAddons" class="secondary">Publish Core Add-ons</button>
                  <button id="mzPublishRevenueCatalog" class="secondary">Publish Full Revenue Catalog</button>
                  <button id="mzPublishCompetitiveCatalog" class="secondary">Auto Publish Competitive Catalog</button>
                </div>
                <div class="row">
                  <input id="mzPlanCode" placeholder="code (e.g. weekly)" />
                  <input id="mzPlanName" placeholder="name" />
                  <input id="mzPlanAmountCents" type="number" min="1" placeholder="amount cents" />
                </div>
                <div class="row">
                  <input id="mzPlanStripePriceId" placeholder="stripe price id (price_...)" />
                  <select id="mzPlanInterval">
                    <option value="week">week</option>
                    <option value="month" selected>month</option>
                    <option value="year">year</option>
                    <option value="day">day</option>
                    <option value="one_time">one_time</option>
                  </select>
                  <input id="mzPlanEntitlementDays" type="number" min="1" value="30" placeholder="entitlement days" />
                </div>
                <div class="row">
                  <input id="mzPlanCurrency" value="USD" placeholder="currency" />
                  <input id="mzPlanSortOrder" type="number" value="100" placeholder="sort order" />
                  <select id="mzPlanEnabled">
                    <option value="true" selected>enabled</option>
                    <option value="false">disabled</option>
                  </select>
                </div>
                <textarea id="mzPlanDescription" placeholder="plan description"></textarea>
                <div class="row" style="margin-top:8px">
                  <button id="mzPlanSave" class="secondary">Save Plan</button>
                  <button id="mzPlanDelete" class="danger">Delete Plan</button>
                </div>
                <div id="mzPlansList" class="list muted" style="margin-top:8px">No plans loaded.</div>
              </div>
              <div>
                <h3>Add-ons</h3>
                <div class="row">
                  <select id="mzAddonTemplate">
                    <option value="">Template: select add-on</option>
                    <option value="anti_ddos">Anti-DDoS Shield</option>
                    <option value="premium_presets">Premium Game Presets</option>
                    <option value="priority_support">Priority Support</option>
                    <option value="stream_mode">Stream Mode Route</option>
                    <option value="dedicated_ip">Dedicated Gaming IP</option>
                    <option value="instant_swap">Instant Server Swap</option>
                    <option value="team_dashboard">Team Dashboard Access</option>
                    <option value="tournament_priority">Tournament Priority Routing</option>
                    <option value="advanced_analytics">Advanced Match Analytics</option>
                    <option value="geo_unlock">Geo Unlock Routes</option>
                    <option value="hotspot_mode">Hotspot Mode</option>
                    <option value="anti_spike_guard">Anti-Spike Guard</option>
                    <option value="scrim_optimizer">Scrim Optimizer</option>
                    <option value="vpn_failover_plus">VPN Failover+</option>
                    <option value="instant_support_line">Instant Support Line</option>
                    <option value="adblock_streaming">Ad Block + Streaming Shield</option>
                  </select>
                  <button id="mzApplyAddonTemplate" class="secondary">Apply Add-on Template</button>
                </div>
                <div class="row">
                  <input id="mzAddonCode" placeholder="code (e.g. anti_ddos)" />
                  <input id="mzAddonName" placeholder="name" />
                  <input id="mzAddonAmountCents" type="number" min="1" placeholder="amount cents" />
                </div>
                <div class="row">
                  <input id="mzAddonStripePriceId" placeholder="stripe price id (price_...)" />
                  <input id="mzAddonMaxQuantity" type="number" min="1" max="50" value="1" placeholder="max quantity" />
                  <input id="mzAddonSortOrder" type="number" value="100" placeholder="sort order" />
                </div>
                <div class="row">
                  <input id="mzAddonCurrency" value="USD" placeholder="currency" />
                  <select id="mzAddonEnabled">
                    <option value="true" selected>enabled</option>
                    <option value="false">disabled</option>
                  </select>
                </div>
                <textarea id="mzAddonDescription" placeholder="add-on description"></textarea>
                <div class="row" style="margin-top:8px">
                  <button id="mzAddonSave" class="secondary">Save Add-on</button>
                  <button id="mzAddonDelete" class="danger">Delete Add-on</button>
                </div>
                <div id="mzAddonsList" class="list muted" style="margin-top:8px">No add-ons loaded.</div>
              </div>
            </div>
            <div style="margin-top:10px">
              <h3>Cash App Review Queue</h3>
              <div class="row">
                <button id="mzReviewsReload" class="secondary">Reload Review Requests</button>
                <span class="muted">Approve to activate subscription manually after payment verification.</span>
              </div>
              <div id="mzReviewList" class="list muted" style="margin-top:8px">No review requests loaded.</div>
            </div>
          </div>

          <details class="card" style="background:#0b1730; margin-top:10px">
            <summary><strong>Advanced Monetization Settings</strong></summary>
            <div class="grid grid-2" style="margin-top:8px">
              <div>
                <h3>Raw JSON (pricing)</h3>
                <textarea id="mzTiers" placeholder='{"Starter":19,"Competitive":39,"Elite":79}'></textarea>
                <textarea id="mzAddons" placeholder='{"anti_ddos":20,"premium_presets":12,"priority_support":15}'></textarea>
                <textarea id="mzBundles" placeholder='{"monthly":39,"quarterly":99,"yearly":349}'></textarea>
                <div class="row" style="margin-top:8px"><button id="mzSavePricing" class="secondary">Save Raw Pricing JSON</button></div>
              </div>
              <div>
                <h3>Team/SLA/Triggers</h3>
                <textarea id="mzTeamPack" placeholder='{"name":"Clan Pack","seats":[3,5,10],"basePricePerSeat":29}'></textarea>
                <textarea id="mzSla" placeholder='{"standard":"24h","priority":"4h","elite":"1h"}'></textarea>
                <textarea id="mzTriggers" placeholder='{"beforeExpiryDays":7,"afterSupportWin":true,"highUsageEvents":20}'></textarea>
                <div class="row" style="margin-top:8px"><button id="mzSaveOffers" class="secondary">Save Advanced Settings</button></div>
              </div>
            </div>
          </details>
        </section>

        <section id="tab-security" class="section card">
          <h2>Device/Session Security</h2>
          <div class="row">
            <select id="securityUser"><option value="">(select user)</option></select>
            <button id="loadSecurity" class="secondary">Load Devices/Sessions</button>
            <button id="revokeAllAccess" class="danger">Revoke All Access</button>
            <button id="deleteSecurityUser" class="danger">Delete User</button>
          </div>
          <div class="split" style="margin-top:10px">
            <div>
              <h3>Devices</h3>
              <div id="devicesList" class="list muted">Select a user.</div>
            </div>
            <div>
              <h3>Sessions</h3>
              <div id="sessionsList" class="list muted">Select a user.</div>
            </div>
          </div>
          <div style="margin-top:10px">
            <h3>User Timeline</h3>
            <div id="userTimeline" class="list muted">Select a user.</div>
          </div>
        </section>

        <section id="tab-fleet" class="section card">
          <h2>Server Fleet</h2>
          <div class="muted">Node health, maintenance/drain mode, and metadata updates.</div>
          <div id="fleetTableWrap" style="margin-top:10px"></div>
          <div class="split" style="margin-top:10px">
            <div>
              <h3>Top Impacted Users (Telemetry)</h3>
              <div id="fleetImpactUsers" class="list muted">No telemetry yet.</div>
            </div>
            <div>
              <h3>Routing Recommendations</h3>
              <div id="fleetRecommendations" class="list muted">No recommendations yet.</div>
            </div>
          </div>
        </section>

        <section id="tab-audit" class="section card">
          <h2>Audit & Compliance</h2>
          <div class="row">
            <button id="exportAuditJson" class="secondary">Export Audit JSON</button>
            <button id="exportAuditCsv" class="secondary">Export Audit CSV</button>
            <button id="exportSignedDigest" class="secondary">Generate Signed Digest</button>
          </div>
          <div class="split" style="margin-top:10px">
            <div>
              <h3>Recent Audit</h3>
              <div id="auditList" class="list muted">No data.</div>
            </div>
            <div>
              <h3>Permission Matrix</h3>
              <textarea id="permissionMatrixBox" placeholder='{"admin":["all"],"support":["ticket_*"],"billing":["subscription_*"]}'></textarea>
              <div class="row" style="margin-top:8px"><button id="savePermMatrix" class="secondary">Save Matrix</button></div>
            </div>
          </div>
          <div class="grid grid-2" style="margin-top:10px">
            <div class="card" style="background:#0b1730">
              <h3>Enterprise Access Policy</h3>
              <div class="row">
                <input id="entOwnerUsers" placeholder="owner usernames CSV (example: dustin,wyatt)" />
                <select id="entRequireApprovals">
                  <option value="yes">Approvals: required</option>
                  <option value="no">Approvals: optional</option>
                </select>
                <select id="entRequireReason">
                  <option value="yes">Reason required</option>
                  <option value="no">Reason optional</option>
                </select>
              </div>
              <textarea id="entApprovalMatrix" placeholder='{"users.delete":2,"ops.restore":2,"users.revoke_all":2,"servers.bootstrap":1,"pricing.publish":1,"secrets.rotate":2}'></textarea>
              <div class="row"><button id="entSavePolicy" class="secondary">Save Access Policy</button></div>
            </div>
            <div class="card" style="background:#0b1730">
              <h3>Approval Queue</h3>
              <div id="entApprovals" class="list muted">No pending approvals.</div>
            </div>
            <div class="card" style="background:#0b1730">
              <h3>Immutable Audit Chain</h3>
              <div class="muted">Append-only local chain for admin actions with previous-hash linkage.</div>
              <div id="entImmutableAudit" class="list muted" style="margin-top:8px"></div>
              <div class="row" style="margin-top:8px">
                <button id="entExportImmutable" class="secondary">Export Immutable Chain JSON</button>
              </div>
            </div>
            <div class="card" style="background:#0b1730">
              <h3>Security Baseline</h3>
              <div class="row">
                <input id="entMfaRoles" placeholder="MFA roles CSV (admin,operator)" />
                <input id="entSessionTimeout" type="number" min="5" max="720" placeholder="session timeout min" />
                <input id="entRateLimit" type="number" min="5" max="1000" placeholder="rate limit req/min" />
              </div>
              <div class="row">
                <select id="entTrustedDevices">
                  <option value="no">Trusted devices: optional</option>
                  <option value="yes">Trusted devices: required</option>
                </select>
                <input id="entIpAllowlist" placeholder="admin IP allowlist CSV (optional)" />
                <button id="entSaveSecurity" class="secondary">Save Security Baseline</button>
              </div>
            </div>
            <div class="card" style="background:#0b1730">
              <h3>Monitoring & Alerts</h3>
              <div class="row">
                <input id="entApiLatencyWarn" type="number" min="50" max="10000" placeholder="API latency warn ms" />
                <input id="entErrorRateWarn" type="number" min="1" max="100" placeholder="error-rate warn %" />
                <input id="entAlertChannel" placeholder="alert channel (Discord)" />
              </div>
              <div class="row">
                <select id="entNotifyLoginFail">
                  <option value="yes">Notify on login failures</option>
                  <option value="no">Do not notify login failures</option>
                </select>
                <button id="entSaveMonitoring" class="secondary">Save Monitoring</button>
              </div>
            </div>
            <div class="card" style="background:#0b1730">
              <h3>Backup, Governance, Secrets</h3>
              <div class="row">
                <input id="entBackupHourUtc" type="number" min="0" max="23" placeholder="backup hour UTC" />
                <input id="entBackupRetention" type="number" min="1" max="3650" placeholder="retention days" />
                <input id="entRestoreDrillDays" type="number" min="1" max="365" placeholder="restore drill cadence days" />
              </div>
              <div class="row">
                <input id="entSecretsRotationDays" type="number" min="1" max="365" placeholder="secret rotation days" />
                <select id="entRequireTicket">
                  <option value="yes">Change ticket required</option>
                  <option value="no">Ticket optional</option>
                </select>
                <select id="entRequirePeerReview">
                  <option value="yes">Peer review required</option>
                  <option value="no">Peer review optional</option>
                </select>
              </div>
              <div class="row">
                <button id="entSaveOperations" class="secondary">Save Ops Governance</button>
                <button id="entRotateSecrets" class="danger">Mark Secrets Rotated</button>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-runbooks" class="section card">
          <h2>Runbooks & Break Glass</h2>
          <div class="split">
            <div>
              <h3>Runbooks</h3>
              <div id="runbookList" class="list muted"></div>
              <input id="runbookTitle" placeholder="runbook title" style="width:100%;margin-top:8px" />
              <textarea id="runbookBody" placeholder="runbook steps"></textarea>
              <div class="row"><button id="addRunbook" class="secondary">Add / Update Runbook</button></div>
            </div>
            <div>
              <h3>Break Glass Owner Recovery</h3>
              <input id="breakGlassOwner" placeholder="owner account" style="width:100%" />
              <textarea id="breakGlassSteps" placeholder="recovery steps"></textarea>
              <div class="row"><button id="saveBreakGlass" class="secondary">Save Break Glass</button></div>
              <div class="muted" style="margin-top:8px">Script available on VPS: <code>/opt/wireguard/frenzynet-control-plane/scripts/break-glass-admin.sh</code></div>
            </div>
          </div>
        </section>

        <section id="tab-provisioning" class="section card">
          <h2>Provisioning Hub</h2>
          <div class="muted">Simplified flow: quick tasks up top, advanced controls collapsed below.</div>
          <div class="grid" style="margin-top:10px">
            <div class="card" style="background:#0b1730">
              <h3>Quick: Bootstrap New Node</h3>
              <div class="row">
                <input id="pvNodeIp" placeholder="node ip" />
                <input id="pvNodeUser" placeholder="ssh user (root/ubuntu)" />
                <input id="pvNodePass" type="password" placeholder="ssh password" autocomplete="new-password" />
                <select id="pvNodeType">
                  <option value="connection-node">connection-node</option>
                  <option value="anti-ddos">anti-ddos</option>
                  <option value="database">database</option>
                </select>
                <button id="pvBootstrapNode" class="secondary">Bootstrap Node</button>
              </div>
              <div class="row" style="margin-top:8px">
                <input id="pvServerName" placeholder="optional server name" />
                <input id="pvServerRegion" placeholder="region (default global)" />
                <input id="pvServerIp" placeholder="public ip (optional)" />
              </div>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>Quick: Create User</h3>
              <div class="row">
                <input id="pvNewUser" placeholder="username" />
                <input id="pvNewPass" placeholder="temporary password" />
                <select id="pvPlan"><option value="standard">standard</option><option value="premium">premium</option></select>
                <select id="pvChannel"><option value="stable">stable</option><option value="beta">beta</option><option value="auto">auto</option></select>
                <button id="pvCreateUser" class="secondary">Create User</button>
              </div>
              <textarea id="pvProfiles" placeholder="optional: allowed profiles CSV"></textarea>
            </div>

            <div class="card" style="background:#0b1730">
              <h3>User Directory (Edit/Delete)</h3>
              <div class="row">
                <input id="pvUserSearch" placeholder="search username/role/plan/channel" />
                <button id="pvUserSearchClear" class="secondary">Clear</button>
              </div>
              <div id="pvUserManagerList" class="list muted" style="margin-top:8px">No users loaded.</div>
              <div class="muted" style="margin-top:8px">Edit loads the user into advanced controls below. Delete permanently removes the account.</div>
            </div>

            <details class="card" style="background:#0b1730">
              <summary><strong>Advanced: User Access & Identity</strong></summary>
              <div class="row" style="margin-top:8px">
                <select id="pvUserTarget"><option value="">(select user)</option></select>
                <select id="pvRole"><option value="user">user</option><option value="operator">operator</option><option value="admin">admin</option></select>
                <button id="pvSetRole" class="secondary">Set Role</button>
              </div>
              <div class="row">
                <input id="pvSetPass" placeholder="new password" />
                <button id="pvSetPassword" class="secondary">Set Password</button>
                <button id="pvForceReset" class="secondary">Force Reset</button>
              </div>
              <div class="row">
                <select id="pvSetPlan"><option value="standard">standard</option><option value="premium">premium</option></select>
                <button id="pvApplyPlan" class="secondary">Set Plan</button>
                <select id="pvSetChannel"><option value="stable">stable</option><option value="beta">beta</option><option value="auto">auto</option></select>
                <button id="pvApplyChannel" class="secondary">Set Channel</button>
              </div>
              <div class="row">
                <input id="pvSubscriptionExpiry" placeholder="subscription expiry ISO (optional)" />
                <input id="pvSubscriptionNote" placeholder="subscription note" />
                <button id="pvSetSubscription" class="secondary">Set Subscription</button>
              </div>
              <div class="row">
                <button id="pvLockUser" class="secondary">Lock 60m</button>
                <button id="pvUnlockUser" class="secondary">Unlock</button>
                <button id="pvDeleteUser" class="danger">Delete User</button>
              </div>
            </details>

            <details class="card" style="background:#0b1730">
              <summary><strong>Advanced: Profile Management</strong></summary>
              <div class="row" style="margin-top:8px">
                <input id="pvProfileName" placeholder="profile.conf" />
                <select id="pvProfileTier"><option value="standard">standard</option><option value="premium">premium</option></select>
                <input id="pvProfileRegion" placeholder="region (us-east)" />
                <input id="pvProfilePool" placeholder="server pool" />
              </div>
              <textarea id="pvProfileConfig" placeholder="full WireGuard config text for new profile"></textarea>
              <div class="row">
                <button id="pvCreateProfile" class="secondary">Create Profile</button>
                <button id="pvSetProfileTier" class="secondary">Set Tier</button>
                <button id="pvSetProfileMeta" class="secondary">Set Region/Pool</button>
              </div>
            </details>

            <details class="card" style="background:#0b1730">
              <summary><strong>Advanced: Server Metadata & Enroll Token</strong></summary>
              <div class="row" style="margin-top:8px">
                <input id="pvServerHost" placeholder="host/domain" />
                <input id="pvServerPool" placeholder="server pool" />
                <select id="pvServerStatus"><option value="active">active</option><option value="degraded">degraded</option><option value="maintenance">maintenance</option><option value="offline">offline</option></select>
                <select id="pvServerTier"><option value="standard">standard</option><option value="premium">premium</option></select>
              </div>
              <div class="row">
                <button id="pvCreateServer" class="secondary">Create Server</button>
                <button id="pvUpdateServer" class="secondary">Update Server</button>
                <button id="pvEnrollToken" class="secondary">Generate Enroll Token</button>
              </div>
              <textarea id="pvServerOutput" placeholder="enroll token / bootstrap output" readonly></textarea>
            </details>
          </div>
        </section>

        <section id="tab-actions" class="section card">
          <h2>Quick Actions</h2>
          <div class="grid grid-2">
            <div class="card" style="background:#0b1730">
              <h3>User Ops</h3>
              <div class="row">
                <select id="quickUser"><option value="">(select user)</option></select>
                <button id="qLock" class="secondary">Lock 60m</button>
                <button id="qUnlock" class="secondary">Unlock</button>
                <button id="qReset" class="secondary">Force Reset</button>
              </div>
            </div>
            <div class="card" style="background:#0b1730">
              <h3>Platform Ops</h3>
              <div class="row">
                <button id="qBackup" class="secondary">Backup Now</button>
                <button id="qRestore" class="danger">Queue Restore Latest</button>
              </div>
              <div id="backupList" class="list muted" style="margin-top:8px;max-height:170px"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

<script>
(() => {
  const API_BASE_CANDIDATES = [
    'https://api.frenzynets.com',
    'https://frenzynets.com/api/frenzynet',
    '/api/frenzynet',
    ''
  ];
  let API_BASE = 'https://api.frenzynets.com';
  let token = '';
  let csrfToken = '';
  let currentUser = '';
  let currentRole = 'admin';
  let state = { userMeta:{}, presetMeta:{}, runbooks:[], permissionMatrix:{}, breakGlass:{owner:'',steps:'',lastUpdatedAt:null}, monetization:{}, enterprise:{} };
  let users = [], profiles = [], servers = [], audits = [], selfHeals = [], backups = [], tickets = [], telemetry = [], sys = {};
  let siteConfig = {};
  let billingSubscriptions = [], billingPayments = [];
  let billingPlans = [], billingAddons = [];
  let billingReviewRequests = [];
  let referralQueue = [];

  const presetCatalog = [
    'cod','cod_ranked_advanced','cod_premium','cod_ddos_premium','cod_ultra_elite',
    'fortnite_ranked_standard','fortnite_ranked_premium','apex_ranked_standard','apex_ranked_premium',
    'valorant_ranked_standard','valorant_ranked_premium','cs2_faceit_standard','cs2_faceit_premium',
    'r6_ranked_standard','r6_ranked_premium','rocket_ranked_standard','overwatch_ranked_standard',
    'lol_ranked_standard','dota_ranked_standard','pubg_ranked_standard','browsing','browsing_premium'
  ];

  const byId = (id) => document.getElementById(id);
  const setStatus = (msg, ok=true) => {
    const el = byId('globalStatus');
    el.textContent = msg;
    el.className = 'status ' + (ok ? 'ok' : 'bad');
  };
  const esc = (v) => String(v ?? '').replace(/[<>&]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]));
  const nowIso = () => new Date().toISOString();
  const isoDate = (v) => v ? new Date(v).toISOString().slice(0,10) : '';
  const isoToLocalInput = (v) => {
    try {
      if (!v) return '';
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return '';
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    } catch {
      return '';
    }
  };
  const localInputToIso = (v) => {
    try {
      if (!v) return '';
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return '';
      return d.toISOString();
    } catch {
      return '';
    }
  };
  const csv = (v) => String(v || '').split(',').map(x => x.trim()).filter(Boolean);
  const toObj = (txt, fallback={}) => { try { const j = JSON.parse(txt || '{}'); return (j && typeof j === 'object') ? j : fallback; } catch { return fallback; } };
  function pricingBenchmarks() {
    const peers = { nord: 12.99, pia: 11.95, express: 12.99 };
    const lowest = Math.min(peers.nord, peers.pia, peers.express);
    const undercut = 2;
    const maxCompetitive = Math.max(4, Math.floor(lowest - undercut));
    return { peers, lowest, undercut, maxCompetitive };
  }
  function enforceCompetitiveTarget(target) {
    const b = pricingBenchmarks();
    const requested = Math.max(4, Number(target || b.maxCompetitive));
    const enforced = Math.min(requested, b.maxCompetitive);
    return { requested, enforced, b };
  }
  function buildSimplePricing(strategy, compTarget) {
    const { enforced: comp } = enforceCompetitiveTarget(compTarget);
    if (strategy === 'growth') {
      return {
        tiers: { Starter: Math.max(6, Math.round(comp * 0.72)), Competitive: Math.round(comp), Elite: Math.round(comp * 1.45) },
        addons: { anti_ddos: Math.max(3, Math.round(comp * 0.35)), premium_presets: Math.max(2, Math.round(comp * 0.2)), priority_support: Math.max(2, Math.round(comp * 0.22)) }
      };
    }
    if (strategy === 'value') {
      return {
        tiers: { Starter: Math.max(4, Math.round(comp * 0.66)), Competitive: Math.round(comp), Elite: Math.max(comp + 3, Math.round(comp * 1.35)) },
        addons: { anti_ddos: Math.max(2, Math.round(comp * 0.3)), premium_presets: Math.max(2, Math.round(comp * 0.16)), priority_support: Math.max(2, Math.round(comp * 0.2)) }
      };
    }
    return {
      tiers: { Starter: Math.max(5, Math.round(comp * 0.7)), Competitive: Math.round(comp), Elite: Math.round(comp * 1.4) },
      addons: { anti_ddos: Math.max(3, Math.round(comp * 0.33)), premium_presets: Math.max(2, Math.round(comp * 0.2)), priority_support: Math.max(2, Math.round(comp * 0.22)) }
    };
  }

  const BILLING_PLAN_TEMPLATES = {
    starter_monthly: { code:'starter', name:'Starter Monthly', description:'Entry monthly plan for casual play and browsing.', amountCents:799, currency:'USD', stripePriceId:'', interval:'month', entitlementDays:30, sortOrder:5, enabled:true },
    competitive_monthly: { code:'competitive', name:'Competitive Monthly', description:'Main ranked gaming plan with optimized low-jitter routes.', amountCents:999, currency:'USD', stripePriceId:'', interval:'month', entitlementDays:30, sortOrder:8, enabled:true },
    elite_monthly: { code:'elite', name:'Elite Monthly', description:'Premium monthly performance tier with priority treatment.', amountCents:1499, currency:'USD', stripePriceId:'', interval:'month', entitlementDays:30, sortOrder:9, enabled:true },
    weekly_gamer: { code:'weekly', name:'Weekly Gamer', description:'7-day competitive gaming access with low-latency routing and fast server rotation.', amountCents:500, currency:'USD', stripePriceId:'price_1T4ZwFFfWQjiEsmV9O49KuNA', interval:'week', entitlementDays:7, sortOrder:10, enabled:true },
    monthly_gamer: { code:'monthly', name:'Monthly Gamer', description:'30-day gaming plan with optimized routes, anti-jitter focus, and performance tuning.', amountCents:1000, currency:'USD', stripePriceId:'price_1T4Zw0FfWQjiEsmVn5u52K7H', interval:'month', entitlementDays:30, sortOrder:20, enabled:true },
    yearly_gamer: { code:'yearly', name:'Yearly Gamer', description:'Best value annual gamer plan with premium network access and long-term savings.', amountCents:10000, currency:'USD', stripePriceId:'price_1T4ZvZFfWQjiEsmVceEDUJT8', interval:'year', entitlementDays:365, sortOrder:30, enabled:true },
    duo_bundle: { code:'duo', name:'Duo Bundle', description:'Two-seat shared plan for gaming duos at lower per-seat cost.', amountCents:1799, currency:'USD', stripePriceId:'', interval:'month', entitlementDays:30, sortOrder:35, enabled:true },
    squad_bundle: { code:'squad', name:'Squad Bundle', description:'Five-seat team package for clans and friend groups.', amountCents:2999, currency:'USD', stripePriceId:'', interval:'month', entitlementDays:30, sortOrder:40, enabled:true },
    elite_yearly: { code:'elite_yearly', name:'Elite Yearly', description:'Annual premium tier with strongest value and upsell margin.', amountCents:11999, currency:'USD', stripePriceId:'', interval:'year', entitlementDays:365, sortOrder:45, enabled:true },
    quarterly_bundle: { code:'quarterly', name:'Quarterly Bundle', description:'3-month prepaid bundle at 10% discount versus monthly pricing.', amountCents:2700, currency:'USD', stripePriceId:'', interval:'month', entitlementDays:90, sortOrder:50, enabled:true },
    semiannual_bundle: { code:'semiannual', name:'Semiannual Bundle', description:'6-month prepaid bundle at 15% discount versus monthly pricing.', amountCents:5100, currency:'USD', stripePriceId:'', interval:'month', entitlementDays:180, sortOrder:55, enabled:true }
  };

  // Competitive baseline (Feb 25, 2026): Nord 12.99, Express ~12.99, PIA 11.95.
  // FrenzyNet stays below major monthly retail pricing.
  const BILLING_ADDON_TEMPLATES = {
    anti_ddos: { code:'anti_ddos', name:'Anti-DDoS Shield', description:'Extra attack filtering for competitive sessions and tournaments.', amountCents:299, currency:'USD', maxQuantity:1, sortOrder:10, enabled:true },
    premium_presets: { code:'premium_presets', name:'Premium Game Presets', description:'Advanced game-specific route presets tuned for ranked play.', amountCents:199, currency:'USD', maxQuantity:1, sortOrder:20, enabled:true },
    priority_support: { code:'priority_support', name:'Priority Support', description:'Faster support queue and expedited troubleshooting response.', amountCents:249, currency:'USD', maxQuantity:1, sortOrder:30, enabled:true },
    stream_mode: { code:'stream_mode', name:'Stream Mode Route', description:'Routing profile optimized for stream stability while gaming.', amountCents:149, currency:'USD', maxQuantity:1, sortOrder:40, enabled:true },
    dedicated_ip: { code:'dedicated_ip', name:'Dedicated Gaming IP', description:'Static dedicated egress IP for consistent endpoint identity.', amountCents:399, currency:'USD', maxQuantity:1, sortOrder:50, enabled:true },
    instant_swap: { code:'instant_swap', name:'Instant Server Swap', description:'Fast route switching for hard lobbies and match recovery.', amountCents:199, currency:'USD', maxQuantity:1, sortOrder:60, enabled:true },
    team_dashboard: { code:'team_dashboard', name:'Team Dashboard Access', description:'Per-team control dashboard and squad-level profile controls.', amountCents:499, currency:'USD', maxQuantity:3, sortOrder:70, enabled:true },
    tournament_priority: { code:'tournament_priority', name:'Tournament Priority Routing', description:'Priority routing queue for tournament or scrim windows.', amountCents:599, currency:'USD', maxQuantity:1, sortOrder:80, enabled:true },
    advanced_analytics: { code:'advanced_analytics', name:'Advanced Match Analytics', description:'Extended ping/jitter/loss analytics and trend reporting.', amountCents:299, currency:'USD', maxQuantity:1, sortOrder:90, enabled:true },
    geo_unlock: { code:'geo_unlock', name:'Geo Unlock Routes', description:'Unlock additional route regions for matchmaking and content.', amountCents:199, currency:'USD', maxQuantity:1, sortOrder:95, enabled:true },
    hotspot_mode: { code:'hotspot_mode', name:'Hotspot Mode', description:'Secure mobile hotspot traffic through FrenzyNet routes.', amountCents:149, currency:'USD', maxQuantity:1, sortOrder:100, enabled:true },
    anti_spike_guard: { code:'anti_spike_guard', name:'Anti-Spike Guard', description:'Extra route smoothing to reduce sudden ping spikes.', amountCents:249, currency:'USD', maxQuantity:1, sortOrder:105, enabled:true },
    scrim_optimizer: { code:'scrim_optimizer', name:'Scrim Optimizer', description:'Route set optimized for private scrims and team practice.', amountCents:349, currency:'USD', maxQuantity:1, sortOrder:110, enabled:true },
    vpn_failover_plus: { code:'vpn_failover_plus', name:'VPN Failover+', description:'Faster automatic failover across available relay paths.', amountCents:299, currency:'USD', maxQuantity:1, sortOrder:115, enabled:true },
    instant_support_line: { code:'instant_support_line', name:'Instant Support Line', description:'Direct priority contact lane for urgent match issues.', amountCents:499, currency:'USD', maxQuantity:1, sortOrder:120, enabled:true },
    adblock_streaming: { code:'adblock_streaming', name:'Ad Block + Streaming Shield', description:'Network-level ad and tracker filtering for YouTube, movie/streaming, and web sessions. Some platform ads may still appear based on service enforcement.', amountCents:299, currency:'USD', maxQuantity:1, sortOrder:125, enabled:true }
  };

  const ADDON_TIER_MULTIPLIERS = { basic: 0.9, popular: 1.0, premium: 1.3 };
  const BETA_INTRO_MONTHS = 3;
  const BETA_INTRO_NOTE = `Beta intro pricing: first ${BETA_INTRO_MONTHS} months only.`;
  function withBetaIntro(desc) {
    const raw = String(desc || '').trim();
    return raw ? `${raw} ${BETA_INTRO_NOTE}` : BETA_INTRO_NOTE;
  }
  function tierLabel(tier) {
    const t = String(tier || '').toLowerCase();
    if (t === 'basic') return 'Basic';
    if (t === 'premium') return 'Premium';
    return 'Popular';
  }

  function renderSimplePriceSummary() {
    const starter = Number(byId('mzStarter')?.value || 0);
    const comp = Number(byId('mzCompetitive')?.value || 0);
    const elite = Number(byId('mzElite')?.value || 0);
    const ddos = Number(byId('mzAntiDdos')?.value || 0);
    const preset = Number(byId('mzPresetAddon')?.value || 0);
    const prio = Number(byId('mzPriorityAddon')?.value || 0);
    const el = byId('mzPriceSummary');
    if (!el) return;
    el.innerHTML = `
      <div class="item"><strong>Starter:</strong> $${starter}/month</div>
      <div class="item"><strong>Competitive:</strong> $${comp}/month</div>
      <div class="item"><strong>Elite:</strong> $${elite}/month</div>
      <div class="item"><strong>Add-ons:</strong> Anti-DDoS +$${ddos}, Premium presets +$${preset}, Priority support +$${prio}</div>
      <div class="item"><strong>Beta:</strong> ${BETA_INTRO_NOTE}</div>
    `;

    const ex = byId('mzPriceExplain');
    if (!ex) return;
    const bench = pricingBenchmarks();
    const diff = Math.abs(bench.lowest - comp).toFixed(2);
    const cheaperText = comp < bench.lowest
      ? `You are about $${diff}/month cheaper than the lowest major VPN monthly plan.`
      : `You are about $${diff}/month above the lowest major VPN monthly plan.`;
    ex.innerHTML = `
      <div class="item"><strong>Starter ($${starter})</strong>: Low-cost entry plan.</div>
      <div class="item"><strong>Competitive ($${comp})</strong>: Main gaming plan (most users pick this).</div>
      <div class="item"><strong>Elite ($${elite})</strong>: Premium plan for max performance/support.</div>
      <div class="item"><strong>Anti-DDoS (+$${ddos})</strong>: Extra match protection.</div>
      <div class="item"><strong>Premium Presets (+$${preset})</strong>: Advanced tuned game profiles.</div>
      <div class="item"><strong>Priority Support (+$${prio})</strong>: Faster response priority.</div>
      <div class="item"><strong>Price Compare (Feb 25, 2026)</strong>: Nord $${bench.peers.nord}, PIA $${bench.peers.pia}, Express Basic ~$${bench.peers.express} monthly. ${cheaperText}</div>
      <div class="item"><strong>Auto Rule</strong>: Competitive is capped at $${bench.maxCompetitive}/mo (at least $${bench.undercut} under the lowest major monthly plan).</div>
    `;
  }

  function billingCentsToDollarStr(cents) {
    const v = Number(cents || 0) / 100;
    return `$${v.toFixed(2)}`;
  }

  function fillPlanForm(item = null) {
    byId('mzPlanCode').value = item?.code || '';
    byId('mzPlanName').value = item?.name || '';
    byId('mzPlanAmountCents').value = Number(item?.amountCents || 0) || '';
    byId('mzPlanStripePriceId').value = item?.stripePriceId || '';
    byId('mzPlanInterval').value = item?.interval || 'month';
    byId('mzPlanEntitlementDays').value = Number(item?.entitlementDays || 30);
    byId('mzPlanCurrency').value = item?.currency || 'USD';
    byId('mzPlanSortOrder').value = Number(item?.sortOrder || 100);
    byId('mzPlanEnabled').value = String(Boolean(item ? item.enabled : true));
    byId('mzPlanDescription').value = item?.description || '';
  }

  function applyPlanTemplate(templateKey) {
    const t = BILLING_PLAN_TEMPLATES[String(templateKey || '').trim()];
    if (!t) return false;
    fillPlanForm(t);
    if (t.stripePriceId) byId('mzPlanStripePriceId').value = t.stripePriceId;
    byId('mzPlanStripePriceId').focus();
    return true;
  }

  function corePlanTemplates() {
    return ['weekly_gamer', 'monthly_gamer', 'yearly_gamer']
      .map(k => BILLING_PLAN_TEMPLATES[k])
      .filter(Boolean);
  }

  function fullPlanTemplates() {
    return ['starter_monthly','competitive_monthly','elite_monthly','weekly_gamer','monthly_gamer','yearly_gamer','duo_bundle','squad_bundle','elite_yearly','quarterly_bundle','semiannual_bundle']
      .map(k => BILLING_PLAN_TEMPLATES[k])
      .filter(Boolean);
  }

  function coreAddonTemplates() {
    return ['anti_ddos', 'premium_presets', 'priority_support']
      .map(k => BILLING_ADDON_TEMPLATES[k])
      .filter(Boolean);
  }

  function fullAddonTemplates() {
    return ['anti_ddos','premium_presets','priority_support','stream_mode','dedicated_ip','instant_swap','team_dashboard','tournament_priority','advanced_analytics','geo_unlock','hotspot_mode','anti_spike_guard','scrim_optimizer','vpn_failover_plus','instant_support_line']
      .map(k => BILLING_ADDON_TEMPLATES[k])
      .filter(Boolean);
  }

  function tieredAddonTemplates(tier) {
    const multiplier = Number(ADDON_TIER_MULTIPLIERS[String(tier || 'popular').toLowerCase()] || 1.0);
    return fullAddonTemplates().map(t => {
      const cents = Math.max(99, Math.round((Number(t.amountCents || 0) * multiplier) / 25) * 25);
      return Object.assign({}, t, { amountCents: cents });
    });
  }

  function fillAddonForm(item = null) {
    byId('mzAddonCode').value = item?.code || '';
    byId('mzAddonName').value = item?.name || '';
    byId('mzAddonAmountCents').value = Number(item?.amountCents || 0) || '';
    byId('mzAddonStripePriceId').value = item?.stripePriceId || '';
    byId('mzAddonMaxQuantity').value = Number(item?.maxQuantity || 1);
    byId('mzAddonSortOrder').value = Number(item?.sortOrder || 100);
    byId('mzAddonCurrency').value = item?.currency || 'USD';
    byId('mzAddonEnabled').value = String(Boolean(item ? item.enabled : true));
    byId('mzAddonDescription').value = item?.description || '';
  }

  function applyAddonTemplate(templateKey) {
    const t = BILLING_ADDON_TEMPLATES[String(templateKey || '').trim()];
    if (!t) return false;
    fillAddonForm(t);
    byId('mzAddonCode').focus();
    return true;
  }

  function plansForPricingSheet() {
    const fallback = fullPlanTemplates();
    if (!Array.isArray(billingPlans) || !billingPlans.length) return fallback;
    const byCode = new Map(billingPlans.map(x => [String(x.code || '').toLowerCase(), x]));
    const order = ['starter','competitive','elite','weekly','monthly','quarterly','semiannual','yearly','duo','squad','elite_yearly'];
    const out = [];
    order.forEach(code => {
      const row = byCode.get(code);
      if (row && row.enabled !== false) out.push(row);
    });
    return out.length ? out : fallback;
  }

  function buildDiscordPricingSheet(tier) {
    const t = String(tier || 'popular').toLowerCase();
    const plans = plansForPricingSheet();
    const addons = tieredAddonTemplates(t);
    const lines = [];
    lines.push(`FrenzyNet Price Sheet (${tierLabel(t)} Tier)`);
    lines.push(`Updated: ${new Date().toISOString()}`);
    lines.push(BETA_INTRO_NOTE);
    lines.push('');
    lines.push('Plans:');
    plans.forEach(p => {
      const amount = billingCentsToDollarStr(Number(p.amountCents || 0));
      lines.push(`- ${p.name || p.code}: ${amount}/${String(p.interval || 'month')}`);
    });
    lines.push('');
    lines.push(`Add-ons (${tierLabel(t)} retail recommendations):`);
    addons.forEach(a => {
      const amount = billingCentsToDollarStr(Number(a.amountCents || 0));
      lines.push(`- ${a.name}: +${amount}/month`);
    });
    lines.push('');
    lines.push('Referral offer: both users get bonus access days after first paid month.');
    lines.push('DM to order: choose plan + add-ons + device username.');
    return lines.join('\n');
  }

  function syncSimplePricingFromBillingCatalog() {
    const planByCode = new Map(billingPlans.map(x => [String(x.code || '').toLowerCase(), x]));
    const addonByCode = new Map(billingAddons.map(x => [String(x.code || '').toLowerCase(), x]));
    const starter = planByCode.get('starter');
    const competitive = planByCode.get('competitive') || planByCode.get('monthly');
    const elite = planByCode.get('elite') || planByCode.get('yearly');
    const antiDdos = addonByCode.get('anti_ddos');
    const premiumPresets = addonByCode.get('premium_presets');
    const prioritySupport = addonByCode.get('priority_support');
    if (starter && byId('mzStarter')) byId('mzStarter').value = Math.round(Number(starter.amountCents || 0) / 100);
    if (competitive && byId('mzCompetitive')) byId('mzCompetitive').value = Math.round(Number(competitive.amountCents || 0) / 100);
    if (elite && byId('mzElite')) byId('mzElite').value = Math.round(Number(elite.amountCents || 0) / 100);
    if (antiDdos && byId('mzAntiDdos')) byId('mzAntiDdos').value = Math.round(Number(antiDdos.amountCents || 0) / 100);
    if (premiumPresets && byId('mzPresetAddon')) byId('mzPresetAddon').value = Math.round(Number(premiumPresets.amountCents || 0) / 100);
    if (prioritySupport && byId('mzPriorityAddon')) byId('mzPriorityAddon').value = Math.round(Number(prioritySupport.amountCents || 0) / 100);
    renderSimplePriceSummary();
  }

  function renderBillingCatalog() {
    const plansEl = byId('mzPlansList');
    const addonsEl = byId('mzAddonsList');
    const statusEl = byId('mzBillingStatus');
    if (!plansEl || !addonsEl || !statusEl) return;

    statusEl.textContent = `Loaded ${billingPlans.length} plan(s) and ${billingAddons.length} add-on(s) from live API.`;
    plansEl.innerHTML = billingPlans.length
      ? billingPlans.map(p => `<div class="item"><strong>${esc(p.code)}</strong> (${esc(p.name || '')})  ${esc(billingCentsToDollarStr(p.amountCents))}/${esc(p.interval || 'month')}  ${esc(p.currency || 'USD')}  ${p.enabled ? 'enabled' : 'disabled'}<div class="row" style="margin-top:6px"><button class="secondary" data-mz-plan="${esc(p.code)}">Load</button></div></div>`).join('')
      : '<div class="item muted">No plans configured.</div>';
    addonsEl.innerHTML = billingAddons.length
      ? billingAddons.map(a => `<div class="item"><strong>${esc(a.code)}</strong> (${esc(a.name || '')})  ${esc(billingCentsToDollarStr(a.amountCents))}  max qty ${esc(String(a.maxQuantity || 1))}  ${a.enabled ? 'enabled' : 'disabled'}<div class="row" style="margin-top:6px"><button class="secondary" data-mz-addon="${esc(a.code)}">Load</button></div></div>`).join('')
      : '<div class="item muted">No add-ons configured.</div>';

    document.querySelectorAll('[data-mz-plan]').forEach(btn => btn.onclick = () => {
      const code = String(btn.dataset.mzPlan || '').toLowerCase();
      const found = billingPlans.find(x => String(x.code || '').toLowerCase() === code);
      fillPlanForm(found || null);
    });
    document.querySelectorAll('[data-mz-addon]').forEach(btn => btn.onclick = () => {
      const code = String(btn.dataset.mzAddon || '').toLowerCase();
      const found = billingAddons.find(x => String(x.code || '').toLowerCase() === code);
      fillAddonForm(found || null);
    });
  }

  function renderBillingReviews() {
    const el = byId('mzReviewList');
    if (!el) return;
    el.innerHTML = billingReviewRequests.length
      ? billingReviewRequests.map(r => `<div class="item"><strong>${esc(r.username || '(unknown user)')}</strong>  ${esc(r.planCode || '')}  ${esc(billingCentsToDollarStr(r.amountCents))} ${esc(r.currency || 'USD')}  status ${esc(r.status || '')}<br><span class="muted">token: ${esc(r.checkoutToken || '')}  updated: ${esc(r.updatedAt || '')}</span><div class="row" style="margin-top:6px"><button class="secondary" data-review-approve="${esc(r.checkoutToken || '')}">Approve</button><button class="danger" data-review-reject="${esc(r.checkoutToken || '')}">Reject</button></div></div>`).join('')
      : '<div class="item muted">No pending review requests.</div>';
    document.querySelectorAll('[data-review-approve]').forEach(btn => btn.onclick = async () => {
      const checkoutToken = String(btn.dataset.reviewApprove || '').trim();
      const daysRaw = prompt('Entitlement days to grant after approval (default 30):', '30');
      const entitlementDays = Math.max(1, Number(daysRaw || 30));
      const note = prompt('Internal approval note (optional):', '') || '';
      await api('/api/admin/billing/review-request/decision', { method:'POST', body:JSON.stringify({ checkoutToken, decision:'approve', entitlementDays, note }) });
      await loadBillingReviewRequests(true);
      setStatus(`Approved Cash App request ${checkoutToken}`, true);
    });
    document.querySelectorAll('[data-review-reject]').forEach(btn => btn.onclick = async () => {
      const checkoutToken = String(btn.dataset.reviewReject || '').trim();
      const note = prompt('Reason for rejection:', '') || '';
      await api('/api/admin/billing/review-request/decision', { method:'POST', body:JSON.stringify({ checkoutToken, decision:'reject', note }) });
      await loadBillingReviewRequests(true);
      setStatus(`Rejected Cash App request ${checkoutToken}`, true);
    });
  }

  async function loadBillingReviewRequests(silent=false) {
    try {
      const d = await api('/api/admin/billing/review-requests?status=pending_review&limit=200');
      billingReviewRequests = Array.isArray(d.items) ? d.items : [];
      renderBillingReviews();
      if (!silent) setStatus(`Loaded ${billingReviewRequests.length} pending billing review request(s).`, true);
      return true;
    } catch (e) {
      if (!silent) setStatus('Billing review load failed: ' + e.message, false);
      return false;
    }
  }

  async function loadBillingCatalog(silent=false) {
    try {
      const [p, a] = await Promise.all([
        api('/api/admin/billing/plans'),
        api('/api/admin/billing/addons')
      ]);
      billingPlans = Array.isArray(p.plans) ? p.plans : [];
      billingAddons = Array.isArray(a.addons) ? a.addons : [];
      renderBillingCatalog();
      syncSimplePricingFromBillingCatalog();
      if (!silent) setStatus('Live billing catalog loaded', true);
      return true;
    } catch (e) {
      if (!silent) setStatus('Billing catalog load failed: ' + e.message, false);
      return false;
    }
  }

  function ensureStateDefaults() {
    if (!state || typeof state !== 'object') state = {};
    state.userMeta = state.userMeta || {};
    state.presetMeta = state.presetMeta || {};
    state.runbooks = Array.isArray(state.runbooks) ? state.runbooks : [];
    state.permissionMatrix = state.permissionMatrix || {};
    state.breakGlass = state.breakGlass || { owner:'', steps:'', lastUpdatedAt:null };
    const m = state.monetization || {};
    m.tiers = m.tiers || { Starter:6, Competitive:9, Elite:13 };
    m.addons = m.addons || {
      anti_ddos: 3,
      premium_presets: 2,
      priority_support: 2,
      stream_mode: 2,
      dedicated_ip: 4,
      instant_swap: 2
    };
    m.bundles = m.bundles || {
      weekly: 5,
      monthly: 10,
      yearly: 100,
      duo: 18,
      squad: 30
    };
    m.teamPack = m.teamPack || { name:'Clan Pack', seats:[3,5,10], basePricePerSeat:29, notes:'shared dashboard + pooled presets' };
    m.sla = m.sla || { standard:'24h', priority:'4h', elite:'1h' };
    m.triggers = m.triggers || { beforeExpiryDays:7, afterSupportWin:true, highUsageEvents:20 };
    m.referrals = Array.isArray(m.referrals) ? m.referrals : [];
    m.outcomeCopy = m.outcomeCopy || 'We sell ranked stability and protection outcomes, not generic VPN access.';
    m.renewalQueue = Array.isArray(m.renewalQueue) ? m.renewalQueue : [];
    m.addonTier = m.addonTier || 'popular';
    m.lastPricingSheet = m.lastPricingSheet || '';
    m.coupons = Array.isArray(m.coupons) ? m.coupons : [];
    m.checkoutLinks = Array.isArray(m.checkoutLinks) ? m.checkoutLinks : [];
    m.abTests = Array.isArray(m.abTests) ? m.abTests : [];
    m.affiliates = Array.isArray(m.affiliates) ? m.affiliates : [];
    m.churnQueue = Array.isArray(m.churnQueue) ? m.churnQueue : [];
    m.failedRecoveryQueue = Array.isArray(m.failedRecoveryQueue) ? m.failedRecoveryQueue : [];
    m.winbackQueue = Array.isArray(m.winbackQueue) ? m.winbackQueue : [];
    m.usageUpsellQueue = Array.isArray(m.usageUpsellQueue) ? m.usageUpsellQueue : [];
    m.betaTransition = m.betaTransition || { durationDays: 91, queue: [], lastAppliedAt: '' };
    m.legalAcceptances = Array.isArray(m.legalAcceptances) ? m.legalAcceptances : [];
    m.promoGuard = m.promoGuard || { maxPromosPerUser: 1, cooldownDays: 30, minMonthlyPrice: 6, flagged: [] };
    m.chargebackRiskQueue = Array.isArray(m.chargebackRiskQueue) ? m.chargebackRiskQueue : [];
    m.refundTemplates = m.refundTemplates || '';
    m.slaPriority = m.slaPriority || {};
    m.discordCommandKit = m.discordCommandKit || '';
    m.weeklyReport = m.weeklyReport || '';
    m.exeBannerText = m.exeBannerText || '';
    state.monetization = m;
    const w = state.website || {};
    w.hero = w.hero || { title:'Win More Fights. Lose Less Packets.', sub:'Low-jitter gaming VPN with self-heal routing.', ctaPrimary:'Start Subscription', ctaSecondary:'Join Discord Sales' };
    w.bannerSchedule = Array.isArray(w.bannerSchedule) ? w.bannerSchedule : [];
    w.trust = w.trust || { uptime:'99.95% uptime', users:'Active gamers', backup:'Encrypted backups' };
    w.seo = w.seo || { title:'FrenzyNets | Performance VPN', description:'Performance VPN for gaming.', ogImage:'', discordCard:'Performance VPN for ranked play.' };
    w.incident = w.incident || { mode:'off', text:'' };
    w.downloadGate = w.downloadGate || { dotnet:'required', wireguard:'required', admin:'required' };
    w.abTests = Array.isArray(w.abTests) ? w.abTests : [];
    w.funnel = w.funnel || { visits:0, billingClicks:0, checkouts:0 };
    w.proof = w.proof || {
      jitter: '22% lower jitter during ranked sessions.',
      loss: 'Up to 35% fewer packet loss spikes in peak hours.',
      recovery: 'Automatic failover in seconds when path quality drops.'
    };
    w.testimonials = Array.isArray(w.testimonials) && w.testimonials.length ? w.testimonials : [
      { user: '@dustin', role: 'Ranked COD', quote: 'Hit less jitter in prime-time lobbies and smoother gunfights.' },
      { user: '@wyatt', role: 'Tournament Player', quote: 'Route recovery saved matches when a node got unstable.' },
      { user: '@josh', role: 'Streamer', quote: 'Gaming and stream quality stayed stable with fewer spikes.' }
    ];
    w.capacity = w.capacity || { Starter:{ max:120 }, Competitive:{ max:90 }, Elite:{ max:60 } };
    w.changeLog = Array.isArray(w.changeLog) ? w.changeLog : [];
    w.releaseSnapshots = Array.isArray(w.releaseSnapshots) ? w.releaseSnapshots : [];
    state.website = w;
    const e = state.enterprise || {};
    e.ownerUsers = Array.isArray(e.ownerUsers) && e.ownerUsers.length ? e.ownerUsers : ['dustin'];
    e.requireApprovals = e.requireApprovals !== false;
    e.requireReason = e.requireReason !== false;
    e.approvalMatrix = e.approvalMatrix || {
      'users.delete': 2,
      'ops.restore': 2,
      'users.revoke_all': 2,
      'servers.bootstrap': 1,
      'pricing.publish': 1,
      'secrets.rotate': 2
    };
    e.pendingApprovals = Array.isArray(e.pendingApprovals) ? e.pendingApprovals : [];
    e.immutableAudit = Array.isArray(e.immutableAudit) ? e.immutableAudit : [];
    e.security = e.security || {
      mfaRequiredRoles: ['admin','operator'],
      sessionTimeoutMin: 45,
      ipAllowlist: '',
      trustedDevicesOnly: false,
      rateLimitPerMin: 60
    };
    e.monitoring = e.monitoring || {
      apiLatencyWarnMs: 500,
      errorRateWarnPct: 2,
      discordAlertChannel: '#ops-alerts',
      notifyOnLoginFailures: true
    };
    e.backups = e.backups || {
      dailyHourUtc: 2,
      retentionDays: 30,
      encrypted: true,
      testRestoreEveryDays: 14,
      lastRestoreDrillAt: ''
    };
    e.governance = e.governance || {
      stages: ['dev','canary','prod'],
      requireTicket: true,
      requirePeerReview: true
    };
    e.secrets = e.secrets || {
      rotationDays: 30,
      lastRotatedAt: '',
      nextRotationAt: ''
    };
    state.enterprise = e;
  }

  function simpleHash(input) {
    let h = 2166136261;
    const s = String(input ?? '');
    for (let i = 0; i < s.length; i++) {
      h ^= s.charCodeAt(i);
      h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
    }
    return (h >>> 0).toString(16).padStart(8, '0');
  }

  function isOwnerUser(username = currentUser) {
    ensureStateDefaults();
    const owners = (state.enterprise.ownerUsers || []).map(x => String(x).toLowerCase());
    return owners.includes(String(username || '').toLowerCase());
  }

  function appendImmutableAudit(eventType, detail, severity='info') {
    ensureStateDefaults();
    const list = state.enterprise.immutableAudit;
    const prev = list.length ? list[list.length - 1].hash : 'genesis';
    const payload = JSON.stringify({ eventType, detail, severity, actor: currentUser, role: currentRole, at: nowIso(), prev });
    const hash = simpleHash(prev + ':' + payload);
    list.push({ eventType, detail, severity, actor: currentUser, role: currentRole, at: nowIso(), prevHash: prev, hash });
    if (list.length > 2000) list.splice(0, list.length - 2000);
  }

  async function guardAction(actionKey, summary, options = {}) {
    ensureStateDefaults();
    if (options.ownerOnly && !isOwnerUser()) {
      appendImmutableAudit('guard_denied_owner_only', `${actionKey}: ${summary}`, 'warn');
      await savePanelState();
      setStatus(`Owner approval required for ${actionKey}.`, false);
      return false;
    }
    const requiresApproval = state.enterprise.requireApprovals && Number(state.enterprise.approvalMatrix?.[actionKey] || 0) > 0;
    if (requiresApproval && !isOwnerUser()) {
      if (options.allowQueue === false) {
        appendImmutableAudit('guard_denied_approval_required', `${actionKey}: ${summary}`, 'warn');
        await savePanelState();
        setStatus(`Approval required for ${actionKey}. Owner must execute this action.`, false);
        return false;
      }
      const reason = state.enterprise.requireReason ? (prompt(`Reason for ${summary}:`) || '').trim() : '';
      if (state.enterprise.requireReason && !reason) {
        setStatus('Reason required to submit approval.', false);
        return false;
      }
      const id = `appr_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
      state.enterprise.pendingApprovals.push({
        id,
        actionKey,
        summary,
        requestedBy: currentUser,
        requestedAt: nowIso(),
        status: 'pending',
        reason,
        request: options.request || null
      });
      appendImmutableAudit('approval_requested', `${actionKey}: ${summary}`, 'warn');
      await savePanelState();
      renderAudit();
      setStatus(`Approval queued: ${summary}`, true);
      return false;
    }
    if (state.enterprise.requireReason && options.requireReason && !options.reason) {
      const reason = (prompt(`Reason for ${summary}:`) || '').trim();
      if (!reason) {
        setStatus('Reason required.', false);
        return false;
      }
      options.reason = reason;
    }
    appendImmutableAudit('action_authorized', `${actionKey}: ${summary}`, 'info');
    await savePanelState();
    return true;
  }

  async function executeApprovalRequest(req) {
    if (!req) return;
    const steps = Array.isArray(req.requests) ? req.requests : [req];
    for (const step of steps) {
      await api(step.path, { method: step.method || 'POST', body: JSON.stringify(step.body || {}) });
    }
    if (req.postAction === 'refreshAll') await refreshAll();
    if (req.postAction === 'loadSecurityForUser') await loadSecurityForUser();
  }

  function isAllowed(action) {
    if (currentRole === 'admin') return true;
    const m = state.permissionMatrix || {};
    const allowed = m[currentRole] || [];
    return allowed.includes('all') || allowed.includes(action) || allowed.some(x => x.endsWith('*') && action.startsWith(x.slice(0,-1)));
  }

  function requirePerm(action) {
    if (!isAllowed(action)) {
      setStatus(`Permission denied for ${action} (${currentRole})`, false);
      return false;
    }
    return true;
  }

  function applyRoleUi() {
    const map = {
      admin: ['dashboard','revenue','support','lifecycle','presets','monetization','security','fleet','audit','runbooks','provisioning','actions'],
      operator: ['dashboard','support','security','audit','runbooks','actions'],
      user: ['dashboard']
    };
    const allowed = new Set(map[currentRole] || map.admin);
    document.querySelectorAll('.nav button').forEach(btn => {
      const tab = btn.dataset.tab;
      btn.style.display = allowed.has(tab) ? '' : 'none';
    });
  }

  async function confirmDanger(label) {
    const phrase = `CONFIRM ${label.toUpperCase()}`;
    const typed = prompt(`Type exactly:\\n${phrase}`) || '';
    if (typed.trim() !== phrase) {
      setStatus(`Canceled ${label}: confirmation phrase did not match`, false);
      return false;
    }
    const reason = prompt(`Reason for ${label}:`) || '';
    if (!reason.trim()) {
      setStatus(`Canceled ${label}: reason required`, false);
      return false;
    }
    return { reason: reason.trim() };
  }

  async function api(path, opts={}) {
    const headers = Object.assign({ 'Content-Type':'application/json', 'X-FrenzyNets-Admin':'1' }, opts.headers || {});
    if (token) headers.Authorization = 'Bearer ' + token;
    const method = String(opts.method || 'GET').toUpperCase();
    if (csrfToken && method !== 'GET') headers['X-CSRF-Token'] = csrfToken;
    let lastError = null;
    for (const base of API_BASE_CANDIDATES) {
      try {
        const res = await fetch(base + path, Object.assign({ cache:'no-store' }, opts, { headers }));
        const txt = await res.text();
        let data = {};
        try { data = txt ? JSON.parse(txt) : {}; } catch {}
        if (!res.ok) throw new Error(data.error || (res.status + ' ' + res.statusText));
        API_BASE = base;
        return data;
      } catch (e) {
        lastError = e;
      }
    }
    throw lastError || new Error('api_request_failed');
  }

  async function login() {
    const username = byId('username').value.trim();
    const password = byId('password').value;
    if (!username || !password) return setStatus('Enter username and password.', false);
    try {
      const d = await api('/api/auth/login', { method:'POST', body:JSON.stringify({ username, password, deviceId:'web-admin-v2' }) });
      token = d.token || '';
      csrfToken = d.csrfToken || d.csrf || '';
      currentUser = d.user?.username || username;
      currentRole = d.user?.role || (d.user?.isAdmin ? 'admin' : 'user');
      byId('refreshBtn').disabled = !token;
      byId('app').classList.toggle('hidden', !token);
      setStatus(`Logged in as ${currentUser} (${currentRole})`, true);
      await refreshAll();
    } catch (e) {
      setStatus('Login failed: ' + e.message, false);
    }
  }

  function renderNav() {
    document.querySelectorAll('.nav button').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.nav button').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.section').forEach(x => x.classList.remove('active'));
        btn.classList.add('active');
        byId('tab-' + btn.dataset.tab).classList.add('active');
      };
    });
  }

  async function loadPanelState() {
    try {
      const d = await api('/api/admin/panel/state');
      state = d.state || state;
      ensureStateDefaults();
    } catch {}
  }

  async function savePanelState() {
    await api('/api/admin/panel/state/save', { method:'POST', body:JSON.stringify({ state }) });
  }

  async function saveWebsiteConfigToApi(extra = {}) {
    ensureStateDefaults();
    const body = Object.assign({ websiteSettings: state.website || {} }, extra || {});
    const d = await api('/api/admin/site-config/save', { method:'POST', body:JSON.stringify(body) });
    siteConfig = d.siteConfig || siteConfig || {};
    if (siteConfig.websiteSettings && typeof siteConfig.websiteSettings === 'object') {
      state.website = siteConfig.websiteSettings;
      ensureStateDefaults();
    }
    return d;
  }

  async function refreshAll() {
    try {
      const safe = async (path, fallback) => {
        try { return await api(path); } catch { return fallback; }
      };
      const [u,p,s,a,h,b,ss,t,te,j,sc,subs,pays,refs] = await Promise.all([
        safe('/api/admin/users', { users:[] }),
        safe('/api/admin/profiles', { profiles:[] }),
        safe('/api/admin/servers', { servers:[] }),
        safe('/api/admin/audit/recent', { events:[] }),
        safe('/api/admin/self-heal/recent', { actions:[] }),
        safe('/api/admin/ops/backups', { backups:[] }),
        safe('/api/admin/system/status', { activeSessions:0, users:0, activeProfiles:0 }),
        safe('/api/admin/support/tickets', { tickets:[] }),
        safe('/api/admin/telemetry/recent', { events:[] }),
        safe('/api/admin/servers/bootstrap-jobs', { jobs:[] }),
        safe('/api/admin/site-config', { siteConfig:{} }),
        safe('/api/admin/billing/subscriptions', { items:[] }),
        safe('/api/admin/billing/payments', { items:[] }),
        safe('/api/admin/referrals', { items:[] })
      ]);
      users = u.users || [];
      profiles = p.profiles || [];
      servers = s.servers || [];
      audits = a.events || [];
      selfHeals = h.actions || [];
      backups = b.backups || [];
      sys = ss || {};
      tickets = t.tickets || [];
      telemetry = te.events || [];
      siteConfig = sc.siteConfig || {};
      if (siteConfig.websiteSettings && typeof siteConfig.websiteSettings === 'object') {
        state.website = siteConfig.websiteSettings;
      }
      billingSubscriptions = subs.items || [];
      billingPayments = pays.items || [];
      referralQueue = refs.items || [];
      window.bootstrapJobs = j.jobs || [];
      await loadPanelState();
      applyRoleUi();
      renderAll();
      await loadBillingCatalog(true);
      await loadBillingReviewRequests(true);
      setStatus('Data refreshed', true);
    } catch (e) {
      setStatus('Refresh failed: ' + e.message, false);
    }
  }

  function userMeta(u){
    if (!state.userMeta[u]) state.userMeta[u] = { leadStage:'new', nextFollowUp:'', notes:'', tags:'', lastContactAt:'' };
    return state.userMeta[u];
  }

  function renderDashboard() {
    const expiring = users.filter(u => {
      if (!u.subscriptionExpiresAt) return false;
      const d = new Date(u.subscriptionExpiresAt).getTime() - Date.now();
      return d > 0 && d <= 7*24*3600*1000;
    });
    const due = users.filter(u => {
      const f = userMeta(u.username).nextFollowUp;
      return f && new Date(f).getTime() <= Date.now();
    });

    byId('kpis').innerHTML = `
      <div class="kpi"><div class="k">Users</div><div class="v">${users.length}</div></div>
      <div class="kpi"><div class="k">Active Sessions</div><div class="v">${sys.activeSessions ?? 0}</div></div>
      <div class="kpi"><div class="k">Open/Progress Tickets</div><div class="v">${tickets.filter(t => t.status !== 'resolved').length}</div></div>
      <div class="kpi"><div class="k">Servers</div><div class="v">${servers.length}</div></div>
      <div class="kpi"><div class="k">Active Profiles</div><div class="v">${sys.activeProfiles ?? profiles.filter(p=>p.active).length}</div></div>
      <div class="kpi"><div class="k">Backups</div><div class="v">${backups.length}</div></div>
      <div class="kpi"><div class="k">Avg Jitter (Recent)</div><div class="v">${(() => {
        const vals = telemetry.map(e => Number(e.jitterMs)).filter(n => Number.isFinite(n));
        if (!vals.length) return 'n/a';
        return (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) + 'ms';
      })()}</div></div>
      <div class="kpi"><div class="k">Avg Packet Loss</div><div class="v">${(() => {
        const vals = telemetry.map(e => Number(e.packetLossPct)).filter(n => Number.isFinite(n));
        if (!vals.length) return 'n/a';
        return (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2) + '%';
      })()}</div></div>
    `;

    byId('followupDue').innerHTML = due.length ? due.map(u => `<div class="item"><strong>${esc(u.username)}</strong>  ${esc(userMeta(u.username).leadStage)}  follow-up ${esc(userMeta(u.username).nextFollowUp || '')}</div>`).join('') : '<div class="item muted">No due follow-ups.</div>';
    byId('expiringSoon').innerHTML = expiring.length ? expiring.map(u => `<div class="item"><strong>${esc(u.username)}</strong>  expires ${esc(u.subscriptionExpiresAt)}</div>`).join('') : '<div class="item muted">No imminent expiries.</div>';
  }

  function renderRevenue() {
    const rows = users.map(u => {
      const m = userMeta(u.username);
      return `<tr>
        <td><strong>${esc(u.username)}</strong><br><span class="muted">plan=${esc(u.plan || 'standard')}</span></td>
        <td>
          <select data-rev-stage="${esc(u.username)}">
            ${['new','trial','hot','won','churn-risk'].map(s => `<option value="${s}" ${m.leadStage===s?'selected':''}>${s}</option>`).join('')}
          </select>
        </td>
        <td><input type="date" data-rev-follow="${esc(u.username)}" value="${esc(isoDate(m.nextFollowUp))}" /></td>
        <td><input data-rev-tags="${esc(u.username)}" value="${esc(m.tags || '')}" placeholder="premium,cod,followup" /></td>
        <td><input data-rev-notes="${esc(u.username)}" value="${esc(m.notes || '')}" placeholder="short note" /></td>
        <td><button class="secondary" data-rev-save="${esc(u.username)}">Save</button></td>
      </tr>`;
    }).join('');

    byId('revenueTableWrap').innerHTML = `<table class="table"><thead><tr><th>User</th><th>Stage</th><th>Next Follow-Up</th><th>Tags</th><th>Notes</th><th>Save</th></tr></thead><tbody>${rows}</tbody></table>`;

    document.querySelectorAll('[data-rev-save]').forEach(btn => btn.onclick = async () => {
      const u = btn.dataset.revSave;
      const m = userMeta(u);
      m.leadStage = document.querySelector(`[data-rev-stage="${CSS.escape(u)}"]`).value;
      m.nextFollowUp = document.querySelector(`[data-rev-follow="${CSS.escape(u)}"]`).value;
      m.tags = document.querySelector(`[data-rev-tags="${CSS.escape(u)}"]`).value.trim();
      m.notes = document.querySelector(`[data-rev-notes="${CSS.escape(u)}"]`).value.trim();
      m.lastContactAt = nowIso();
      await savePanelState();
      setStatus(`Saved CRM for ${u}`, true);
      renderDashboard();
    });
  }

  function renderSupportBoard() {
    const columns = ['open','in-progress','waiting-user','resolved'];
    const board = byId('supportBoard');
    board.innerHTML = columns.map(c => `<div class="col"><h4>${c}</h4><div id="col-${c}"></div></div>`).join('');

    columns.forEach(c => {
      const target = byId('col-' + c);
      const items = tickets.filter(t => (t.status || 'open') === c);
      target.innerHTML = items.length ? items.map(t => {
        const created = t.createdAt ? new Date(Number(t.createdAt)).toISOString() : '';
        return `<div class="ticket">
          <div><strong>${esc(t.ticketId)}</strong> <span class="pill">${esc(t.priority || 'normal')}</span></div>
          <div class="muted">${esc(t.userTag || t.userId || '')}</div>
          <div style="margin-top:4px">${esc(t.issue || '')}</div>
          <div class="row" style="margin-top:6px">
            <input data-t-assignee="${esc(t.ticketId)}" value="${esc(t.assignee || '')}" placeholder="assignee" style="width:100px" />
            <select data-t-priority="${esc(t.ticketId)}">
              ${['low','normal','high','urgent'].map(p => `<option value="${p}" ${(t.priority||'normal')===p?'selected':''}>${p}</option>`).join('')}
            </select>
            <select data-t-status="${esc(t.ticketId)}">
              ${['open','in-progress','waiting-user','resolved'].map(s => `<option value="${s}" ${(t.status||'open')===s?'selected':''}>${s}</option>`).join('')}
            </select>
            <button class="secondary" data-t-save="${esc(t.ticketId)}">Update</button>
          </div>
        </div>`;
      }).join('') : '<div class="muted">No tickets</div>';
    });

    document.querySelectorAll('[data-t-save]').forEach(btn => btn.onclick = async () => {
      const id = btn.dataset.tSave;
      const status = document.querySelector(`[data-t-status="${CSS.escape(id)}"]`).value;
      const assignee = document.querySelector(`[data-t-assignee="${CSS.escape(id)}"]`).value.trim();
      const priority = document.querySelector(`[data-t-priority="${CSS.escape(id)}"]`).value;
      await api('/api/admin/support/tickets/update', { method:'POST', body:JSON.stringify({ ticketId:id, status, assignee, priority }) });
      await refreshAll();
      setStatus(`Updated ${id}`, true);
    });
  }

  function renderLifecycle() {
    const rows = users.map(u => {
      const exp = u.subscriptionExpiresAt ? new Date(u.subscriptionExpiresAt) : null;
      const days = exp ? Math.floor((exp.getTime() - Date.now()) / 86400000) : null;
      const risk = days !== null && days <= 3 ? 'high' : (days !== null && days <= 7 ? 'medium' : 'low');
      return `<tr>
        <td><strong>${esc(u.username)}</strong></td>
        <td>${esc(u.plan || 'standard')}</td>
        <td>${esc(u.subscriptionExpiresAt || 'none')}</td>
        <td><span class="pill">${days===null?'n/a':days+'d'}</span></td>
        <td><span class="pill">${risk}</span></td>
        <td class="row">
          <button class="secondary" data-add-days="${esc(u.username)}|7">+7</button>
          <button class="secondary" data-add-days="${esc(u.username)}|30">+30</button>
          <button class="secondary" data-add-days="${esc(u.username)}|90">+90</button>
        </td>
      </tr>`;
    }).join('');
    byId('lifecycleTableWrap').innerHTML = `<table class="table"><thead><tr><th>User</th><th>Plan</th><th>Expires</th><th>Days Left</th><th>Risk</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    document.querySelectorAll('[data-add-days]').forEach(btn => btn.onclick = async () => {
      const [username, days] = btn.dataset.addDays.split('|');
      await api('/api/admin/users/add-subscription-days', { method:'POST', body:JSON.stringify({ username, days:Number(days), subscriptionNote:'admin lifecycle extension' }) });
      await refreshAll();
      setStatus(`Added ${days} days to ${username}`, true);
    });
  }

  function renderProvisioningUsers() {
    const q = String(byId('pvUserSearch')?.value || '').trim().toLowerCase();
    const rows = users
      .filter(u => {
        if (!q) return true;
        const hay = [u.username, u.role, u.plan, u.updateChannel].map(x => String(x || '').toLowerCase()).join(' ');
        return hay.includes(q);
      })
      .sort((a, b) => String(a.username || '').localeCompare(String(b.username || '')));

    if (!rows.length) {
      byId('pvUserManagerList').innerHTML = '<div class="item muted">No users match your filter.</div>';
      return;
    }

    byId('pvUserManagerList').innerHTML = `<table class="table"><thead><tr><th>User</th><th>Role</th><th>Plan</th><th>Channel</th><th>Status</th><th>Actions</th></tr></thead><tbody>${
      rows.map(u => `<tr>
        <td><strong>${esc(u.username)}</strong></td>
        <td>${esc(u.role || (u.isAdmin ? 'admin' : 'user'))}</td>
        <td>${esc(u.plan || 'standard')}</td>
        <td>${esc(u.updateChannel || 'stable')}</td>
        <td>${u.lockedUntil ? '<span class="pill">locked</span>' : '<span class="pill">active</span>'}</td>
        <td class="row">
          <button class="secondary" data-pv-edit="${esc(u.username)}">Edit</button>
          <button class="danger" data-pv-delete="${esc(u.username)}">Delete</button>
        </td>
      </tr>`).join('')
    }</tbody></table>`;

    document.querySelectorAll('[data-pv-edit]').forEach(btn => btn.onclick = async () => {
      const username = btn.dataset.pvEdit;
      byId('pvUserTarget').value = username;
      byId('securityUser').value = username;
      await loadSecurityForUser();
      setStatus(`Loaded ${username} into user/security controls`, true);
    });

    document.querySelectorAll('[data-pv-delete]').forEach(btn => btn.onclick = async () => {
      if (!requirePerm('users.delete')) return;
      const username = btn.dataset.pvDelete;
      const ok = await confirmDanger(`delete user ${username}`);
      if (!ok) return;
      const allow = await guardAction('users.delete', `delete user ${username}`, {
        ownerOnly: true,
        request: { path:'/api/admin/users/delete', method:'POST', body:{ username }, postAction:'refreshAll' }
      });
      if (!allow) return;
      await api('/api/admin/users/delete', { method:'POST', body:JSON.stringify({ username }) });
      appendImmutableAudit('users.delete', `deleted ${username} from user directory (reason: ${ok.reason})`, 'warn');
      await savePanelState();
      await refreshAll();
      setStatus(`Deleted ${username}`, true);
    });
  }

  function renderPresets() {
    const rows = presetCatalog.map(name => {
      const m = state.presetMeta[name] || { version:'1.0.0', rollout:'internal', changeLog:'' };
      return `<tr>
        <td><strong>${esc(name)}</strong></td>
        <td><input data-p-version="${esc(name)}" value="${esc(m.version || '')}" /></td>
        <td>
          <select data-p-rollout="${esc(name)}">
            ${['internal','10%','all'].map(r => `<option value="${r}" ${(m.rollout||'internal')===r?'selected':''}>${r}</option>`).join('')}
          </select>
        </td>
        <td><input data-p-log="${esc(name)}" value="${esc(m.changeLog || '')}" placeholder="changelog" /></td>
        <td class="row">
          <button class="secondary" data-p-save="${esc(name)}">Save</button>
          <button class="secondary" data-p-rollback="${esc(name)}">Rollback</button>
        </td>
      </tr>`;
    }).join('');
    byId('presetTableWrap').innerHTML = `<table class="table"><thead><tr><th>Preset</th><th>Version</th><th>Rollout</th><th>Changelog</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;

    document.querySelectorAll('[data-p-save]').forEach(btn => btn.onclick = async () => {
      const name = btn.dataset.pSave;
      state.presetMeta[name] = {
        version: document.querySelector(`[data-p-version="${CSS.escape(name)}"]`).value.trim() || '1.0.0',
        rollout: document.querySelector(`[data-p-rollout="${CSS.escape(name)}"]`).value,
        changeLog: document.querySelector(`[data-p-log="${CSS.escape(name)}"]`).value.trim(),
        lastUpdatedAt: nowIso()
      };
      await savePanelState();
      setStatus(`Saved preset governance for ${name}`, true);
    });

    document.querySelectorAll('[data-p-rollback]').forEach(btn => btn.onclick = async () => {
      const name = btn.dataset.pRollback;
      const m = state.presetMeta[name] || {};
      m.rollout = 'internal';
      m.changeLog = `[ROLLBACK] ${(m.changeLog || '')}`.trim();
      m.lastUpdatedAt = nowIso();
      state.presetMeta[name] = m;
      await savePanelState();
      renderPresets();
      setStatus(`Rollback flag applied for ${name}`, true);
    });
  }

  function fillUserSelectors() {
    const options = '<option value="">(select user)</option>' + users.map(u => `<option value="${esc(u.username)}">${esc(u.username)}</option>`).join('');
    byId('securityUser').innerHTML = options;
    byId('quickUser').innerHTML = options;
    byId('pvUserTarget').innerHTML = options;
  }

  async function loadSecurityForUser() {
    const username = byId('securityUser').value;
    if (!username) return;
    const [d,s] = await Promise.all([
      api('/api/admin/users/devices?username=' + encodeURIComponent(username)),
      api('/api/admin/users/sessions?username=' + encodeURIComponent(username))
    ]);
    byId('devicesList').innerHTML = (d.devices||[]).length ? d.devices.map(x => `<div class="item"><strong>${esc(x.deviceId)}</strong><br><span class="muted">${esc(x.label||'')}</span><br><button class="secondary" data-revoke-device="${esc(username)}|${esc(x.deviceId)}">Revoke Device</button></div>`).join('') : '<div class="item muted">No devices.</div>';
    byId('sessionsList').innerHTML = (s.sessions||[]).length ? s.sessions.map(x => `<div class="item"><strong>#${esc(x.id)}</strong>  ${esc(x.clientIp||'')}<br><span class="muted">issued ${esc(x.issuedAt||'')}</span><br><button class="secondary" data-revoke-session="${esc(username)}|${esc(x.id)}">Revoke Session</button></div>`).join('') : '<div class="item muted">No sessions.</div>';
    const t = [];
    (audits||[]).filter(e => (e.username||'').toLowerCase() === username.toLowerCase()).slice(0,25).forEach(e => t.push({at:e.createdAt, line:`Audit: ${e.eventType}`}));
    (tickets||[]).filter(e => (e.userTag||'').toLowerCase().includes(username.toLowerCase()) || (e.userId||'')===username).slice(0,25).forEach(e => t.push({at:e.lastUpdateAt || e.createdAt, line:`Ticket ${e.ticketId}: ${e.status}`}));
    (s.sessions||[]).slice(0,25).forEach(e => t.push({at:e.issuedAt, line:`Session from ${e.clientIp || 'unknown'}`}));
    t.sort((a,b) => String(b.at||'').localeCompare(String(a.at||'')));
    byId('userTimeline').innerHTML = t.length ? t.slice(0,40).map(x => `<div class="item"><strong>${esc(String(x.at||''))}</strong><br>${esc(x.line)}</div>`).join('') : '<div class="item muted">No timeline events.</div>';

    document.querySelectorAll('[data-revoke-device]').forEach(btn => btn.onclick = async () => {
      const [u, deviceId] = btn.dataset.revokeDevice.split('|');
      await api('/api/admin/users/revoke-device', { method:'POST', body:JSON.stringify({ username:u, deviceId }) });
      await loadSecurityForUser();
      setStatus(`Revoked device ${deviceId} for ${u}`, true);
    });
    document.querySelectorAll('[data-revoke-session]').forEach(btn => btn.onclick = async () => {
      const [u, sid] = btn.dataset.revokeSession.split('|');
      await api('/api/admin/users/revoke-session', { method:'POST', body:JSON.stringify({ username:u, sessionId:Number(sid) }) });
      await loadSecurityForUser();
      setStatus(`Revoked session #${sid} for ${u}`, true);
    });
  }

  function renderFleet() {
    const rows = servers.map(s => `<tr>
      <td><strong>${esc(s.name)}</strong><br><span class="muted">${esc(s.host)}</span></td>
      <td>${esc(s.region)}</td><td>${esc(s.serverPool)}</td><td>${esc(s.tier)}</td>
      <td><span class="pill">${esc(s.status)}</span></td>
      <td class="row">
        <button class="secondary" data-server-status="${esc(s.name)}|active">active</button>
        <button class="secondary" data-server-status="${esc(s.name)}|maintenance">maintenance</button>
        <button class="secondary" data-server-status="${esc(s.name)}|degraded">degraded</button>
      </td>
    </tr>`).join('');
    byId('fleetTableWrap').innerHTML = `<table class="table"><thead><tr><th>Server</th><th>Region</th><th>Pool</th><th>Tier</th><th>Status</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
    document.querySelectorAll('[data-server-status]').forEach(btn => btn.onclick = async () => {
      const [name, status] = btn.dataset.serverStatus.split('|');
      await api('/api/admin/servers/update', { method:'POST', body:JSON.stringify({ name, status }) });
      await refreshAll();
      setStatus(`Updated ${name} to ${status}`, true);
    });

    const byUser = {};
    telemetry.forEach(e => {
      const u = String(e.username || 'unknown');
      if (!byUser[u]) byUser[u] = { count:0, jitter:0, loss:0 };
      byUser[u].count += 1;
      byUser[u].jitter += Number(e.jitterMs || 0);
      byUser[u].loss += Number(e.packetLossPct || 0);
    });
    const impacted = Object.entries(byUser).map(([u,v]) => ({
      user:u,
      score: (v.jitter/Math.max(1,v.count)) + (v.loss/Math.max(1,v.count))*20,
      jitter: v.jitter/Math.max(1,v.count),
      loss: v.loss/Math.max(1,v.count)
    })).sort((a,b) => b.score-a.score).slice(0,20);
    byId('fleetImpactUsers').innerHTML = impacted.length
      ? impacted.map(i => `<div class="item"><strong>${esc(i.user)}</strong><br><span class="muted">jitter ${i.jitter.toFixed(1)}ms  loss ${i.loss.toFixed(2)}%</span></div>`).join('')
      : '<div class="item muted">No telemetry yet.</div>';

    const rec = [];
    impacted.slice(0,8).forEach(i => {
      if (i.loss > 1.5) rec.push(`Route review for ${i.user}: high packet loss (${i.loss.toFixed(2)}%). Consider premium/ddos pool.`);
      else if (i.jitter > 20) rec.push(`Route optimization for ${i.user}: high jitter (${i.jitter.toFixed(1)}ms). Suggest region-proximate node.`);
    });
    byId('fleetRecommendations').innerHTML = rec.length
      ? rec.map(r => `<div class="item">${esc(r)}</div>`).join('')
      : '<div class="item muted">No immediate route recommendations.</div>';
  }

  function renderAudit() {
    byId('auditList').innerHTML = audits.slice(0,120).map(e => `<div class="item"><strong>${esc(e.eventType)}</strong> ${esc(e.username||'')}<br><span class="muted">${esc(e.createdAt)}  ${esc(e.clientIp||'')}</span></div>`).join('') || '<div class="item muted">No audit events.</div>';
    byId('permissionMatrixBox').value = JSON.stringify(state.permissionMatrix || {}, null, 2);
    renderEnterprise();
  }

  function renderEnterprise() {
    ensureStateDefaults();
    const e = state.enterprise;
    byId('entOwnerUsers').value = (e.ownerUsers || []).join(',');
    byId('entRequireApprovals').value = e.requireApprovals ? 'yes' : 'no';
    byId('entRequireReason').value = e.requireReason ? 'yes' : 'no';
    byId('entApprovalMatrix').value = JSON.stringify(e.approvalMatrix || {}, null, 2);

    byId('entMfaRoles').value = (e.security?.mfaRequiredRoles || []).join(',');
    byId('entSessionTimeout').value = Number(e.security?.sessionTimeoutMin || 45);
    byId('entRateLimit').value = Number(e.security?.rateLimitPerMin || 60);
    byId('entTrustedDevices').value = e.security?.trustedDevicesOnly ? 'yes' : 'no';
    byId('entIpAllowlist').value = e.security?.ipAllowlist || '';

    byId('entApiLatencyWarn').value = Number(e.monitoring?.apiLatencyWarnMs || 500);
    byId('entErrorRateWarn').value = Number(e.monitoring?.errorRateWarnPct || 2);
    byId('entAlertChannel').value = e.monitoring?.discordAlertChannel || '#ops-alerts';
    byId('entNotifyLoginFail').value = e.monitoring?.notifyOnLoginFailures ? 'yes' : 'no';

    byId('entBackupHourUtc').value = Number(e.backups?.dailyHourUtc ?? 2);
    byId('entBackupRetention').value = Number(e.backups?.retentionDays ?? 30);
    byId('entRestoreDrillDays').value = Number(e.backups?.testRestoreEveryDays ?? 14);
    byId('entSecretsRotationDays').value = Number(e.secrets?.rotationDays ?? 30);
    byId('entRequireTicket').value = e.governance?.requireTicket ? 'yes' : 'no';
    byId('entRequirePeerReview').value = e.governance?.requirePeerReview ? 'yes' : 'no';

    const approvals = e.pendingApprovals || [];
    byId('entApprovals').innerHTML = approvals.length
      ? approvals.slice().reverse().map(a => `<div class="item"><strong>${esc(a.actionKey)}</strong>  ${esc(a.summary)}<br><span class="muted">${esc(a.requestedBy)}  ${esc(a.requestedAt)}  ${esc(a.status || 'pending')}</span><br>${a.reason ? `<div class="muted">reason: ${esc(a.reason)}</div>` : ''}<div class="row" style="margin-top:6px"><button class="secondary" data-ent-approve="${esc(a.id)}">Approve+Run</button><button class="danger" data-ent-reject="${esc(a.id)}">Reject</button></div></div>`).join('')
      : '<div class="item muted">No pending approvals.</div>';

    const chain = e.immutableAudit || [];
    byId('entImmutableAudit').innerHTML = chain.length
      ? chain.slice(-80).reverse().map(x => `<div class="item"><strong>${esc(x.eventType)}</strong>  ${esc(x.actor || '')}<br><span class="muted">${esc(x.at || '')}  hash ${esc(x.hash || '')}  prev ${esc(x.prevHash || '')}</span><br>${esc(x.detail || '')}</div>`).join('')
      : '<div class="item muted">No immutable entries yet.</div>';

    document.querySelectorAll('[data-ent-approve]').forEach(btn => btn.onclick = async () => {
      if (!isOwnerUser()) return setStatus('Only owners can approve queued actions.', false);
      const id = btn.dataset.entApprove;
      const ap = (state.enterprise.pendingApprovals || []).find(x => x.id === id);
      if (!ap) return;
      try {
        await executeApprovalRequest(ap.request);
        ap.status = 'approved_executed';
        ap.approvedBy = currentUser;
        ap.approvedAt = nowIso();
        appendImmutableAudit('approval_executed', `${ap.actionKey}: ${ap.summary}`, 'info');
        await savePanelState();
        renderAudit();
        setStatus(`Approval executed: ${ap.summary}`, true);
      } catch (e) {
        ap.status = 'failed';
        ap.error = e.message;
        appendImmutableAudit('approval_failed', `${ap.actionKey}: ${ap.summary} -> ${e.message}`, 'bad');
        await savePanelState();
        renderAudit();
        setStatus(`Approval failed: ${e.message}`, false);
      }
    });

    document.querySelectorAll('[data-ent-reject]').forEach(btn => btn.onclick = async () => {
      if (!isOwnerUser()) return setStatus('Only owners can reject queued actions.', false);
      const id = btn.dataset.entReject;
      const ap = (state.enterprise.pendingApprovals || []).find(x => x.id === id);
      if (!ap) return;
      ap.status = 'rejected';
      ap.rejectedBy = currentUser;
      ap.rejectedAt = nowIso();
      appendImmutableAudit('approval_rejected', `${ap.actionKey}: ${ap.summary}`, 'warn');
      await savePanelState();
      renderAudit();
      setStatus(`Approval rejected: ${ap.summary}`, true);
    });
  }

  function renderRunbooks() {
    byId('runbookList').innerHTML = (state.runbooks||[]).map((r, idx) => `<div class="item"><strong>${esc(r.title || 'Untitled')}</strong><br><span class="muted">${esc(r.updatedAt || '')}</span><br><div>${esc((r.body||'').slice(0,220))}</div><div class="row" style="margin-top:6px"><button class="secondary" data-r-load="${idx}">Load</button><button class="danger" data-r-del="${idx}">Delete</button></div></div>`).join('') || '<div class="item muted">No runbooks yet.</div>';
    const bg = state.breakGlass || {};
    byId('breakGlassOwner').value = bg.owner || '';
    byId('breakGlassSteps').value = bg.steps || '';

    document.querySelectorAll('[data-r-load]').forEach(btn => btn.onclick = () => {
      const r = state.runbooks[Number(btn.dataset.rLoad)];
      if (!r) return;
      byId('runbookTitle').value = r.title || '';
      byId('runbookBody').value = r.body || '';
    });
    document.querySelectorAll('[data-r-del]').forEach(btn => btn.onclick = async () => {
      const idx = Number(btn.dataset.rDel);
      state.runbooks.splice(idx,1);
      await savePanelState();
      renderRunbooks();
      setStatus('Runbook deleted', true);
    });
  }

  function renderActions() {
    byId('backupList').innerHTML = backups.map(b => `<div class="item"><strong>${esc(b.name)}</strong><br><span class="muted">${esc(b.modifiedAt)}  ${esc(b.size)} bytes</span></div>`).join('') || '<div class="item muted">No backups.</div>';
  }

  function logWebsiteChange(action, detail='') {
    ensureStateDefaults();
    const row = { at: nowIso(), actor: currentUser || 'system', action, detail };
    state.website.changeLog.push(row);
    if (state.website.changeLog.length > 500) state.website.changeLog.splice(0, state.website.changeLog.length - 500);
  }

  function renderWebsite() {
    ensureStateDefaults();
    const w = state.website || {};
    if (byId('mzBetaCountdownEnds')) byId('mzBetaCountdownEnds').value = isoToLocalInput(siteConfig.betaCountdownEndIso || '');
    if (byId('wsSiteCfgMeta')) {
      const endIso = siteConfig.betaCountdownEndIso || 'not set';
      const updatedAt = siteConfig.updatedAt || 'n/a';
      const updatedBy = siteConfig.updatedBy || 'system';
      byId('wsSiteCfgMeta').innerHTML = `<div class="item"><strong>Current End:</strong> ${esc(endIso)}</div><div class="item"><strong>Last Updated:</strong> ${esc(updatedAt)} by ${esc(updatedBy)}</div>`;
    }

    byId('wsHeroTitle').value = w.hero?.title || '';
    byId('wsHeroSub').value = w.hero?.sub || '';
    byId('wsHeroCtaPrimary').value = w.hero?.ctaPrimary || '';
    byId('wsHeroCtaSecondary').value = w.hero?.ctaSecondary || '';
    byId('wsHeroPreview').innerHTML = `<strong>${esc(w.hero?.title || '')}</strong><br><span class="muted">${esc(w.hero?.sub || '')}</span><br><div class="row" style="margin-top:6px"><span class="pill">${esc(w.hero?.ctaPrimary || '')}</span><span class="pill">${esc(w.hero?.ctaSecondary || '')}</span></div>`;

    byId('wsTrustUptime').value = w.trust?.uptime || '';
    byId('wsTrustUsers').value = w.trust?.users || '';
    byId('wsTrustBackup').value = w.trust?.backup || '';

    byId('wsSeoTitle').value = w.seo?.title || '';
    byId('wsSeoDesc').value = w.seo?.description || '';
    byId('wsSeoOgImage').value = w.seo?.ogImage || '';
    byId('wsSeoDiscordCard').value = w.seo?.discordCard || '';

    byId('wsIncidentMode').value = w.incident?.mode || 'off';
    byId('wsIncidentText').value = w.incident?.text || '';

    byId('wsGateDotnet').value = w.downloadGate?.dotnet || 'required';
    byId('wsGateWireguard').value = w.downloadGate?.wireguard || 'required';
    byId('wsGateAdmin').value = w.downloadGate?.admin || 'required';

    byId('wsVisits').value = Number(w.funnel?.visits || 0);
    byId('wsBillingClicks').value = Number(w.funnel?.billingClicks || 0);
    byId('wsCheckouts').value = Number(w.funnel?.checkouts || 0);
    const visits = Number(w.funnel?.visits || 0);
    const clicks = Number(w.funnel?.billingClicks || 0);
    const chks = Number(w.funnel?.checkouts || 0);
    const clickRate = visits > 0 ? ((clicks / visits) * 100).toFixed(1) : '0.0';
    const checkoutRate = clicks > 0 ? ((chks / clicks) * 100).toFixed(1) : '0.0';
    const fullRate = visits > 0 ? ((chks / visits) * 100).toFixed(1) : '0.0';
    byId('wsFunnelStats').innerHTML = `
      <div class="item"><strong>Visit -> Billing Click:</strong> ${clickRate}%</div>
      <div class="item"><strong>Billing Click -> Checkout:</strong> ${checkoutRate}%</div>
      <div class="item"><strong>Visit -> Checkout:</strong> ${fullRate}%</div>
    `;

    byId('wsBannerList').innerHTML = (w.bannerSchedule || []).length
      ? w.bannerSchedule.slice().reverse().map((b, i) => `<div class="item"><strong>${esc(b.text)}</strong><br><span class="muted">${esc(b.start)} -> ${esc(b.end)}</span> <button class="danger tiny" data-ws-del-banner="${i}">Delete</button></div>`).join('')
      : '<div class="item muted">No scheduled banners.</div>';
    document.querySelectorAll('[data-ws-del-banner]').forEach(btn => btn.onclick = async () => {
      const revIdx = Number(btn.dataset.wsDelBanner);
      const idx = (w.bannerSchedule.length - 1) - revIdx;
      if (idx < 0) return;
      w.bannerSchedule.splice(idx, 1);
      logWebsiteChange('banner.deleted');
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus('Banner removed.', true);
    });

    byId('wsAbList').innerHTML = (w.abTests || []).length
      ? w.abTests.slice().reverse().map((t, i) => {
        const va = Number(t.aViews || 0), vb = Number(t.bViews || 0), ca = Number(t.aConversions || 0), cb = Number(t.bConversions || 0);
        const ra = va > 0 ? ((ca / va) * 100).toFixed(1) : '0.0';
        const rb = vb > 0 ? ((cb / vb) * 100).toFixed(1) : '0.0';
        return `<div class="item"><strong>${esc(t.name)}</strong><br>A: ${esc(t.a)} (${ra}%) | B: ${esc(t.b)} (${rb}%)<br><span class="muted">winner: ${esc(t.winner || 'pending')}</span> <button class="secondary tiny" data-ws-ab-sim="${i}">Simulate Data</button></div>`;
      }).join('')
      : '<div class="item muted">No A/B tests created.</div>';
    document.querySelectorAll('[data-ws-ab-sim]').forEach(btn => btn.onclick = async () => {
      const revIdx = Number(btn.dataset.wsAbSim);
      const idx = (w.abTests.length - 1) - revIdx;
      const t = w.abTests[idx];
      if (!t) return;
      t.aViews = Number(t.aViews || 0) + 200;
      t.bViews = Number(t.bViews || 0) + 200;
      t.aConversions = Number(t.aConversions || 0) + Math.floor(Math.random() * 80);
      t.bConversions = Number(t.bConversions || 0) + Math.floor(Math.random() * 80);
      logWebsiteChange('ab.simulated', t.name);
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus(`Simulated A/B data for ${t.name}.`, true);
    });

    byId('wsRollbackPick').innerHTML = '<option value="">Snapshot</option>' + (w.releaseSnapshots || []).slice().reverse().map(s => `<option value="${esc(s.id)}">${esc(s.id)} (${esc(s.at)})</option>`).join('');
    byId('wsChangeLog').innerHTML = (w.changeLog || []).length
      ? w.changeLog.slice(-120).reverse().map(r => `<div class="item"><strong>${esc(r.action)}</strong><br><span class="muted">${esc(r.at)} by ${esc(r.actor)}</span>${r.detail ? `<br>${esc(r.detail)}` : ''}</div>`).join('')
      : '<div class="item muted">No website changes logged yet.</div>';
  }

  function renderMonetization() {
    ensureStateDefaults();
    const m = state.monetization;
    if (byId('mzStrategy')) byId('mzStrategy').value = m.simpleStrategy || 'balanced';
    const bench = pricingBenchmarks();
    m.tiers = m.tiers || {};
    m.tiers.Competitive = Math.min(bench.maxCompetitive, Number(m.tiers.Competitive || bench.maxCompetitive));
    if (byId('mzCompTarget')) {
      byId('mzCompTarget').max = String(bench.maxCompetitive);
      byId('mzCompTarget').value = Number(m.tiers.Competitive || bench.maxCompetitive);
    }
    byId('mzStarter').value = Number(m.tiers?.Starter || 0);
    byId('mzCompetitive').value = Number(m.tiers?.Competitive || 0);
    byId('mzElite').value = Number(m.tiers?.Elite || 0);
    byId('mzAntiDdos').value = Number(m.addons?.anti_ddos || 0);
    byId('mzPresetAddon').value = Number(m.addons?.premium_presets || 0);
    byId('mzPriorityAddon').value = Number(m.addons?.priority_support || 0);
    byId('mzRenewalDays').value = Number(m.triggers?.beforeExpiryDays || 7);
    byId('mzTiers').value = JSON.stringify(m.tiers || {}, null, 2);
    byId('mzAddons').value = JSON.stringify(m.addons || {}, null, 2);
    byId('mzBundles').value = JSON.stringify(m.bundles || {}, null, 2);
    byId('mzTeamPack').value = JSON.stringify(m.teamPack || {}, null, 2);
    byId('mzSla').value = JSON.stringify(m.sla || {}, null, 2);
    byId('mzTriggers').value = JSON.stringify(m.triggers || {}, null, 2);
    byId('mzOutcomeCopy').value = m.outcomeCopy || '';
    if (byId('mzAddonTier')) byId('mzAddonTier').value = m.addonTier || 'popular';
    if (byId('mzPricingSheet')) byId('mzPricingSheet').value = m.lastPricingSheet || '';
    byId('mzPerfUser').innerHTML = '<option value="">(select user)</option>' + users.map(u => `<option value="${esc(u.username)}">${esc(u.username)}</option>`).join('');
    if (byId('mzCheckoutUser')) byId('mzCheckoutUser').value = '';
    if (byId('mzBetaDays')) byId('mzBetaDays').value = Number(m.betaTransition?.durationDays || 91);
    if (byId('mzRefundTemplates')) byId('mzRefundTemplates').value = m.refundTemplates || '';
    if (byId('mzDiscordCommands')) byId('mzDiscordCommands').value = m.discordCommandKit || '';
    if (byId('mzWeeklyReport')) byId('mzWeeklyReport').value = m.weeklyReport || '';
    if (byId('mzExeBannerText')) byId('mzExeBannerText').value = m.exeBannerText || '';
    if (byId('mzGuardMaxPromos')) byId('mzGuardMaxPromos').value = Number(m.promoGuard?.maxPromosPerUser || 1);
    if (byId('mzGuardCooldownDays')) byId('mzGuardCooldownDays').value = Number(m.promoGuard?.cooldownDays || 30);
    if (byId('mzGuardMinPrice')) byId('mzGuardMinPrice').value = Number(m.promoGuard?.minMonthlyPrice || 6);

    if (byId('mzCheckoutPlan')) {
      byId('mzCheckoutPlan').innerHTML = '<option value="">Plan</option>' + billingPlans.filter(p => p.enabled !== false).map(p => `<option value="${esc(p.code)}">${esc(p.name || p.code)}</option>`).join('');
    }
    if (byId('mzCheckoutAddon')) {
      byId('mzCheckoutAddon').innerHTML = '<option value="">Add-on (optional)</option>' + billingAddons.filter(a => a.enabled !== false).map(a => `<option value="${esc(a.code)}">${esc(a.name || a.code)}</option>`).join('');
    }

    const refs = m.referrals || [];
    byId('mzReferralList').innerHTML = refs.length
      ? refs.slice().reverse().map(r => `<div class="item"><strong>${esc(r.referrer)}</strong> referred <strong>${esc(r.referred)}</strong>  ${esc(String(r.creditDays))} credit days  ${esc(r.createdAt || '')}</div>`).join('')
      : '<div class="item muted">No referrals yet.</div>';
    byId('mzReferralQueue').innerHTML = (referralQueue || []).length
      ? referralQueue.map(r => `<div class="item"><strong>${esc(r.referrer)}</strong> -> <strong>${esc(r.referred)}</strong>  ${esc(r.status || '')}<br><span class="muted">${esc(r.createdAt || '')}</span><div class="row" style="margin-top:6px"><button class="secondary" data-ref-approve="${esc(String(r.id))}">Approve</button><button class="danger" data-ref-reject="${esc(String(r.id))}">Reject</button></div></div>`).join('')
      : '<div class="item muted">No referral queue items.</div>';
    document.querySelectorAll('[data-ref-approve]').forEach(btn => btn.onclick = async () => {
      const id = Number(btn.dataset.refApprove || 0);
      if (!id) return;
      await api('/api/admin/referrals/mark', { method:'POST', body:JSON.stringify({ id, status:'approved', note:'approved from admin queue' }) });
      await refreshAll();
      setStatus(`Referral ${id} approved.`, true);
    });
    document.querySelectorAll('[data-ref-reject]').forEach(btn => btn.onclick = async () => {
      const id = Number(btn.dataset.refReject || 0);
      if (!id) return;
      await api('/api/admin/referrals/mark', { method:'POST', body:JSON.stringify({ id, status:'rejected', note:'rejected from admin queue' }) });
      await refreshAll();
      setStatus(`Referral ${id} rejected.`, true);
    });

    byId('mzRenewalQueue').innerHTML = (m.renewalQueue || []).length
      ? m.renewalQueue.map(r => `<div class="item"><strong>${esc(r.username)}</strong>  expires ${esc(r.expiresAt || 'n/a')}  trigger ${esc(r.trigger || '')}</div>`).join('')
      : '<div class="item muted">No renewal queue built yet.</div>';
    byId('mzChurnQueue').innerHTML = (m.churnQueue || []).length
      ? m.churnQueue.map(r => `<div class="item"><strong>${esc(r.username)}</strong>  expires ${esc(r.expiresAt || 'n/a')}  ${esc(r.stage || '')}</div>`).join('')
      : '<div class="item muted">No churn-risk queue built yet.</div>';
    byId('mzCheckoutLinks').innerHTML = (m.checkoutLinks || []).length
      ? m.checkoutLinks.slice().reverse().slice(0, 40).map(r => `<div class="item"><strong>${esc(r.plan)}</strong>${r.addon ? ` + ${esc(r.addon)}` : ''}<br><span class="muted">${esc(r.url)}</span></div>`).join('')
      : '<div class="item muted">No checkout links yet.</div>';
    byId('mzCouponList').innerHTML = (m.coupons || []).length
      ? m.coupons.slice().reverse().slice(0, 60).map(c => `<div class="item"><strong>${esc(c.code)}</strong>  ${esc(c.type)}=${esc(String(c.value))}  expires ${esc(c.expiresAt || 'none')}</div>`).join('')
      : '<div class="item muted">No coupons yet.</div>';
    byId('mzFailedRecoveryQueue').innerHTML = (m.failedRecoveryQueue || []).length
      ? m.failedRecoveryQueue.map(r => `<div class="item"><strong>${esc(r.username || 'unknown')}</strong>  ${esc(r.provider || '')}  ${esc(r.status || '')}  ${billingCentsToDollarStr(r.amountCents || 0)}</div>`).join('')
      : '<div class="item muted">No failed-payment recovery queue yet.</div>';
    byId('mzAbList').innerHTML = (m.abTests || []).length
      ? m.abTests.slice().reverse().map(t => `<div class="item"><strong>${esc(t.name)}</strong>  A $${esc(String(t.priceA))} vs B $${esc(String(t.priceB))}  ${esc(t.start || '')} to ${esc(t.end || '')}</div>`).join('')
      : '<div class="item muted">No A/B tests yet.</div>';
    byId('mzAffiliateList').innerHTML = (m.affiliates || []).length
      ? m.affiliates.slice().reverse().map(a => `<div class="item"><strong>${esc(a.username)}</strong>  code ${esc(a.code)}  ${esc(String(a.ratePct))}% commission</div>`).join('')
      : '<div class="item muted">No affiliates yet.</div>';
    byId('mzWinbackQueue').innerHTML = (m.winbackQueue || []).length
      ? m.winbackQueue.map(r => `<div class="item"><strong>${esc(r.username || 'unknown')}</strong>  ${esc(r.status || '')}  last update ${esc(r.updatedAt || '')}</div>`).join('')
      : '<div class="item muted">No winback queue yet.</div>';
    byId('mzUsageUpsellList').innerHTML = (m.usageUpsellQueue || []).length
      ? m.usageUpsellQueue.map(r => `<div class="item"><strong>${esc(r.username)}</strong>  jitter ${esc(r.jitter.toFixed(1))}ms  loss ${esc(r.loss.toFixed(2))}%  ${esc(r.offer)}</div>`).join('')
      : '<div class="item muted">No usage-based upsell queue yet.</div>';
    byId('mzBetaExpiryList').innerHTML = (m.betaTransition?.queue || []).length
      ? m.betaTransition.queue.map(r => `<div class="item"><strong>${esc(r.username)}</strong>  beta end ${esc(r.betaEndsAt || '')}  ${esc(String(r.daysLeft))}d left  ${esc(r.status || '')}</div>`).join('')
      : '<div class="item muted">No beta expiry queue yet.</div>';
    byId('mzLegalList').innerHTML = (m.legalAcceptances || []).length
      ? m.legalAcceptances.slice().reverse().slice(0, 80).map(r => `<div class="item"><strong>${esc(r.username)}</strong> accepted ${esc(r.version)}  ${esc(r.acceptedAt)}</div>`).join('')
      : '<div class="item muted">No legal acceptances logged.</div>';
    byId('mzPromoAbuseList').innerHTML = (m.promoGuard?.flagged || []).length
      ? m.promoGuard.flagged.map(r => `<div class="item"><strong>${esc(r.username)}</strong>  promos ${esc(String(r.promos))}  reason ${esc(r.reason || '')}</div>`).join('')
      : '<div class="item muted">No promo abuse flags.</div>';
    byId('mzChargebackList').innerHTML = (m.chargebackRiskQueue || []).length
      ? m.chargebackRiskQueue.map(r => `<div class="item"><strong>${esc(r.username || 'unknown')}</strong>  risk ${esc(String(r.score))}  ${esc(r.reason || '')}</div>`).join('')
      : '<div class="item muted">No chargeback risk queue.</div>';
    const slaRows = Object.entries(m.slaPriority || {});
    byId('mzSlaPriorityList').innerHTML = slaRows.length
      ? slaRows.map(([u, tier]) => `<div class="item"><strong>${esc(u)}</strong>  ${esc(String(tier))}</div>`).join('')
      : '<div class="item muted">No SLA priority overrides.</div>';
    const repScores = {};
    (m.referrals || []).forEach(r => {
      const k = String(r.referrer || '').toLowerCase();
      if (!k) return;
      repScores[k] = (repScores[k] || 0) + 1;
    });
    (m.affiliates || []).forEach(a => {
      const k = String(a.username || '').toLowerCase();
      if (!k) return;
      repScores[k] = (repScores[k] || 0) + 2;
    });
    const repRows = Object.entries(repScores).sort((a,b)=>b[1]-a[1]).slice(0,20);
    byId('mzRepLeaderboard').innerHTML = repRows.length
      ? repRows.map((x, i) => `<div class="item"><strong>#${i+1} ${esc(x[0])}</strong>  score ${esc(String(x[1]))}</div>`).join('')
      : '<div class="item muted">No leaderboard data yet.</div>';

    const paid = billingPayments.filter(p => String(p.status || '').toLowerCase() === 'succeeded');
    const failed = billingPayments.filter(p => ['failed', 'requires_payment_method', 'canceled', 'past_due'].includes(String(p.status || '').toLowerCase()));
    const mrr = billingSubscriptions.filter(s => ['active', 'paid', 'trialing'].includes(String(s.status || '').toLowerCase())).reduce((sum, s) => {
      const plan = billingPlans.find(p => String(p.code || '').toLowerCase() === String(s.planCode || '').toLowerCase());
      return sum + Number(plan?.amountCents || 0);
    }, 0);
    const revenueCents = paid.reduce((sum, p) => sum + Number(p.amountCents || 0), 0);
    const arpu = users.length ? (revenueCents / 100) / users.length : 0;
    byId('mzLtvStats').innerHTML = `
      <div class="item"><strong>Estimated MRR:</strong> ${billingCentsToDollarStr(mrr)}</div>
      <div class="item"><strong>Total captured payments:</strong> ${billingCentsToDollarStr(revenueCents)}</div>
      <div class="item"><strong>ARPU:</strong> $${arpu.toFixed(2)} / user</div>
      <div class="item"><strong>Successful payments:</strong> ${paid.length}  <strong>Failed/Past Due:</strong> ${failed.length}</div>
      <div class="item"><strong>Active subscriptions:</strong> ${billingSubscriptions.filter(s => ['active', 'paid', 'trialing'].includes(String(s.status || '').toLowerCase())).length}</div>
    `;

    const tiers = m.tiers || {};
    const addons = m.addons || {};
    const hints = [];
    const starter = Number(tiers.Starter || 0);
    const comp = Number(tiers.Competitive || 0);
    const elite = Number(tiers.Elite || 0);
    if (comp > 0 && comp < bench.lowest) hints.push(`Main plan is ~$${(bench.lowest - comp).toFixed(2)} below the lowest major monthly price.`);
    if (starter > 0 && comp > starter) hints.push(`Starter is your easy entry option; Competitive is your core plan.`);
    if (elite > comp) hints.push(`Elite is your high-margin upsell tier.`);
    if (Number(addons.anti_ddos || 0) > 0 || Number(addons.priority_support || 0) > 0) hints.push(`Add-ons drive extra monthly revenue without changing base plan pricing.`);
    hints.push(`Rule active: Competitive stays at $${bench.maxCompetitive}/mo or lower.`);
    byId('mzPricingHints').innerHTML = hints.length ? hints.map(x => `<div class="item">${esc(x)}</div>`).join('') : '<div class="item muted">Add tier/add-on pricing to see guidance.</div>';
    renderSimplePriceSummary();
    renderBillingCatalog();
    renderBillingReviews();
  }

  function renderAll() {
    fillUserSelectors();
    renderDashboard();
    renderRevenue();
    renderSupportBoard();
    renderLifecycle();
    renderProvisioningUsers();
    renderPresets();
    renderFleet();
    renderAudit();
    renderRunbooks();
    renderWebsite();
    renderMonetization();
    renderActions();
  }

  function wireEvents() {
    byId('loginBtn').onclick = login;
    byId('refreshBtn').onclick = refreshAll;
    byId('refreshTickets').onclick = refreshAll;
    byId('loadSecurity').onclick = loadSecurityForUser;
    byId('pvUserSearch').oninput = renderProvisioningUsers;
    byId('pvUserSearchClear').onclick = () => {
      byId('pvUserSearch').value = '';
      renderProvisioningUsers();
    };

    byId('revokeAllAccess').onclick = async () => {
      const username = byId('securityUser').value;
      if (!username) return setStatus('Select user first.', false);
      const ok = await guardAction('users.revoke_all', `revoke all access for ${username}`, {
        ownerOnly: true,
        request: { path:'/api/admin/users/revoke-access', method:'POST', body:{ username }, postAction:'loadSecurityForUser' }
      });
      if (!ok) return;
      await api('/api/admin/users/revoke-access', { method:'POST', body:JSON.stringify({ username }) });
      await loadSecurityForUser();
      appendImmutableAudit('users.revoke_all', `revoked all access for ${username}`, 'warn');
      await savePanelState();
      setStatus(`Revoked all access for ${username}`, true);
    };

    byId('deleteSecurityUser').onclick = async () => {
      if (!requirePerm('users.delete')) return;
      const username = byId('securityUser').value;
      if (!username) return setStatus('Select user first.', false);
      const ok = await confirmDanger(`delete user ${username}`);
      if (!ok) return;
      const allow = await guardAction('users.delete', `delete user ${username}`, {
        ownerOnly: true,
        request: { path:'/api/admin/users/delete', method:'POST', body:{ username }, postAction:'refreshAll' }
      });
      if (!allow) return;
      await api('/api/admin/users/delete', { method:'POST', body:JSON.stringify({ username }) });
      appendImmutableAudit('users.delete', `deleted ${username} from security panel (reason: ${ok.reason})`, 'warn');
      await savePanelState();
      await refreshAll();
      setStatus(`Deleted ${username}`, true);
    };

    byId('savePermMatrix').onclick = async () => {
      try {
        const ok = await guardAction('policy.permissions', 'update permission matrix', { ownerOnly: true });
        if (!ok) return;
        state.permissionMatrix = JSON.parse(byId('permissionMatrixBox').value || '{}');
        appendImmutableAudit('policy.permissions', 'permission matrix updated', 'warn');
        await savePanelState();
        setStatus('Permission matrix saved', true);
      } catch {
        setStatus('Invalid JSON in permission matrix', false);
      }
    };

    byId('exportAuditJson').onclick = async () => {
      const d = await api('/api/admin/audit/export?format=json');
      const blob = new Blob([JSON.stringify(d.events||[], null, 2)], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'frenzynet-audit.json'; a.click();
    };

    byId('exportAuditCsv').onclick = async () => {
      const res = await fetch(API_BASE + '/api/admin/audit/export?format=csv', { headers:{ 'Authorization':'Bearer '+token, 'X-FrenzyNets-Admin':'1' } });
      const txt = await res.text();
      const blob = new Blob([txt], { type:'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'frenzynet-audit.csv'; a.click();
    };

    byId('exportSignedDigest').onclick = async () => {
      const d = await api('/api/admin/audit/export?format=json');
      const raw = JSON.stringify(d.events || []);
      const hashBuf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(raw));
      const hashHex = [...new Uint8Array(hashBuf)].map(b => b.toString(16).padStart(2,'0')).join('');
      const payload = JSON.stringify({ generatedAt: nowIso(), count:(d.events||[]).length, sha256: hashHex }, null, 2);
      const blob = new Blob([payload], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'frenzynet-audit-digest.json'; a.click();
      setStatus('Audit digest generated', true);
    };

    byId('addRunbook').onclick = async () => {
      const title = byId('runbookTitle').value.trim();
      const body = byId('runbookBody').value.trim();
      if (!title || !body) return setStatus('Runbook title/body required', false);
      const idx = state.runbooks.findIndex(r => (r.title || '').toLowerCase() === title.toLowerCase());
      const next = { title, body, updatedAt: nowIso() };
      if (idx >= 0) state.runbooks[idx] = next; else state.runbooks.unshift(next);
      await savePanelState();
      renderRunbooks();
      setStatus('Runbook saved', true);
    };

    byId('saveBreakGlass').onclick = async () => {
      state.breakGlass = {
        owner: byId('breakGlassOwner').value.trim(),
        steps: byId('breakGlassSteps').value.trim(),
        lastUpdatedAt: nowIso()
      };
      await savePanelState();
      setStatus('Break-glass details saved', true);
    };

    byId('qLock').onclick = async () => {
      const username = byId('quickUser').value; if (!username) return setStatus('Select user first.', false);
      await api('/api/admin/users/lock', { method:'POST', body:JSON.stringify({ username, minutes:60, reason:'admin quick lock' }) });
      await refreshAll();
      setStatus(`Locked ${username}`, true);
    };
    byId('qUnlock').onclick = async () => {
      const username = byId('quickUser').value; if (!username) return setStatus('Select user first.', false);
      await api('/api/admin/users/unlock', { method:'POST', body:JSON.stringify({ username }) });
      await refreshAll();
      setStatus(`Unlocked ${username}`, true);
    };
    byId('qReset').onclick = async () => {
      const username = byId('quickUser').value; if (!username) return setStatus('Select user first.', false);
      await api('/api/admin/users/set-reset-required', { method:'POST', body:JSON.stringify({ username, required:true }) });
      await refreshAll();
      setStatus(`Password reset forced for ${username}`, true);
    };
    byId('qBackup').onclick = async () => {
      await api('/api/admin/ops/backup-now', { method:'POST', body:JSON.stringify({}) });
      await refreshAll();
      setStatus('Backup triggered', true);
    };
    byId('qRestore').onclick = async () => {
      if (!requirePerm('ops.restore')) return;
      const ok = await confirmDanger('restore latest');
      if (!ok) return;
      const allow = await guardAction('ops.restore', 'restore latest backup', {
        ownerOnly: true,
        request: { path:'/api/admin/ops/restore-latest', method:'POST', body:{ confirm:'RESTORE_LATEST' } }
      });
      if (!allow) return;
      await api('/api/admin/ops/restore-latest', { method:'POST', body:JSON.stringify({ confirm:'RESTORE_LATEST' }) });
      appendImmutableAudit('ops.restore', `restore queued (reason: ${ok.reason})`, 'warn');
      await savePanelState();
      setStatus('Restore queued', true);
    };

    byId('globalSearch').oninput = () => {
      const q = byId('globalSearch').value.trim().toLowerCase();
      if (!q) { byId('searchResults').innerHTML = '<div class="item muted">Type to search.</div>'; return; }
      const rows = [];
      users.forEach(u => { if (u.username.toLowerCase().includes(q)) rows.push(`User: ${u.username}`); });
      profiles.forEach(p => { if ((p.name||'').toLowerCase().includes(q)) rows.push(`Profile: ${p.name}`); });
      servers.forEach(s => { if ((s.name||'').toLowerCase().includes(q) || (s.host||'').toLowerCase().includes(q)) rows.push(`Server: ${s.name} (${s.host})`); });
      tickets.forEach(t => { if ((t.ticketId||'').toLowerCase().includes(q) || (t.userTag||'').toLowerCase().includes(q)) rows.push(`Ticket: ${t.ticketId} ${t.status}`); });
      byId('searchResults').innerHTML = rows.length ? rows.slice(0,40).map(r => `<div class="item">${esc(r)}</div>`).join('') : '<div class="item muted">No matches.</div>';
    };

    byId('mzSavePricing').onclick = async () => {
      ensureStateDefaults();
      state.monetization.tiers = toObj(byId('mzTiers').value, state.monetization.tiers);
      const cap = pricingBenchmarks().maxCompetitive;
      state.monetization.tiers.Competitive = Math.min(cap, Number(state.monetization.tiers?.Competitive || cap));
      state.monetization.addons = toObj(byId('mzAddons').value, state.monetization.addons);
      state.monetization.bundles = toObj(byId('mzBundles').value, state.monetization.bundles);
      await savePanelState();
      renderMonetization();
      setStatus(`Saved tiers/add-ons/bundles (Competitive capped at $${cap} max)`, true);
    };

    byId('mzAutoPrice').onclick = () => {
      const strategy = byId('mzStrategy')?.value || 'balanced';
      const { requested: target, enforced, b } = enforceCompetitiveTarget(Number(byId('mzCompTarget')?.value || 9));
      const p = buildSimplePricing(strategy, target);
      byId('mzStarter').value = p.tiers.Starter;
      byId('mzCompetitive').value = p.tiers.Competitive;
      byId('mzElite').value = p.tiers.Elite;
      byId('mzAntiDdos').value = p.addons.anti_ddos;
      byId('mzPresetAddon').value = p.addons.premium_presets;
      byId('mzPriorityAddon').value = p.addons.priority_support;
      renderSimplePriceSummary();
      if (target > enforced) {
        setStatus(`Pricing auto-filled. Competitive target was capped to $${b.maxCompetitive}. Click Publish Pricing.`, true);
      } else {
        setStatus('Pricing auto-filled. Click Publish Pricing.', true);
      }
    };

    byId('mzSaveSimplePricing').onclick = async () => {
      ensureStateDefaults();
      const floor = Number(state.monetization.promoGuard?.minMonthlyPrice || 6);
      state.monetization.tiers = {
        Starter: Math.max(floor, Number(byId('mzStarter').value || 0)),
        Competitive: Math.max(floor, Number(byId('mzCompetitive').value || 0)),
        Elite: Math.max(floor, Number(byId('mzElite').value || 0))
      };
      const cap = pricingBenchmarks().maxCompetitive;
      state.monetization.tiers.Competitive = Math.min(cap, Number(state.monetization.tiers.Competitive || cap));
      state.monetization.addons = {
        anti_ddos: Number(byId('mzAntiDdos').value || 0),
        premium_presets: Number(byId('mzPresetAddon').value || 0),
        priority_support: Number(byId('mzPriorityAddon').value || 0)
      };
      state.monetization.simpleStrategy = byId('mzStrategy')?.value || 'balanced';
      byId('mzTiers').value = JSON.stringify(state.monetization.tiers, null, 2);
      byId('mzAddons').value = JSON.stringify(state.monetization.addons, null, 2);
      const stateSnapshot = JSON.parse(JSON.stringify(state));
      const allow = await guardAction('pricing.publish', 'publish monetization pricing', {
        request: { path:'/api/admin/panel/state/save', method:'POST', body:{ state: stateSnapshot }, postAction:'refreshAll' }
      });
      if (!allow) return;
      appendImmutableAudit('pricing.publish', `strategy=${state.monetization.simpleStrategy || 'balanced'} comp=${state.monetization.tiers.Competitive}`, 'info');
      await savePanelState();
      renderMonetization();
      setStatus(`Pricing published successfully (Competitive max $${cap} rule applied).`, true);
    };

    byId('mzSaveOffers').onclick = async () => {
      ensureStateDefaults();
      state.monetization.teamPack = toObj(byId('mzTeamPack').value, state.monetization.teamPack);
      state.monetization.sla = toObj(byId('mzSla').value, state.monetization.sla);
      await savePanelState();
      renderMonetization();
      setStatus('Saved team pack and SLA offers', true);
    };

    byId('mzBuildRenewals').onclick = async () => {
      ensureStateDefaults();
      const tr = state.monetization.triggers = toObj(byId('mzTriggers').value, state.monetization.triggers);
      tr.beforeExpiryDays = Math.max(1, Number(byId('mzRenewalDays').value || tr.beforeExpiryDays || 7));
      const beforeDays = Number(tr.beforeExpiryDays || 7);
      const thresholdMs = beforeDays * 86400000;
      const now = Date.now();
      state.monetization.renewalQueue = users
        .filter(u => u.subscriptionExpiresAt)
        .map(u => ({ username:u.username, expiresAt:u.subscriptionExpiresAt, msLeft:(new Date(u.subscriptionExpiresAt).getTime()-now), trigger:`expiry-${beforeDays}d` }))
        .filter(x => x.msLeft > 0 && x.msLeft <= thresholdMs)
        .sort((a,b) => a.msLeft - b.msLeft);
      await savePanelState();
      renderMonetization();
      setStatus(`Built renewal queue (${state.monetization.renewalQueue.length})`, true);
    };

    byId('mzGenerateDiscordRenewal').onclick = async () => {
      ensureStateDefaults();
      const q = state.monetization.renewalQueue || [];
      if (!q.length) return setStatus('Build renewal queue first.', false);
      const tiers = state.monetization.tiers || {};
      const msg = [
        'Renewal follow-up batch:',
        ...q.slice(0,20).map(r => `- ${r.username}: expires ${r.expiresAt}. Offer quarterly/yearly upsell. Starter $${tiers.Starter||0}, Competitive $${tiers.Competitive||0}, Elite $${tiers.Elite||0}.`)
      ].join('\n');
      byId('mzPerfReport').value = msg;
      setStatus('Generated Discord renewal template (copied to Performance box).', true);
    };

    byId('mzAddReferral').onclick = async () => {
      ensureStateDefaults();
      const referrer = byId('mzRefFrom').value.trim().toLowerCase();
      const referred = byId('mzRefTo').value.trim().toLowerCase();
      const creditDays = Math.max(1, Number(byId('mzRefDays').value || 7));
      if (!referrer || !referred) return setStatus('Referral needs referrer and referred usernames.', false);
      await api('/api/admin/users/add-subscription-days', { method:'POST', body:JSON.stringify({ username: referrer, days: creditDays, subscriptionNote: `referral credit for ${referred}` }) });
      await api('/api/admin/users/add-subscription-days', { method:'POST', body:JSON.stringify({ username: referred, days: creditDays, subscriptionNote: `welcome referral credit from ${referrer}` }) });
      state.monetization.referrals.push({ referrer, referred, creditDays, createdAt: nowIso() });
      await savePanelState();
      await refreshAll();
      setStatus(`Referral credit applied to ${referrer} and ${referred} (+${creditDays} days).`, true);
    };

    byId('mzReloadReferralQueue').onclick = async () => {
      await refreshAll();
      setStatus('Referral queue reloaded.', true);
    };

    byId('mzBuildPerf').onclick = async () => {
      const username = byId('mzPerfUser').value;
      if (!username) return setStatus('Select a user for performance report.', false);
      const rows = telemetry.filter(t => String(t.username || '').toLowerCase() === username.toLowerCase());
      if (!rows.length) return setStatus('No telemetry data for selected user.', false);
      const avg = (arr) => arr.reduce((a,b)=>a+b,0) / Math.max(1, arr.length);
      const ping = avg(rows.map(r => Number(r.pingMs||0)));
      const jitter = avg(rows.map(r => Number(r.jitterMs||0)));
      const loss = avg(rows.map(r => Number(r.packetLossPct||0)));
      const plan = (users.find(u => u.username === username) || {}).plan || 'standard';
      const addons = state.monetization.addons || {};
      const rec = (loss > 1.5 || jitter > 20) ? `Recommend Anti-DDoS (+$${Number(addons.anti_ddos||0).toFixed(0)}) and Premium presets.` : 'Current route quality is stable.';
      byId('mzPerfReport').value =
`Performance report for ${username}
Plan: ${plan}
Average ping: ${ping.toFixed(1)} ms
Average jitter: ${jitter.toFixed(1)} ms
Average packet loss: ${loss.toFixed(2)} %
Recommendation: ${rec}`;
      setStatus(`Built performance report for ${username}`, true);
    };

    byId('mzSaveCopy').onclick = async () => {
      ensureStateDefaults();
      state.monetization.outcomeCopy = byId('mzOutcomeCopy').value.trim();
      await savePanelState();
      setStatus('Saved outcome-based sales copy.', true);
    };

    byId('mzBuildChurn').onclick = async () => {
      ensureStateDefaults();
      const d3 = Math.max(1, Number(byId('mzChurnDays3').value || 3));
      const d1 = Math.max(1, Number(byId('mzChurnDays1').value || 1));
      const now = Date.now();
      state.monetization.churnQueue = users
        .filter(u => u.subscriptionExpiresAt)
        .map(u => {
          const ms = new Date(u.subscriptionExpiresAt).getTime() - now;
          const days = Math.floor(ms / 86400000);
          const stage = days <= d1 ? 'final' : (days <= d3 ? 'early' : '');
          return { username: u.username, expiresAt: u.subscriptionExpiresAt, stage, daysLeft: days };
        })
        .filter(x => x.stage)
        .sort((a, b) => a.daysLeft - b.daysLeft);
      await savePanelState();
      renderMonetization();
      setStatus(`Built churn queue (${state.monetization.churnQueue.length}).`, true);
    };

    byId('mzGenerateChurnDm').onclick = async () => {
      ensureStateDefaults();
      const q = state.monetization.churnQueue || [];
      if (!q.length) return setStatus('Build churn queue first.', false);
      const lines = ['Churn-risk DM batch:'];
      q.slice(0, 30).forEach(x => {
        lines.push(`- ${x.username}: expires ${x.expiresAt} (${x.daysLeft}d). Offer 10-15% renewal incentive.`);
      });
      byId('mzPerfReport').value = lines.join('\n');
      setStatus('Generated churn DM batch.', true);
    };

    byId('mzGenerateCheckoutLink').onclick = async () => {
      ensureStateDefaults();
      const plan = byId('mzCheckoutPlan').value.trim();
      if (!plan) return setStatus('Select a plan first.', false);
      const addon = byId('mzCheckoutAddon').value.trim();
      const user = byId('mzCheckoutUser').value.trim().toLowerCase();
      const url = new URL('https://frenzynets.com/billing/');
      url.searchParams.set('plan', plan);
      if (addon) url.searchParams.set('addon', addon);
      if (user) url.searchParams.set('user', user);
      state.monetization.checkoutLinks.push({ plan, addon, user, url: url.toString(), createdAt: nowIso() });
      await savePanelState();
      renderMonetization();
      setStatus('Checkout link generated.', true);
    };

    byId('mzCouponCreate').onclick = async () => {
      ensureStateDefaults();
      const code = byId('mzCouponCode').value.trim().toUpperCase();
      const type = byId('mzCouponType').value;
      const value = Math.max(1, Number(byId('mzCouponValue').value || 0));
      const expiresAt = byId('mzCouponExpiry').value || '';
      if (!code) return setStatus('Coupon code is required.', false);
      state.monetization.coupons.push({ code, type, value, expiresAt, createdAt: nowIso() });
      await savePanelState();
      renderMonetization();
      setStatus(`Coupon ${code} created.`, true);
    };

    byId('mzBuildFailedRecovery').onclick = async () => {
      ensureStateDefaults();
      const badStatuses = new Set(['failed', 'requires_payment_method', 'canceled', 'past_due']);
      state.monetization.failedRecoveryQueue = billingPayments
        .filter(p => badStatuses.has(String(p.status || '').toLowerCase()))
        .slice(0, 100)
        .map(p => ({ username: p.username || 'unknown', provider: p.provider, status: p.status, amountCents: Number(p.amountCents || 0), updatedAt: p.updatedAt }));
      await savePanelState();
      renderMonetization();
      setStatus(`Built failed-payment recovery queue (${state.monetization.failedRecoveryQueue.length}).`, true);
    };

    byId('mzGenerateFailedDm').onclick = async () => {
      ensureStateDefaults();
      const q = state.monetization.failedRecoveryQueue || [];
      if (!q.length) return setStatus('Build recovery queue first.', false);
      const lines = ['Failed-payment recovery DM batch:'];
      q.slice(0, 30).forEach(x => lines.push(`- ${x.username}: payment issue (${x.status}). Send updated checkout link + support offer.`));
      byId('mzPerfReport').value = lines.join('\n');
      setStatus('Generated failed-payment DM batch.', true);
    };

    byId('mzBuildSeatQuote').onclick = async () => {
      const plan = byId('mzSeatPlan').value;
      const seats = Math.max(2, Number(byId('mzSeatCount').value || 2));
      const perSeat = Math.max(1, Number(byId('mzSeatPrice').value || 1));
      const monthly = seats * perSeat;
      const quarterly = Math.round(monthly * 3 * 0.92);
      const yearly = Math.round(monthly * 12 * 0.8);
      byId('mzSeatQuote').value = `Team Quote (${plan})\nSeats: ${seats}\nRate: $${perSeat}/seat monthly\nMonthly: $${monthly}\nQuarterly (8% off): $${quarterly}\nYearly (20% off): $${yearly}`;
      setStatus('Team seat quote generated.', true);
    };

    byId('mzAbCreate').onclick = async () => {
      ensureStateDefaults();
      const name = byId('mzAbName').value.trim();
      const priceA = Math.max(1, Number(byId('mzAbPriceA').value || 0));
      const priceB = Math.max(1, Number(byId('mzAbPriceB').value || 0));
      if (!name) return setStatus('A/B test name is required.', false);
      state.monetization.abTests.push({ name, priceA, priceB, start: byId('mzAbStart').value || '', end: byId('mzAbEnd').value || '', createdAt: nowIso() });
      await savePanelState();
      renderMonetization();
      setStatus(`A/B test "${name}" created.`, true);
    };

    byId('mzAffiliateCreate').onclick = async () => {
      ensureStateDefaults();
      const username = byId('mzAffiliateUser').value.trim().toLowerCase();
      const code = byId('mzAffiliateCode').value.trim().toUpperCase();
      const ratePct = Math.max(1, Math.min(90, Number(byId('mzAffiliateRate').value || 20)));
      if (!username || !code) return setStatus('Affiliate username and code are required.', false);
      state.monetization.affiliates.push({ username, code, ratePct, createdAt: nowIso() });
      await savePanelState();
      renderMonetization();
      setStatus(`Affiliate ${username} added.`, true);
    };

    byId('mzBuildWinback').onclick = async () => {
      ensureStateDefaults();
      const minDays = Math.max(1, Number(byId('mzWinbackDays').value || 14));
      const now = Date.now();
      state.monetization.winbackQueue = billingSubscriptions
        .filter(s => ['canceled', 'past_due', 'incomplete_expired'].includes(String(s.status || '').toLowerCase()))
        .map(s => {
          const updated = Date.parse(String(s.updatedAt || ''));
          const days = Number.isFinite(updated) ? Math.floor((now - updated) / 86400000) : 999;
          return { username: s.username || 'unknown', status: s.status, updatedAt: s.updatedAt, inactiveDays: days };
        })
        .filter(x => x.inactiveDays >= minDays)
        .sort((a, b) => b.inactiveDays - a.inactiveDays);
      await savePanelState();
      renderMonetization();
      setStatus(`Built winback queue (${state.monetization.winbackQueue.length}).`, true);
    };

    byId('mzGenerateWinbackDm').onclick = async () => {
      ensureStateDefaults();
      const q = state.monetization.winbackQueue || [];
      if (!q.length) return setStatus('Build winback queue first.', false);
      const lines = ['Winback DM batch:'];
      q.slice(0, 30).forEach(x => lines.push(`- ${x.username}: inactive ${x.inactiveDays}d. Offer comeback discount + priority support trial.`));
      byId('mzPerfReport').value = lines.join('\n');
      setStatus('Generated winback DM batch.', true);
    };

    byId('mzBuildUsageUpsell').onclick = async () => {
      ensureStateDefaults();
      const byUser = {};
      telemetry.forEach(e => {
        const u = String(e.username || '').trim();
        if (!u) return;
        if (!byUser[u]) byUser[u] = { count: 0, jitter: 0, loss: 0 };
        byUser[u].count += 1;
        byUser[u].jitter += Number(e.jitterMs || 0);
        byUser[u].loss += Number(e.packetLossPct || 0);
      });
      state.monetization.usageUpsellQueue = Object.entries(byUser)
        .map(([username, v]) => {
          const jitter = v.jitter / Math.max(1, v.count);
          const loss = v.loss / Math.max(1, v.count);
          return {
            username,
            jitter,
            loss,
            offer: (loss > 1.5 || jitter > 20) ? 'Offer Anti-DDoS + Premium Presets' : 'Offer Dedicated IP + Priority Support'
          };
        })
        .filter(x => x.loss > 1.0 || x.jitter > 15)
        .sort((a, b) => (b.loss * 10 + b.jitter) - (a.loss * 10 + a.jitter))
        .slice(0, 60);
      await savePanelState();
      renderMonetization();
      setStatus(`Built usage upsell queue (${state.monetization.usageUpsellQueue.length}).`, true);
    };

    byId('mzGenerateUsageDm').onclick = async () => {
      ensureStateDefaults();
      const q = state.monetization.usageUpsellQueue || [];
      if (!q.length) return setStatus('Build usage upsell queue first.', false);
      const lines = ['Usage-based upsell DM batch:'];
      q.slice(0, 30).forEach(x => lines.push(`- ${x.username}: jitter ${x.jitter.toFixed(1)}ms, loss ${x.loss.toFixed(2)}%. ${x.offer}.`));
      byId('mzPerfReport').value = lines.join('\n');
      setStatus('Generated usage upsell DM batch.', true);
    };

    byId('mzBuildBetaExpiry').onclick = async () => {
      ensureStateDefaults();
      const durationDays = Math.max(1, Number(byId('mzBetaDays').value || 91));
      const now = Date.now();
      const queue = users.map(u => {
        const created = Date.parse(String(u.createdAt || u.updatedAt || ''));
        const start = Number.isFinite(created) ? created : now;
        const betaEnds = start + (durationDays * 86400000);
        const daysLeft = Math.floor((betaEnds - now) / 86400000);
        return {
          username: u.username,
          betaEndsAt: new Date(betaEnds).toISOString(),
          daysLeft,
          status: daysLeft <= 0 ? 'due_for_transition' : (daysLeft <= 14 ? 'expiring_soon' : 'active_beta')
        };
      }).sort((a,b) => a.daysLeft - b.daysLeft);
      state.monetization.betaTransition.durationDays = durationDays;
      state.monetization.betaTransition.queue = queue;
      await savePanelState();
      renderMonetization();
      setStatus(`Built beta expiry queue (${queue.length}).`, true);
    };

    byId('mzSaveBetaCountdown').onclick = async () => {
      const raw = byId('mzBetaCountdownEnds').value;
      const iso = localInputToIso(raw);
      if (!iso) return setStatus('Invalid countdown date/time.', false);
      await saveWebsiteConfigToApi({ betaCountdownEndIso: iso });
      logWebsiteChange('countdown.updated', iso);
      renderWebsite();
      setStatus('Website beta countdown saved.', true);
    };

    byId('wsSaveHero').onclick = async () => {
      ensureStateDefaults();
      state.website.hero = {
        title: byId('wsHeroTitle').value.trim(),
        sub: byId('wsHeroSub').value.trim(),
        ctaPrimary: byId('wsHeroCtaPrimary').value.trim(),
        ctaSecondary: byId('wsHeroCtaSecondary').value.trim()
      };
      logWebsiteChange('hero.saved', state.website.hero.title);
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus('Hero content saved.', true);
    };

    byId('wsBannerAdd').onclick = async () => {
      ensureStateDefaults();
      const text = byId('wsBannerText').value.trim();
      const start = localInputToIso(byId('wsBannerStart').value);
      const end = localInputToIso(byId('wsBannerEnd').value);
      if (!text || !start || !end) return setStatus('Banner needs text/start/end.', false);
      state.website.bannerSchedule.push({ text, start, end, createdAt: nowIso(), createdBy: currentUser });
      logWebsiteChange('banner.scheduled', text);
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus('Banner schedule saved.', true);
    };

    byId('wsSaveTrust').onclick = async () => {
      ensureStateDefaults();
      state.website.trust = {
        uptime: byId('wsTrustUptime').value.trim(),
        users: byId('wsTrustUsers').value.trim(),
        backup: byId('wsTrustBackup').value.trim()
      };
      logWebsiteChange('trust.saved', JSON.stringify(state.website.trust));
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus('Trust badges saved.', true);
    };

    byId('wsSaveSeo').onclick = async () => {
      ensureStateDefaults();
      state.website.seo = {
        title: byId('wsSeoTitle').value.trim(),
        description: byId('wsSeoDesc').value.trim(),
        ogImage: byId('wsSeoOgImage').value.trim(),
        discordCard: byId('wsSeoDiscordCard').value.trim()
      };
      logWebsiteChange('seo.saved', state.website.seo.title);
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus('SEO/social settings saved.', true);
    };

    byId('wsSaveIncident').onclick = async () => {
      ensureStateDefaults();
      state.website.incident = {
        mode: byId('wsIncidentMode').value,
        text: byId('wsIncidentText').value.trim()
      };
      logWebsiteChange('incident.saved', `${state.website.incident.mode}`);
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus('Incident mode saved.', true);
    };

    byId('wsSaveGate').onclick = async () => {
      ensureStateDefaults();
      state.website.downloadGate = {
        dotnet: byId('wsGateDotnet').value,
        wireguard: byId('wsGateWireguard').value,
        admin: byId('wsGateAdmin').value
      };
      logWebsiteChange('download_gate.saved', JSON.stringify(state.website.downloadGate));
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus('Download gate saved.', true);
    };

    byId('wsAbAdd').onclick = async () => {
      ensureStateDefaults();
      const name = byId('wsAbName').value.trim();
      const a = byId('wsAbA').value.trim();
      const b = byId('wsAbB').value.trim();
      if (!name || !a || !b) return setStatus('A/B test needs name, A, and B.', false);
      state.website.abTests.push({ name, a, b, aViews:0, bViews:0, aConversions:0, bConversions:0, winner:'pending', createdAt: nowIso() });
      logWebsiteChange('ab.created', name);
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus('A/B test created.', true);
    };

    byId('wsAbPickWinner').onclick = async () => {
      ensureStateDefaults();
      let updated = 0;
      (state.website.abTests || []).forEach(t => {
        const ra = Number(t.aViews || 0) > 0 ? Number(t.aConversions || 0) / Number(t.aViews || 1) : 0;
        const rb = Number(t.bViews || 0) > 0 ? Number(t.bConversions || 0) / Number(t.bViews || 1) : 0;
        t.winner = ra === rb ? 'tie' : (ra > rb ? 'A' : 'B');
        updated += 1;
      });
      logWebsiteChange('ab.winner_picked', `${updated} tests`);
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus(`Winner selected for ${updated} test(s).`, true);
    };

    byId('wsSaveFunnel').onclick = async () => {
      ensureStateDefaults();
      state.website.funnel = {
        visits: Math.max(0, Number(byId('wsVisits').value || 0)),
        billingClicks: Math.max(0, Number(byId('wsBillingClicks').value || 0)),
        checkouts: Math.max(0, Number(byId('wsCheckouts').value || 0))
      };
      logWebsiteChange('funnel.saved', JSON.stringify(state.website.funnel));
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus('Funnel metrics saved.', true);
    };

    byId('wsPublishNow').onclick = async () => {
      ensureStateDefaults();
      const websiteStateForSnapshot = JSON.parse(JSON.stringify(state.website || {}));
      websiteStateForSnapshot.releaseSnapshots = [];
      websiteStateForSnapshot.changeLog = (websiteStateForSnapshot.changeLog || []).slice(-100);
      const snapshot = {
        id: `snap_${Date.now()}`,
        at: nowIso(),
        actor: currentUser,
        website: websiteStateForSnapshot,
        siteConfig: JSON.parse(JSON.stringify(siteConfig || {}))
      };
      state.website.releaseSnapshots.push(snapshot);
      if (state.website.releaseSnapshots.length > 50) state.website.releaseSnapshots.splice(0, state.website.releaseSnapshots.length - 50);
      let health = 'unknown';
      try {
        const d = await api('/api/public/ping');
        health = d?.ok ? 'ok' : 'degraded';
      } catch {
        health = 'unreachable';
      }
      logWebsiteChange('publish.executed', `snapshot=${snapshot.id}, health=${health}`);
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus(`Website publish complete. Health: ${health}. Snapshot: ${snapshot.id}`, health === 'ok');
    };

    byId('wsRollbackApply').onclick = async () => {
      ensureStateDefaults();
      const pick = byId('wsRollbackPick').value;
      if (!pick) return setStatus('Select a snapshot first.', false);
      const snap = (state.website.releaseSnapshots || []).find(s => s.id === pick);
      if (!snap) return setStatus('Snapshot not found.', false);
      const keepSnapshots = state.website.releaseSnapshots || [];
      const keepLog = state.website.changeLog || [];
      state.website = JSON.parse(JSON.stringify(snap.website || state.website));
      state.website.releaseSnapshots = keepSnapshots;
      state.website.changeLog = keepLog;
      const iso = String(snap.siteConfig?.betaCountdownEndIso || '').trim();
      if (iso) {
        try {
          await saveWebsiteConfigToApi({ betaCountdownEndIso: iso });
        } catch {}
      }
      logWebsiteChange('rollback.executed', pick);
      await saveWebsiteConfigToApi();
      renderWebsite();
      setStatus(`Rolled back website settings to ${pick}.`, true);
    };

    byId('mzApplyBetaTransition').onclick = async () => {
      ensureStateDefaults();
      const queue = (state.monetization.betaTransition?.queue || []).filter(x => x.daysLeft <= 0);
      if (!queue.length) return setStatus('No users currently due for beta transition.', false);
      let changed = 0;
      for (const item of queue.slice(0, 200)) {
        try {
          await api('/api/admin/users/set-plan', { method:'POST', body:JSON.stringify({ username:item.username, plan:'standard' }) });
          await api('/api/admin/users/set-subscription', { method:'POST', body:JSON.stringify({ username:item.username, subscriptionNote:'auto beta transition -> standard pricing' }) });
          changed += 1;
        } catch {}
      }
      state.monetization.betaTransition.lastAppliedAt = nowIso();
      await savePanelState();
      await refreshAll();
      setStatus(`Applied beta->standard transition for ${changed} user(s).`, true);
    };

    byId('mzGenerateExeBanner').onclick = async () => {
      ensureStateDefaults();
      const queue = (state.monetization.betaTransition?.queue || []).filter(x => x.daysLeft >= 0).sort((a,b)=>a.daysLeft-b.daysLeft);
      const next = queue.length ? queue[0] : null;
      const text = next
        ? `Beta pricing ends in ${next.daysLeft} day(s) for some accounts. Renew now to keep lower intro rates before standard pricing starts.`
        : 'Beta intro pricing is active for the first 3 months from signup. Standard pricing applies after beta period.';
      state.monetization.exeBannerText = text;
      byId('mzExeBannerText').value = text;
      await savePanelState();
      setStatus('Generated EXE beta banner text.', true);
    };

    byId('mzLegalAccept').onclick = async () => {
      ensureStateDefaults();
      const username = byId('mzLegalUser').value.trim().toLowerCase();
      const version = byId('mzLegalVersion').value.trim() || 'beta-v1';
      if (!username) return setStatus('Legal log needs username.', false);
      state.monetization.legalAcceptances.push({ username, version, acceptedAt: nowIso(), actor: currentUser });
      await savePanelState();
      renderMonetization();
      setStatus(`Logged legal acceptance for ${username}.`, true);
    };

    byId('mzSavePromoGuard').onclick = async () => {
      ensureStateDefaults();
      state.monetization.promoGuard = {
        maxPromosPerUser: Math.max(1, Number(byId('mzGuardMaxPromos').value || 1)),
        cooldownDays: Math.max(1, Number(byId('mzGuardCooldownDays').value || 30)),
        minMonthlyPrice: Math.max(1, Number(byId('mzGuardMinPrice').value || 6)),
        flagged: state.monetization.promoGuard?.flagged || []
      };
      await savePanelState();
      renderMonetization();
      setStatus('Promo guardrails saved.', true);
    };

    byId('mzScanPromoAbuse').onclick = async () => {
      ensureStateDefaults();
      const g = state.monetization.promoGuard || { maxPromosPerUser: 1, minMonthlyPrice: 6 };
      const byUser = {};
      (state.monetization.checkoutLinks || []).forEach(x => {
        const u = String(x.user || '').toLowerCase();
        if (!u) return;
        byUser[u] = (byUser[u] || 0) + 1;
      });
      const flagged = [];
      Object.entries(byUser).forEach(([u, count]) => {
        if (count > Number(g.maxPromosPerUser || 1)) flagged.push({ username: u, promos: count, reason: 'too_many_promos' });
      });
      const lowPrice = Number(byId('mzCompetitive')?.value || 0);
      if (lowPrice > 0 && lowPrice < Number(g.minMonthlyPrice || 6)) {
        flagged.push({ username: 'global', promos: 0, reason: `price_below_floor_${g.minMonthlyPrice}` });
      }
      state.monetization.promoGuard.flagged = flagged;
      await savePanelState();
      renderMonetization();
      setStatus(`Promo abuse scan complete (${flagged.length} flag(s)).`, true);
    };

    byId('mzBuildChargebackRisk').onclick = async () => {
      ensureStateDefaults();
      const risk = [];
      const bad = new Set(['failed','requires_payment_method','canceled','past_due','disputed','chargeback']);
      billingPayments.forEach(p => {
        const st = String(p.status || '').toLowerCase();
        if (!bad.has(st)) return;
        const amt = Number(p.amountCents || 0);
        let score = 40;
        if (st === 'chargeback' || st === 'disputed') score += 40;
        if (amt >= 3000) score += 15;
        if (String(p.provider || '').toLowerCase() === 'cashapp') score += 10;
        risk.push({ username: p.username || 'unknown', score, reason: `${st} (${billingCentsToDollarStr(amt)})` });
      });
      state.monetization.chargebackRiskQueue = risk.sort((a,b)=>b.score-a.score).slice(0,100);
      await savePanelState();
      renderMonetization();
      setStatus(`Chargeback risk queue built (${state.monetization.chargebackRiskQueue.length}).`, true);
    };

    byId('mzGenerateRefundTemplates').onclick = async () => {
      ensureStateDefaults();
      const txt = [
        'Refund Template - First-Time Technical Issue:',
        'We can offer account credit or a refund if issue remains unresolved after troubleshooting.',
        '',
        'Refund Template - Duplicate Charge:',
        'We verified duplicate billing and will process a refund/credit within 1-3 business days.',
        '',
        'Refund Template - Policy Reminder:',
        'Beta pricing is intro-only (first 3 months). Refund eligibility follows posted terms and usage checks.'
      ].join('\n');
      state.monetization.refundTemplates = txt;
      byId('mzRefundTemplates').value = txt;
      await savePanelState();
      setStatus('Refund templates generated.', true);
    };

    byId('mzGenerateDiscordCommands').onclick = async () => {
      ensureStateDefaults();
      const cmd = [
        '/price plan:<starter|competitive|elite|quarterly|semiannual> add_on:<optional>',
        '/invoice user:<name> plan:<code> amount:<usd>',
        '/lookup user:<name>',
        '/renewal user:<name> days:<7|30|90>',
        '/support user:<name> issue:<text>',
        '/promo user:<name> code:<coupon>'
      ].join('\n');
      state.monetization.discordCommandKit = cmd;
      byId('mzDiscordCommands').value = cmd;
      await savePanelState();
      setStatus('Discord slash command kit generated.', true);
    };

    byId('mzSetSlaPriority').onclick = async () => {
      ensureStateDefaults();
      const username = byId('mzSlaUser').value.trim().toLowerCase();
      const tier = byId('mzSlaTier').value;
      if (!username) return setStatus('SLA priority needs username.', false);
      state.monetization.slaPriority[username] = tier;
      await savePanelState();
      renderMonetization();
      setStatus(`SLA priority set for ${username} -> ${tier}.`, true);
    };

    byId('mzGenerateWeeklyReport').onclick = async () => {
      ensureStateDefaults();
      const paid = billingPayments.filter(p => String(p.status || '').toLowerCase() === 'succeeded');
      const failed = billingPayments.filter(p => ['failed','requires_payment_method','canceled','past_due'].includes(String(p.status || '').toLowerCase()));
      const mrr = billingSubscriptions.filter(s => ['active','paid','trialing'].includes(String(s.status || '').toLowerCase())).reduce((sum, s) => {
        const plan = billingPlans.find(p => String(p.code || '').toLowerCase() === String(s.planCode || '').toLowerCase());
        return sum + Number(plan?.amountCents || 0);
      }, 0);
      const topUpsell = (state.monetization.usageUpsellQueue || []).slice(0, 5).map(x => `${x.username} (${x.offer})`);
      const report = [
        `Weekly Report - ${new Date().toISOString().slice(0,10)}`,
        `MRR: ${billingCentsToDollarStr(mrr)}`,
        `Active subs: ${billingSubscriptions.filter(s => ['active','paid','trialing'].includes(String(s.status || '').toLowerCase())).length}`,
        `Successful payments: ${paid.length}`,
        `Failed/past_due payments: ${failed.length}`,
        `Churn-risk users: ${(state.monetization.churnQueue || []).length}`,
        `Winback queue: ${(state.monetization.winbackQueue || []).length}`,
        `Top upsell targets: ${topUpsell.length ? topUpsell.join('; ') : 'none'}`
      ].join('\n');
      state.monetization.weeklyReport = report;
      byId('mzWeeklyReport').value = report;
      await savePanelState();
      setStatus('Weekly business report generated.', true);
    };

    byId('mzBillingReload').onclick = async () => {
      await loadBillingCatalog(false);
    };
    byId('mzReviewsReload').onclick = async () => {
      await loadBillingReviewRequests(false);
    };

    byId('mzApplyPlanTemplate').onclick = () => {
      const key = byId('mzPlanTemplate').value;
      if (!key) {
        setStatus('Select a plan template first.', false);
        return;
      }
      if (!applyPlanTemplate(key)) {
        setStatus('Invalid plan template selected.', false);
        return;
      }
      setStatus('Plan template applied. Add Stripe price ID and save.', true);
    };

    byId('mzApplyAddonTemplate').onclick = () => {
      const key = byId('mzAddonTemplate').value;
      if (!key) return setStatus('Select an add-on template first.', false);
      if (!applyAddonTemplate(key)) return setStatus('Invalid add-on template selected.', false);
      setStatus('Add-on template applied.', true);
    };

    async function publishPlanTemplates(templates) {
      try {
        for (const t of templates) {
          await api('/api/admin/billing/plans/set', {
            method: 'POST',
            body: JSON.stringify({
              code: t.code,
              name: t.name,
              description: withBetaIntro(t.description),
              amountCents: t.amountCents,
              currency: t.currency,
              stripePriceId: t.stripePriceId || '',
              interval: t.interval,
              entitlementDays: t.entitlementDays,
              enabled: t.enabled !== false,
              sortOrder: t.sortOrder || 100
            })
          });
        }
        return true;
      } catch (e) {
        setStatus('Publish core plans failed: ' + e.message, false);
        return false;
      }
    }

    async function publishAddonTemplates(templates) {
      try {
        for (const t of templates) {
          await api('/api/admin/billing/addons/set', {
            method: 'POST',
            body: JSON.stringify({
              code: t.code,
              name: t.name,
              description: withBetaIntro(t.description || ''),
              amountCents: Number(t.amountCents || 0),
              currency: t.currency || 'USD',
              stripePriceId: t.stripePriceId || '',
              maxQuantity: Number(t.maxQuantity || 1),
              enabled: t.enabled !== false,
              sortOrder: t.sortOrder || 100
            })
          });
        }
        return true;
      } catch (e) {
        setStatus('Publish core add-ons failed: ' + e.message, false);
        return false;
      }
    }

    byId('mzPublishCorePlans').onclick = async () => {
      const ok = await publishPlanTemplates(corePlanTemplates());
      if (!ok) return;
      await loadBillingCatalog(true);
      setStatus('Published core plans (weekly/monthly/yearly) to live billing API.', true);
    };

    byId('mzPublishCoreAddons').onclick = async () => {
      const ok = await publishAddonTemplates(coreAddonTemplates());
      if (!ok) return;
      await loadBillingCatalog(true);
      setStatus('Published core add-ons (Anti-DDoS, Presets, Priority Support) to live billing API.', true);
    };

    byId('mzPublishRevenueCatalog').onclick = async () => {
      const plansOk = await publishPlanTemplates(fullPlanTemplates());
      if (!plansOk) return;
      const addonsOk = await publishAddonTemplates(fullAddonTemplates());
      if (!addonsOk) return;
      await loadBillingCatalog(true);
      setStatus('Published full revenue catalog (expanded plans + add-ons).', true);
    };

    byId('mzPublishCompetitiveCatalog').onclick = async () => {
      const b = pricingBenchmarks();
      const monthly = Math.min(1099, Math.max(899, Math.round((b.lowest - 2.0) * 100)));
      const weekly = Math.max(399, Math.round(monthly * 0.5));
      const yearly = Math.max(8999, Math.round(monthly * 10));
      BILLING_PLAN_TEMPLATES.weekly_gamer.amountCents = weekly;
      BILLING_PLAN_TEMPLATES.monthly_gamer.amountCents = monthly;
      BILLING_PLAN_TEMPLATES.yearly_gamer.amountCents = yearly;
      const plansOk = await publishPlanTemplates(corePlanTemplates());
      if (!plansOk) return;
      const addonsOk = await publishAddonTemplates(coreAddonTemplates());
      if (!addonsOk) return;
      await loadBillingCatalog(true);
      setStatus(`Published competitive catalog (monthly ${billingCentsToDollarStr(monthly)} vs peer floor $${b.lowest.toFixed(2)}).`, true);
    };

    byId('mzApplyAddonTier').onclick = async () => {
      ensureStateDefaults();
      const tier = byId('mzAddonTier')?.value || 'popular';
      const ok = await publishAddonTemplates(tieredAddonTemplates(tier));
      if (!ok) return;
      state.monetization.addonTier = tier;
      state.monetization.lastPricingSheet = buildDiscordPricingSheet(tier);
      byId('mzPricingSheet').value = state.monetization.lastPricingSheet;
      await savePanelState();
      await loadBillingCatalog(true);
      setStatus(`Published ${tierLabel(tier)} tier add-on pricing.`, true);
    };

    byId('mzGeneratePricingSheet').onclick = async () => {
      ensureStateDefaults();
      const tier = byId('mzAddonTier')?.value || state.monetization.addonTier || 'popular';
      const sheet = buildDiscordPricingSheet(tier);
      state.monetization.addonTier = tier;
      state.monetization.lastPricingSheet = sheet;
      byId('mzPricingSheet').value = sheet;
      byId('mzPerfReport').value = sheet;
      await savePanelState();
      setStatus(`Generated Discord pricing sheet (${tierLabel(tier)}).`, true);
    };

    byId('mzPlanSave').onclick = async () => {
      const code = byId('mzPlanCode').value.trim().toLowerCase();
      const name = byId('mzPlanName').value.trim();
      const amountCents = Number(byId('mzPlanAmountCents').value || 0);
      if (!code || !name || amountCents <= 0) {
        setStatus('Plan code, name, and amount cents are required.', false);
        return;
      }
      await api('/api/admin/billing/plans/set', {
        method: 'POST',
        body: JSON.stringify({
          code,
          name,
          description: byId('mzPlanDescription').value.trim(),
          amountCents,
          currency: byId('mzPlanCurrency').value.trim().toUpperCase() || 'USD',
          interval: byId('mzPlanInterval').value,
          entitlementDays: Number(byId('mzPlanEntitlementDays').value || 30),
          stripePriceId: byId('mzPlanStripePriceId').value.trim(),
          enabled: byId('mzPlanEnabled').value === 'true',
          sortOrder: Number(byId('mzPlanSortOrder').value || 100)
        })
      });
      await loadBillingCatalog(true);
      setStatus(`Saved live billing plan: ${code}`, true);
    };

    byId('mzPlanDelete').onclick = async () => {
      const code = byId('mzPlanCode').value.trim().toLowerCase();
      if (!code) {
        setStatus('Enter a plan code to delete.', false);
        return;
      }
      if (!confirm(`Delete plan "${code}"?`)) return;
      await api('/api/admin/billing/plans/delete', { method: 'POST', body: JSON.stringify({ code }) });
      fillPlanForm(null);
      await loadBillingCatalog(true);
      setStatus(`Deleted plan: ${code}`, true);
    };

    byId('mzAddonSave').onclick = async () => {
      const code = byId('mzAddonCode').value.trim().toLowerCase();
      const name = byId('mzAddonName').value.trim();
      const amountCents = Number(byId('mzAddonAmountCents').value || 0);
      if (!code || !name || amountCents <= 0) {
        setStatus('Add-on code, name, and amount cents are required.', false);
        return;
      }
      await api('/api/admin/billing/addons/set', {
        method: 'POST',
        body: JSON.stringify({
          code,
          name,
          description: byId('mzAddonDescription').value.trim(),
          amountCents,
          currency: byId('mzAddonCurrency').value.trim().toUpperCase() || 'USD',
          stripePriceId: byId('mzAddonStripePriceId').value.trim(),
          maxQuantity: Number(byId('mzAddonMaxQuantity').value || 1),
          enabled: byId('mzAddonEnabled').value === 'true',
          sortOrder: Number(byId('mzAddonSortOrder').value || 100)
        })
      });
      await loadBillingCatalog(true);
      setStatus(`Saved live billing add-on: ${code}`, true);
    };

    byId('mzAddonDelete').onclick = async () => {
      const code = byId('mzAddonCode').value.trim().toLowerCase();
      if (!code) {
        setStatus('Enter an add-on code to delete.', false);
        return;
      }
      if (!confirm(`Delete add-on "${code}"?`)) return;
      await api('/api/admin/billing/addons/delete', { method: 'POST', body: JSON.stringify({ code }) });
      fillAddonForm(null);
      await loadBillingCatalog(true);
      setStatus(`Deleted add-on: ${code}`, true);
    };

    fillPlanForm(null);
    fillAddonForm(null);

    // Provisioning hub handlers
    byId('pvCreateUser').onclick = async () => {
      if (!requirePerm('users.create')) return;
      const username = byId('pvNewUser').value.trim().toLowerCase();
      const password = byId('pvNewPass').value;
      if (!username || !password) return setStatus('Create user requires username/password', false);
      await api('/api/admin/users/create', { method:'POST', body:JSON.stringify({
        username, password, role:'user', isAdmin:false,
        plan: byId('pvPlan').value,
        updateChannel: byId('pvChannel').value,
        allowedProfiles: csv(byId('pvProfiles').value)
      })});
      await refreshAll();
      setStatus(`Created user ${username}`, true);
    };

    byId('pvSetRole').onclick = async () => {
      if (!requirePerm('users.role')) return;
      const username = byId('pvUserTarget').value;
      const role = byId('pvRole').value;
      if (!username) return setStatus('Select user first.', false);
      await api('/api/admin/users/set-role', { method:'POST', body:JSON.stringify({ username, role, isAdmin: role === 'admin' }) });
      await refreshAll();
      setStatus(`Updated role for ${username} -> ${role}`, true);
    };

    byId('pvSetPassword').onclick = async () => {
      if (!requirePerm('users.password')) return;
      const username = byId('pvUserTarget').value;
      const password = byId('pvSetPass').value;
      if (!username || !password) return setStatus('Select user and provide password', false);
      await api('/api/admin/users/set-password', { method:'POST', body:JSON.stringify({ username, password }) });
      setStatus(`Password updated for ${username}`, true);
    };

    byId('pvForceReset').onclick = async () => {
      if (!requirePerm('users.reset')) return;
      const username = byId('pvUserTarget').value;
      if (!username) return setStatus('Select user first.', false);
      await api('/api/admin/users/set-reset-required', { method:'POST', body:JSON.stringify({ username, required:true }) });
      await refreshAll();
      setStatus(`Reset required for ${username}`, true);
    };

    byId('pvApplyPlan').onclick = async () => {
      if (!requirePerm('users.plan')) return;
      const username = byId('pvUserTarget').value;
      if (!username) return setStatus('Select user first.', false);
      await api('/api/admin/users/set-plan', { method:'POST', body:JSON.stringify({ username, plan: byId('pvSetPlan').value }) });
      await refreshAll();
      setStatus(`Plan updated for ${username}`, true);
    };

    byId('pvApplyChannel').onclick = async () => {
      if (!requirePerm('users.channel')) return;
      const username = byId('pvUserTarget').value;
      if (!username) return setStatus('Select user first.', false);
      await api('/api/admin/users/set-channel', { method:'POST', body:JSON.stringify({ username, updateChannel: byId('pvSetChannel').value }) });
      await refreshAll();
      setStatus(`Channel updated for ${username}`, true);
    };

    byId('pvSetSubscription').onclick = async () => {
      if (!requirePerm('users.subscription')) return;
      const username = byId('pvUserTarget').value;
      if (!username) return setStatus('Select user first.', false);
      const subscriptionExpiresAt = byId('pvSubscriptionExpiry').value.trim();
      const subscriptionNote = byId('pvSubscriptionNote').value.trim();
      await api('/api/admin/users/set-subscription', { method:'POST', body:JSON.stringify({ username, subscriptionExpiresAt, subscriptionNote }) });
      await refreshAll();
      setStatus(`Subscription updated for ${username}`, true);
    };

    byId('pvLockUser').onclick = async () => {
      if (!requirePerm('users.lock')) return;
      const username = byId('pvUserTarget').value;
      if (!username) return setStatus('Select user first.', false);
      await api('/api/admin/users/lock', { method:'POST', body:JSON.stringify({ username, minutes:60, reason:'provisioning lock' }) });
      await refreshAll();
      setStatus(`Locked ${username}`, true);
    };

    byId('pvUnlockUser').onclick = async () => {
      if (!requirePerm('users.unlock')) return;
      const username = byId('pvUserTarget').value;
      if (!username) return setStatus('Select user first.', false);
      await api('/api/admin/users/unlock', { method:'POST', body:JSON.stringify({ username }) });
      await refreshAll();
      setStatus(`Unlocked ${username}`, true);
    };

    byId('pvDeleteUser').onclick = async () => {
      if (!requirePerm('users.delete')) return;
      const username = byId('pvUserTarget').value;
      if (!username) return setStatus('Select user first.', false);
      const ok = await confirmDanger(`delete user ${username}`);
      if (!ok) return;
      const allow = await guardAction('users.delete', `delete user ${username}`, {
        ownerOnly: true,
        request: { path:'/api/admin/users/delete', method:'POST', body:{ username }, postAction:'refreshAll' }
      });
      if (!allow) return;
      await api('/api/admin/users/delete', { method:'POST', body:JSON.stringify({ username }) });
      appendImmutableAudit('users.delete', `deleted ${username} (reason: ${ok.reason})`, 'warn');
      await savePanelState();
      await refreshAll();
      setStatus(`Deleted ${username}`, true);
    };

    byId('pvCreateProfile').onclick = async () => {
      if (!requirePerm('profiles.create')) return;
      const name = byId('pvProfileName').value.trim();
      const configText = byId('pvProfileConfig').value;
      if (!name || !configText) return setStatus('Profile name/config required', false);
      await api('/api/admin/profiles/create', { method:'POST', body:JSON.stringify({
        name, configText, tier: byId('pvProfileTier').value,
        region: byId('pvProfileRegion').value.trim() || 'global',
        serverPool: byId('pvProfilePool').value.trim() || 'default'
      })});
      await refreshAll();
      setStatus(`Created profile ${name}`, true);
    };

    byId('pvSetProfileTier').onclick = async () => {
      if (!requirePerm('profiles.update')) return;
      const profileName = byId('pvProfileName').value.trim();
      if (!profileName) return setStatus('Profile name required', false);
      await api('/api/admin/profiles/set-tier', { method:'POST', body:JSON.stringify({ profileName, tier: byId('pvProfileTier').value }) });
      await refreshAll();
      setStatus(`Updated tier for ${profileName}`, true);
    };

    byId('pvSetProfileMeta').onclick = async () => {
      if (!requirePerm('profiles.update')) return;
      const profileName = byId('pvProfileName').value.trim();
      if (!profileName) return setStatus('Profile name required', false);
      await api('/api/admin/profiles/set-meta', { method:'POST', body:JSON.stringify({
        profileName,
        region: byId('pvProfileRegion').value.trim() || 'global',
        serverPool: byId('pvProfilePool').value.trim() || 'default'
      })});
      await refreshAll();
      setStatus(`Updated meta for ${profileName}`, true);
    };

    byId('pvCreateServer').onclick = async () => {
      if (!requirePerm('servers.create')) return;
      const name = byId('pvServerName').value.trim();
      const host = byId('pvServerHost').value.trim();
      if (!name || !host) return setStatus('Server name/host required', false);
      await api('/api/admin/servers/create', { method:'POST', body:JSON.stringify({
        name, host,
        publicIp: byId('pvServerIp').value.trim(),
        region: byId('pvServerRegion').value.trim() || 'global',
        serverPool: byId('pvServerPool').value.trim() || 'default',
        status: byId('pvServerStatus').value,
        tier: byId('pvServerTier').value
      })});
      await refreshAll();
      setStatus(`Created server ${name}`, true);
    };

    byId('pvUpdateServer').onclick = async () => {
      if (!requirePerm('servers.update')) return;
      const name = byId('pvServerName').value.trim();
      if (!name) return setStatus('Server name required', false);
      await api('/api/admin/servers/update', { method:'POST', body:JSON.stringify({
        name,
        host: byId('pvServerHost').value.trim(),
        publicIp: byId('pvServerIp').value.trim(),
        region: byId('pvServerRegion').value.trim() || 'global',
        serverPool: byId('pvServerPool').value.trim() || 'default',
        status: byId('pvServerStatus').value,
        tier: byId('pvServerTier').value
      })});
      await refreshAll();
      setStatus(`Updated server ${name}`, true);
    };

    byId('pvEnrollToken').onclick = async () => {
      if (!requirePerm('servers.enroll')) return;
      const ttlMinutes = 60;
      const d = await api('/api/admin/servers/enroll-token', { method:'POST', body:JSON.stringify({
        ttlMinutes,
        defaultRegion: byId('pvServerRegion').value.trim() || 'global',
        defaultServerPool: byId('pvServerPool').value.trim() || 'default',
        defaultTier: byId('pvServerTier').value
      })});
      byId('pvServerOutput').value = JSON.stringify(d, null, 2);
      setStatus('Generated enroll token', true);
    };

    byId('pvBootstrapNode').onclick = async () => {
      if (!requirePerm('servers.bootstrap')) return;
      const host = byId('pvNodeIp').value.trim();
      const sshUser = byId('pvNodeUser').value.trim();
      const sshPassword = byId('pvNodePass').value;
      const nodeType = byId('pvNodeType').value;
      const name = byId('pvServerName').value.trim() || `${nodeType}-${host.replace(/[^a-zA-Z0-9.-]/g,'-')}`;
      if (!host || !sshUser || !sshPassword) return setStatus('Node bootstrap needs ip + ssh user + ssh password.', false);
      const allow = await guardAction('servers.bootstrap', `bootstrap ${nodeType} node ${name}`, {
        ownerOnly: true,
        allowQueue: false
      });
      if (!allow) return;
      byId('pvServerOutput').value = 'Running bootstrap...\nThis can take a few minutes.';
      try {
        const d = await api('/api/admin/servers/bootstrap-ssh', { method:'POST', body:JSON.stringify({
          name,
          host,
          sshUser,
          sshPassword,
          sshPort: 22,
          nodeType,
          region: byId('pvServerRegion').value.trim() || 'global',
          publicIp: byId('pvServerIp').value.trim() || host,
          notes: `bootstrap via admin ui (${nodeType})`
        })});
        byId('pvServerOutput').value = JSON.stringify(d, null, 2);
        byId('pvNodePass').value = '';
        appendImmutableAudit('servers.bootstrap', `bootstrapped ${name} (${nodeType})`, 'info');
        await savePanelState();
        await refreshAll();
        setStatus(`Bootstrap complete for ${name}`, true);
      } catch (e) {
        byId('pvServerOutput').value = `Bootstrap failed:\n${e.message}`;
        appendImmutableAudit('servers.bootstrap_failed', `${name}: ${e.message}`, 'bad');
        await savePanelState();
        setStatus(`Bootstrap failed: ${e.message}`, false);
      }
    };

    byId('entSavePolicy').onclick = async () => {
      ensureStateDefaults();
      if (!isOwnerUser()) return setStatus('Only owners can edit enterprise policy.', false);
      state.enterprise.ownerUsers = csv(byId('entOwnerUsers').value.toLowerCase());
      state.enterprise.requireApprovals = byId('entRequireApprovals').value === 'yes';
      state.enterprise.requireReason = byId('entRequireReason').value === 'yes';
      state.enterprise.approvalMatrix = toObj(byId('entApprovalMatrix').value, state.enterprise.approvalMatrix);
      appendImmutableAudit('policy.enterprise', 'enterprise policy updated', 'warn');
      await savePanelState();
      renderAudit();
      setStatus('Enterprise access policy saved.', true);
    };

    byId('entSaveSecurity').onclick = async () => {
      ensureStateDefaults();
      if (!isOwnerUser()) return setStatus('Only owners can edit security baseline.', false);
      state.enterprise.security = {
        mfaRequiredRoles: csv(byId('entMfaRoles').value),
        sessionTimeoutMin: Math.max(5, Number(byId('entSessionTimeout').value || 45)),
        ipAllowlist: byId('entIpAllowlist').value.trim(),
        trustedDevicesOnly: byId('entTrustedDevices').value === 'yes',
        rateLimitPerMin: Math.max(5, Number(byId('entRateLimit').value || 60))
      };
      appendImmutableAudit('policy.security', 'security baseline updated', 'warn');
      await savePanelState();
      renderAudit();
      setStatus('Security baseline saved.', true);
    };

    byId('entSaveMonitoring').onclick = async () => {
      ensureStateDefaults();
      if (!isOwnerUser()) return setStatus('Only owners can edit monitoring.', false);
      state.enterprise.monitoring = {
        apiLatencyWarnMs: Math.max(50, Number(byId('entApiLatencyWarn').value || 500)),
        errorRateWarnPct: Math.max(1, Number(byId('entErrorRateWarn').value || 2)),
        discordAlertChannel: byId('entAlertChannel').value.trim() || '#ops-alerts',
        notifyOnLoginFailures: byId('entNotifyLoginFail').value === 'yes'
      };
      appendImmutableAudit('policy.monitoring', 'monitoring thresholds updated', 'info');
      await savePanelState();
      renderAudit();
      setStatus('Monitoring policy saved.', true);
    };

    byId('entSaveOperations').onclick = async () => {
      ensureStateDefaults();
      if (!isOwnerUser()) return setStatus('Only owners can edit governance.', false);
      state.enterprise.backups = {
        dailyHourUtc: Math.min(23, Math.max(0, Number(byId('entBackupHourUtc').value || 2))),
        retentionDays: Math.max(1, Number(byId('entBackupRetention').value || 30)),
        encrypted: true,
        testRestoreEveryDays: Math.max(1, Number(byId('entRestoreDrillDays').value || 14)),
        lastRestoreDrillAt: state.enterprise.backups?.lastRestoreDrillAt || ''
      };
      state.enterprise.secrets.rotationDays = Math.max(1, Number(byId('entSecretsRotationDays').value || 30));
      state.enterprise.governance = {
        stages: ['dev','canary','prod'],
        requireTicket: byId('entRequireTicket').value === 'yes',
        requirePeerReview: byId('entRequirePeerReview').value === 'yes'
      };
      appendImmutableAudit('policy.operations', 'backup/governance policy updated', 'info');
      await savePanelState();
      renderAudit();
      setStatus('Operational governance saved.', true);
    };

    byId('entRotateSecrets').onclick = async () => {
      ensureStateDefaults();
      const allow = await guardAction('secrets.rotate', 'mark secrets rotated', { ownerOnly: true });
      if (!allow) return;
      const now = new Date();
      state.enterprise.secrets.lastRotatedAt = now.toISOString();
      const next = new Date(now.getTime() + (Math.max(1, Number(state.enterprise.secrets.rotationDays || 30)) * 86400000));
      state.enterprise.secrets.nextRotationAt = next.toISOString();
      appendImmutableAudit('secrets.rotate', `rotation marked; next=${state.enterprise.secrets.nextRotationAt}`, 'warn');
      await savePanelState();
      renderAudit();
      setStatus('Secrets rotation timestamp updated.', true);
    };

    byId('entExportImmutable').onclick = async () => {
      ensureStateDefaults();
      const blob = new Blob([JSON.stringify(state.enterprise.immutableAudit || [], null, 2)], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'frenzynet-immutable-audit.json'; a.click();
      setStatus('Immutable audit chain exported.', true);
    };
  }

  renderNav();
  wireEvents();
})();
</script>
</body>
</html>
